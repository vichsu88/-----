{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å€‹äººå°ˆå€{% endblock %}

{% block content %}
<style>
    .profile-page-wrapper {
        padding: 40px 20px;
        max-width: 800px;
        margin: 0 auto;
        font-family: 'Noto Sans TC', sans-serif;
    }
    .profile-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    /* å…±ç”¨å¡ç‰‡æ¨£å¼ï¼š#fffcf5 é…é‡‘é‚Š */
    .profile-card {
        background: #fffcf5;
        border: 2px solid #E6BA67;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .profile-card h3 {
        color: #C48945;
        margin-top: 0;
        border-bottom: 1px dashed #E6BA67;
        padding-bottom: 10px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /* ç‹€æ…‹æ¨™ç±¤ */
    .gift-status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
    }
    .gift-status.received { background: #d4edda; color: #155724; }
    .gift-status.not-received { background: #ffeeba; color: #856404; }
    .gift-note { font-size: 13px; color: #dc3545; margin-top: 5px; display: none; }

    /* è¡¨å–®æ¨£å¼ */
    .profile-form .form-group { margin-bottom: 15px; }
    .profile-form label { display: block; margin-bottom: 5px; color: #555; font-weight: bold; font-size: 15px; }
    .profile-form input, .profile-form select {
        width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 15px;
    }
    .btn-save {
        background: #C48945; color: white; border: none; padding: 10px 25px; border-radius: 25px;
        font-size: 16px; font-weight: bold; cursor: pointer; float: right; transition: 0.2s;
    }
    .btn-save:hover { opacity: 0.8; }
    
    /* æ­·å²ç´€éŒ„å¡ç‰‡ (å…±ç”¨) */
    .history-item {
        background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px;
    }
    .history-item-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #888; }
    .history-item-content { color: #333; font-size: 15px; line-height: 1.6; margin-bottom: 10px; }
    .history-item-status { padding: 10px; border-radius: 6px; font-size: 14px; line-height: 1.5; font-weight: 500;}
    
    .status-pending { background: #fff8e1; color: #856404; border-left: 4px solid #ffc107; }
    .status-approved { background: #e2e3e5; color: #383d41; border-left: 4px solid #6c757d; }
    .status-sent { background: #cce5ff; color: #004085; border-left: 4px solid #007bff; }

    /* æ”¶é©šé ç´„å°ˆå±¬æ¨£å¼ */
    .cloth-pill {
        display: inline-block; background: #fdf6e9; border: 1px solid #E6BA67; color: #C48945;
        padding: 4px 10px; border-radius: 15px; font-size: 13px; margin: 0 5px 5px 0; font-weight: bold;
    }
</style>

<main class="profile-page-wrapper">
    <div class="profile-header">
        <h2 class="section-title" style="margin-bottom: 5px;">å€‹äººå°ˆå€</h2>
        <p style="color: #666; margin-top: 0;" id="user-greeting">è®€å–ä¸­...</p>
    </div>

    <div id="login-section" style="text-align: center; padding: 40px; background: #fffcf5; border: 2px solid #E6BA67; border-radius: 15px; display: none;">
        <h3 style="color: #C48945;">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹å€‹äººè³‡æ–™</h3>
        <p style="color: #666; margin-bottom: 20px;">ç¶å®š LINE å¸³è™Ÿï¼Œè¼•é¬†ç®¡ç†æ‚¨çš„è³‡æ–™èˆ‡æ­·å²ç´€éŒ„ã€‚</p>
        <a href="/api/line/login?next=/profile" style="background-color: #06C755; color: white; padding: 10px 25px; border-radius: 50px; text-decoration: none; font-weight: bold; display: inline-block;">ä½¿ç”¨ LINE ç™»å…¥</a>
    </div>

    <div id="profile-content" style="display: none;">
        
        <div class="profile-card">
            <h3>
                <span>ğŸ“ æˆ‘çš„åŸºæœ¬è³‡æ–™</span>
                <div>
                    <span id="gift-status-badge" class="gift-status not-received">ğŸ å°ç¥è¡£ï¼šæœªé ˜å–</span>
                </div>
            </h3>
            <p id="gift-note" class="gift-note">â€» æ‚¨å·²é ˜å–éå°ç¥è¡£çµç·£å“ã€‚æœªä¾†çš„å›é¥‹æ–‡ç« æˆ‘å€‘å°‡ä»¥ã€Œæ³•å¸ƒæ–½ã€å½¢å¼èˆ‡å¤§çœ¾åˆ†äº«ï¼Œä¸å†é‡è¤‡å¯„é€ï¼Œæ„Ÿæ©æ‚¨çš„ç™¼å¿ƒï¼</p>
            
            <form id="profile-form" class="profile-form">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>çœŸå¯¦å§“å</label>
                        <input type="text" name="realName" required>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>æš±ç¨± (å…¬é–‹é¡¯ç¤º)</label>
                        <input type="text" name="nickname" required>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>è¯çµ¡é›»è©±</label>
                        <input type="tel" name="phone" required placeholder="09XX-XXX-XXX">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>é›»å­ä¿¡ç®±</label>
                        <input type="email" name="email" required>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>è¾²æ›†ç”Ÿæ—¥ (æ•¸å­—)</label>
                        <input type="text" name="lunarBirthday" placeholder="ä¾‹å¦‚ï¼š750815">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>å‡ºç”Ÿæ™‚è¾°</label>
                        <select name="birthTime">
                            <option value="å‰æ™‚">å‰æ™‚</option>
                            <option value="å­æ™‚ (23:00-01:00)">å­æ™‚ (23:00-01:00)</option>
                            <option value="ä¸‘æ™‚ (01:00-03:00)">ä¸‘æ™‚ (01:00-03:00)</option>
                            <option value="å¯…æ™‚ (03:00-05:00)">å¯…æ™‚ (03:00-05:00)</option>
                            <option value="å¯æ™‚ (05:00-07:00)">å¯æ™‚ (05:00-07:00)</option>
                            <option value="è¾°æ™‚ (07:00-09:00)">è¾°æ™‚ (07:00-09:00)</option>
                            <option value="å·³æ™‚ (09:00-11:00)">å·³æ™‚ (09:00-11:00)</option>
                            <option value="åˆæ™‚ (11:00-13:00)">åˆæ™‚ (11:00-13:00)</option>
                            <option value="æœªæ™‚ (13:00-15:00)">æœªæ™‚ (13:00-15:00)</option>
                            <option value="ç”³æ™‚ (15:00-17:00)">ç”³æ™‚ (15:00-17:00)</option>
                            <option value="é…‰æ™‚ (17:00-19:00)">é…‰æ™‚ (17:00-19:00)</option>
                            <option value="æˆŒæ™‚ (19:00-21:00)">æˆŒæ™‚ (19:00-21:00)</option>
                            <option value="äº¥æ™‚ (21:00-23:00)">äº¥æ™‚ (21:00-23:00)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>å¯„ä»¶åœ°å€</label>
                    <input type="text" name="address" required>
                </div>

                <div style="overflow: hidden; margin-top: 10px;">
                    <button type="submit" class="btn-save" id="save-btn">å„²å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>

        <div class="profile-card">
            <h3 style="margin-bottom: 20px;">ğŸ“– æˆ‘çš„å›é¥‹ç´€éŒ„</h3>
            <div id="history-list">
                <p style="text-align: center; color: #888;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div class="profile-card">
            <h3 style="margin-bottom: 20px;">ğŸ‘• å–å›æ”¶é©šè¡£æœé ç´„</h3>
            <div id="pickup-list">
                <p style="text-align: center; color: #888;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
        <div class="profile-card">
            <h3 style="margin-bottom: 20px;">ğŸ›ï¸ æˆ‘çš„è³¼è²·ç´€éŒ„</h3>
            <div id="order-list">
                <p style="text-align: center; color: #888;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const getCsrfToken = () => document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    const loginSection = document.getElementById('login-section');
    const profileContent = document.getElementById('profile-content');
    const profileForm = document.getElementById('profile-form');
    const historyList = document.getElementById('history-list');
    const pickupList = document.getElementById('pickup-list');
    
    // 1. è¼‰å…¥æœƒå“¡è³‡æ–™
    fetch('/api/user/me')
        .then(res => res.json())
        .then(data => {
            if (data.logged_in) {
                loginSection.style.display = 'none';
                profileContent.style.display = 'block';
                
                const u = data.user;
                document.getElementById('user-greeting').textContent = `æ­¡è¿å›ä¾†ï¼Œ${u.displayName || u.realName}ï¼`;
                
                // å¡«å…¥è¡¨å–®
                if(u.realName) profileForm.realName.value = u.realName;
                if(u.nickname) profileForm.nickname.value = u.nickname;
                else profileForm.nickname.value = u.displayName || '';
                
                if(u.phone) profileForm.phone.value = u.phone;
                if(u.email) profileForm.email.value = u.email;
                if(u.address) profileForm.address.value = u.address;
                if(u.lunarBirthday) profileForm.lunarBirthday.value = u.lunarBirthday;
                if(u.birthTime) profileForm.birthTime.value = u.birthTime;

                // è™•ç†å°ç¥è¡£ç‹€æ…‹
                const badge = document.getElementById('gift-status-badge');
                if(u.has_received_gift) {
                    badge.textContent = 'ğŸ å°ç¥è¡£ï¼šå·²é ˜å–';
                    badge.className = 'gift-status received';
                    document.getElementById('gift-note').style.display = 'block';
                }

                // ä¸¦è¡Œè¼‰å…¥å…©é‚Šçš„ç´€éŒ„
                loadFeedbackHistory();
                loadPickupHistory();
                loadOrderHistory();
            } else {
                document.getElementById('user-greeting').style.display = 'none';
                loginSection.style.display = 'block';
            }
        });

    // 2. å„²å­˜ä¿®æ”¹åŸºæœ¬è³‡æ–™
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-btn');
        btn.textContent = 'å„²å­˜ä¸­...';
        btn.disabled = true;

        const payload = {
            realName: profileForm.realName.value.trim(),
            nickname: profileForm.nickname.value.trim(),
            phone: profileForm.phone.value.trim(),
            email: profileForm.email.value.trim(),
            address: profileForm.address.value.trim(),
            lunarBirthday: profileForm.lunarBirthday.value.trim(),
            birthTime: profileForm.birthTime.value
        };

        try {
            const res = await fetch('/api/user/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                alert('è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼');
            } else {
                alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        } catch(err) {
            console.error(err);
        } finally {
            btn.textContent = 'å„²å­˜ä¿®æ”¹';
            btn.disabled = false;
        }
    });

    // 3. è¼‰å…¥å›é¥‹ç´€éŒ„æ¸…å–® (åŸæœ‰)
    async function loadFeedbackHistory() {
        try {
            const res = await fetch('/api/user/feedbacks');
            const data = await res.json();
            
            if(data.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px 0;">æ‚¨ç›®å‰é‚„æ²’æœ‰æ’°å¯«éå›é¥‹æ•…äº‹ï¼Œ<br><a href="/feedback" style="color: #C48945; font-weight: bold; text-decoration: none;">é»æ­¤å‰å¾€åˆ†äº«</a></p>';
                return;
            }

            historyList.innerHTML = data.map(item => {
                let statusHtml = '';
                if(item.status === 'pending') {
                    statusHtml = `<div class="history-item-status status-pending">ğŸŸ¡ <b>å¯©æ ¸ä¸­ï¼š</b>æ„Ÿè¬æ‚¨çš„åˆ†äº«ï¼Œå»Ÿæ–¹æ­£åœ¨ç”¨å¿ƒé–±è®€ä¸­ã€‚</div>`;
                } else if (item.status === 'approved') {
                    statusHtml = `<div class="history-item-status status-approved">ğŸŸ¢ <b>å·²åˆŠç™»ï¼š</b>æ–‡ç« å·²åˆŠç™»ï¼å…ƒå¸¥å¨˜æ­£åœ¨ç‚ºæ‚¨çš„å°ç¥è¡£é–‹ç¬¦åŠ æŒä¸­ï¼Œé–‹ç¬¦å®Œæˆå¾Œå¯„å‡ºè«‹è€å¿ƒç­‰å€™ã€‚</div>`;
                } else if (item.status === 'sent') {
                    statusHtml = `<div class="history-item-status status-sent">ğŸ”µ <b>å·²å¯„å‡ºï¼š</b>çµç·£å“å·²å¯„å‡ºï¼æ„Ÿè¬æ‚¨çš„æ³•å¸ƒæ–½ã€‚<br><span style="color:#333; margin-top:5px; display:inline-block;">ğŸ“¦ ç‰©æµå–®è™Ÿï¼š<b>${item.trackingNumber || 'ç„¡'}</b></span></div>`;
                }
                const cat = Array.isArray(item.category) ? item.category.join(', ') : item.category;
                return `
                <div class="history-item">
                    <div class="history-item-header">
                        <span>ğŸ·ï¸ åˆ†é¡ï¼š${cat}</span>
                        <span>ğŸ“… ${item.createdAt}</span>
                    </div>
                    <div class="history-item-content">"${item.content_preview}"</div>
                    ${statusHtml}
                </div>`;
            }).join('');
        } catch(err) {
            historyList.innerHTML = '<p style="color: red; text-align: center;">ç´€éŒ„è¼‰å…¥å¤±æ•—</p>';
        }
    }

    // 4. è¼‰å…¥æ”¶é©šé ç´„æ¸…å–® (å…¨æ–°)
    async function loadPickupHistory() {
        try {
            const res = await fetch('/api/user/pickups');
            const data = await res.json();
            
            if(data.length === 0) {
                pickupList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px 0;">æ‚¨ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„ã€‚<br><a href="/shipclothes" style="color: #C48945; font-weight: bold; text-decoration: none;">é»æ­¤å‰å¾€é ç´„</a></p>';
                return;
            }

            pickupList.innerHTML = data.map(item => {
                const typeText = item.pickupType === 'self' ? 'ğŸƒ ç¾å ´è‡ªå–' : 'ğŸšš é»‘è²“å¯„ä»¶';
                const typeColor = item.pickupType === 'self' ? '#28a745' : '#007bff';
                
                // é»‘è²“çš„é¡å¤–ç´…å­—æé†’
                const deliveryNote = item.pickupType === 'delivery' 
                    ? `<div style="color: #dc3545; font-size: 13px; margin-top: 5px;">â€» è«‹è¨˜å¾—è‡ªè¡Œè¯ç¹«é»‘è²“å®…æ€¥ä¾¿æ–¼æ­¤æ—¥æœŸå¾Œå‰ä¾†æœ¬åºœæ”¶ä»¶ã€‚</div>` 
                    : '';

                // æ¸²æŸ“è¡£æœæ¸…å–® (é¡¯ç¤ºå®Œæ•´å§“å)
                const clothesHtml = item.clothes.map(c => 
                    `<span class="cloth-pill">${c.clothId} ${c.name} (${c.birthYear})</span>`
                ).join('');

                return `
                <div class="history-item" style="border-left: 4px solid ${typeColor};">
                    <div class="history-item-header" style="margin-bottom: 5px;">
                        <span style="font-weight: bold; color: ${typeColor}; font-size: 15px;">${typeText}</span>
                        <span>å¡«å–®æ™‚é–“ï¼š${item.createdAt}</span>
                    </div>
                    <div style="font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px;">
                        é ç´„æ—¥æœŸï¼š${item.pickupDate}
                    </div>
                    <div style="margin-bottom: 5px;">${clothesHtml}</div>
                    ${deliveryNote}
                </div>`;
            }).join('');

        } catch(err) {
            pickupList.innerHTML = '<p style="color: red; text-align: center;">é ç´„ç´€éŒ„è¼‰å…¥å¤±æ•—</p>';
        }
    }
    // 5. è¼‰å…¥å•†åŸè¨‚å–®ç´€éŒ„ (å…¨æ–°)
    async function loadOrderHistory() {
        try {
            const res = await fetch('/api/user/orders');
            const data = await res.json();
            
            if(data.length === 0) {
                document.getElementById('order-list').innerHTML = '<p style="text-align: center; color: #888; padding: 20px 0;">æ‚¨ç›®å‰æ²’æœ‰è«‹è³¼ç´€éŒ„ã€‚<br><a href="/shop" style="color: #C48945; font-weight: bold; text-decoration: none;">é»æ­¤å‰å¾€è³£å ´</a></p>';
                return;
            }

            const now = new Date();

            document.getElementById('order-list').innerHTML = data.map(order => {
                let statusHtml = '';
                let borderColor = '#ccc';

                if (order.status === 'pending') {
                    const deadline = new Date(order.deadline_iso);
                    if (now > deadline) {
                        borderColor = '#dc3545'; // ç´…è‰²é€¾æœŸ
                        statusHtml = `<div class="history-item-status" style="background:#f8d7da; color:#721c24; border-left:4px solid #dc3545;">ğŸ”´ <b>å·²é€¾æœŸ/å–æ¶ˆï¼š</b>è¶…éç¹³è²»æœŸé™ï¼Œè¨‚å–®å·²å¤±æ•ˆã€‚</div>`;
                    } else {
                        borderColor = '#ffc107'; // é»ƒè‰²å¾…ç¹³è²»
                        statusHtml = `<div class="history-item-status status-pending">ğŸŸ¡ <b>å¾…æ ¸æ¬¾ï¼š</b><br>è«‹æ–¼ <span style="color:#d32f2f; font-weight:bold; font-size:16px;">${order.paymentDeadline}</span> å‰å®ŒæˆåŒ¯æ¬¾ï¼Œé€¾æœŸå°‡è‡ªå‹•å–æ¶ˆã€‚</div>`;
                    }
                } else if (order.status === 'paid') {
                    borderColor = '#28a745'; // ç¶ è‰²å·²ä»˜æ¬¾
                    statusHtml = `<div class="history-item-status status-approved">ğŸŸ¢ <b>è™•ç†ä¸­ï¼š</b>å»Ÿæ–¹å·²ç¢ºèªæ”¶æ¬¾ï¼Œæ­£åœ¨ç‚ºæ‚¨æº–å‚™å•†å“ã€‚</div>`;
                } else if (order.status === 'shipped') {
                    borderColor = '#007bff'; // è—è‰²å·²å‡ºè²¨
                    statusHtml = `<div class="history-item-status status-sent">ğŸ”µ <b>å·²å‡ºè²¨ï¼š</b>å•†å“å·²å¯„å‡ºï¼<br><span style="color:#333; margin-top:5px; display:inline-block;">ğŸ“¦ ç‰©æµå–®è™Ÿï¼š<b>${order.trackingNumber || 'ç„¡'}</b></span></div>`;
                }

                const itemsHtml = order.items.map(i => `<li style="margin-bottom:3px;">${i.name} (${i.variant}) x ${i.qty}</li>`).join('');

                return `
                <div class="history-item" style="border-left: 4px solid ${borderColor};">
                    <div class="history-item-header">
                        <span style="font-weight:bold; color:#333;">å–®è™Ÿï¼š${order.orderId}</span>
                        <span>ä¸‹å–®ï¼š${order.createdAt}</span>
                    </div>
                    <div class="history-item-content">
                        <ul style="margin:0; padding-left:20px; font-size:14px; color:#555;">${itemsHtml}</ul>
                        <div style="margin-top:10px; font-weight:bold; color:#C48945; font-size:16px;">ç¸½é‡‘é¡ï¼šNT$ ${order.total}</div>
                    </div>
                    ${statusHtml}
                </div>`;
            }).join('');

        } catch(err) {
            document.getElementById('order-list').innerHTML = '<p style="color: red; text-align: center;">è¨‚å–®è¼‰å…¥å¤±æ•—</p>';
        }
    }
    // æ¬„ä½æ ¼å¼åŒ–é‚è¼¯
    profileForm.phone.addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, ''); 
        if (v.length > 10) v = v.slice(0, 10);
        if (v.length > 7) v = v.replace(/(\d{4})(\d{3})(\d{0,3})/, '$1-$2-$3');
        else if (v.length > 4) v = v.replace(/(\d{4})(\d{0,3})/, '$1-$2');
        e.target.value = v;
    });
    profileForm.lunarBirthday.addEventListener('blur', (e) => {
        let v = e.target.value.replace(/\D/g, '');
        if(v.length === 6) e.target.value = v.replace(/(\d{2})(\d{2})(\d{2})/, '$1/$2/$3');
        else if (v.length === 7) e.target.value = v.replace(/(\d{3})(\d{2})(\d{2})/, '$1/$2/$3');
        else if (v.length === 8) e.target.value = v.replace(/(\d{4})(\d{2})(\d{2})/, '$1/$2/$3');
    });
});
</script>
{% endblock %}
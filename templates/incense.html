{% extends "base.html" %}

{% block title %}承天中承府 - 手工香品與文創{% endblock %}

{% block content %}
<style>
    /* === 頁面專用樣式 === */
    .store-page-wrapper {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding-bottom: 60px;
    }

    /* --- 1. 全螢幕輪播區塊 (Smart Carousel) --- */
    .smart-carousel {
        position: relative;
        width: 100%;
        /* 電腦版高度 600px，手機版高度 400px，可依需求調整 */
        height: 600px; 
        overflow: hidden;
        background-color: #f0ebe5; /* 圖片載入前的底色 */
    }

    .carousel-track {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .carousel-slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 1s ease-in-out;
        z-index: 1;
    }

    .carousel-slide.active {
        opacity: 1;
        z-index: 2;
    }

    .carousel-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* 關鍵：確保填滿且不變形 */
        object-position: center center; /* 關鍵：重點維持在中間 */
    }

    /* 輪播指示點 (Dots) */
    .carousel-dots {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        display: flex;
        gap: 10px;
    }

    .dot {
        width: 12px;
        height: 12px;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .dot.active {
        background-color: #C48945; /* 主色調 */
        transform: scale(1.2);
    }

    /* --- 分區通用標題 --- */
    .category-section {
        max-width: 1200px;
        margin: 60px auto 0 auto;
        padding: 0 20px;
        text-align: center;
    }

    .category-title {
        font-family: 'KouzanBrushFontOTF', sans-serif; /* 沿用書法字體 */
        font-size: clamp(28px, 4vw, 36px);
        color: #C48945;
        margin-bottom: 30px;
        display: inline-block;
        border-bottom: 2px solid #E6BA67;
        padding-bottom: 10px;
    }

    /* --- 2. 手工香分類區 (Grid Layout) --- */
    .incense-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 電腦版三欄 */
        gap: 30px;
    }

    .incense-card {
        background: #fff;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        transition: transform 0.3s;
        border: 1px solid #eee;
    }

    .incense-card:hover {
        transform: translateY(-5px);
    }

    .incense-img-box {
        width: 100%;
        aspect-ratio: 1 / 1; /* 正方形圖片，您可以改 4/3 或 16/9 */
        background-color: #ddd;
    }

    .incense-img-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .incense-name {
        padding: 15px;
        font-size: 1.2rem;
        color: #333;
        font-weight: bold;
    }

    /* --- 3. 元帥娘專區 & 4. 下單說明 (單欄大圖) --- */
    .full-width-banner-box {
        width: 100%;
        border-radius: 15px;
        overflow: hidden;
        margin-top: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .full-width-banner-box img {
        width: 100%;
        height: auto;
        display: block;
    }

    /* === 手機版響應式調整 === */
    @media (max-width: 768px) {
        .smart-carousel {
            height: 400px; /* 手機版輪播高度 */
        }

        .incense-grid {
            grid-template-columns: 1fr; /* 手機版改為單欄堆疊 */
            gap: 20px;
        }

        .category-section {
            margin-top: 40px;
        }
    }
</style>

<div class="store-page-wrapper">

    <div id="hero-carousel" class="smart-carousel">
        <div class="carousel-track" id="carousel-track">
            </div>
        <div class="carousel-dots" id="carousel-dots">
            </div>
    </div>

    <section class="category-section">
        <h2 class="category-title">手工香品</h2>
        <div class="incense-grid">
            <div class="incense-card">
                <div class="incense-img-box">
                    <img src="{{ url_for('static', filename='images/pages/incense/category_calm.jpg') }}" 
                         alt="淨化安神" loading="lazy" onerror="this.src='https://placehold.co/600x600?text=淨化安神圖片';">
                </div>
                <div class="incense-name">淨化安神</div>
            </div>

            <div class="incense-card">
                <div class="incense-img-box">
                    <img src="{{ url_for('static', filename='images/pages/incense/category_worship.jpg') }}" 
                         alt="敬神禮佛" loading="lazy" onerror="this.src='https://placehold.co/600x600?text=敬神禮佛圖片';">
                </div>
                <div class="incense-name">敬神禮佛</div>
            </div>

            <div class="incense-card">
                <div class="incense-img-box">
                    <img src="{{ url_for('static', filename='images/pages/incense/category_premium.jpg') }}" 
                         alt="頂級鑑賞" loading="lazy" onerror="this.src='https://placehold.co/600x600?text=頂級鑑賞圖片';">
                </div>
                <div class="incense-name">頂級鑑賞</div>
            </div>
        </div>
    </section>

    <section class="category-section">
        <h2 class="category-title">元帥娘專區</h2>
        <div class="full-width-banner-box">
            <img src="{{ url_for('static', filename='images/pages/incense/marshalless_zone.jpg') }}" 
                 alt="元帥娘專區介紹" loading="lazy" onerror="this.src='https://placehold.co/1200x600?text=元帥娘專區圖片';">
        </div>
    </section>

    <section class="category-section">
        <h2 class="category-title">下單說明</h2>
        <div class="full-width-banner-box">
            <img src="{{ url_for('static', filename='images/pages/incense/order_instruction.jpg') }}" 
                 alt="賣貨便下單說明" loading="lazy" onerror="this.src='https://placehold.co/1200x600?text=下單說明圖片';">
        </div>
        <div style="margin-top: 20px;">
            <a href="#" target="_blank" class="btn btn--brown">前往賣貨便賣場</a>
        </div>
    </section>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    /* === 智慧輪播邏輯 === */
    const track = document.getElementById('carousel-track');
    const dotsContainer = document.getElementById('carousel-dots');
    const maxImagesToCheck = 10; // 最大檢查張數，您可以設大一點
    const imagePathBase = "{{ url_for('static', filename='images/pages/incense/') }}"; // 基礎路徑
    
    let validImages = [];
    let checkCount = 0;

    // 1. 自動偵測圖片是否存在
    function preloadImages() {
        // 我們假設圖片命名為 store_banner1.png, store_banner2.png ... (或 jpg)
        // 為了簡單，這裡假設您上傳的都是 png (如果是 jpg 請自行修改下方副檔名)
        // 或者是您可以在後端統一格式。這裡用 JS 的 Image 物件來測試載入。
        
        // *提示：請確認您的圖片副檔名是 .png 還是 .jpg，下方需對應修改*
        const fileExtension = '.png'; 

        for (let i = 1; i <= maxImagesToCheck; i++) {
            const img = new Image();
            const imgName = `store_banner${i}${fileExtension}`;
            const fullPath = imagePathBase + imgName;

            img.onload = function() {
                // 載入成功，加入有效清單
                validImages.push({ index: i, src: fullPath });
                checkFinished();
            };

            img.onerror = function() {
                // 載入失敗 (檔案不存在)，忽略
                checkFinished();
            };

            img.src = fullPath;
        }
    }

    function checkFinished() {
        checkCount++;
        // 當所有可能的圖片都檢查完畢後，開始建立輪播
        if (checkCount === maxImagesToCheck) {
            // 依照檔名序號排序 (1, 2, 3...)
            validImages.sort((a, b) => a.index - b.index);
            
            if (validImages.length > 0) {
                initCarousel(validImages);
            } else {
                // 一張圖都沒有時的備案
                track.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#888;">尚無圖片</div>';
            }
        }
    }

    // 2. 初始化輪播 DOM
    function initCarousel(images) {
        images.forEach((imgData, idx) => {
            // 建立圖片 Slide
            const slide = document.createElement('div');
            slide.className = `carousel-slide ${idx === 0 ? 'active' : ''}`;
            slide.innerHTML = `<img src="${imgData.src}" alt="Store Banner ${imgData.index}">`;
            track.appendChild(slide);

            // 建立 Dot
            const dot = document.createElement('div');
            dot.className = `dot ${idx === 0 ? 'active' : ''}`;
            dot.addEventListener('click', () => goToSlide(idx));
            dotsContainer.appendChild(dot);
        });

        // 啟動自動播放
        startAutoPlay();
    }

    // 3. 輪播控制
    let currentSlide = 0;
    let autoPlayInterval;

    function goToSlide(n) {
        const slides = document.querySelectorAll('.carousel-slide');
        const dots = document.querySelectorAll('.dot');
        
        if (!slides.length) return;

        // 移除舊的 active
        slides[currentSlide].classList.remove('active');
        dots[currentSlide].classList.remove('active');

        // 計算新的 index
        currentSlide = (n + slides.length) % slides.length;

        // 加入新的 active
        slides[currentSlide].classList.add('active');
        dots[currentSlide].classList.add('active');
    }

    function nextSlide() {
        goToSlide(currentSlide + 1);
    }

    function startAutoPlay() {
        if (validImages.length > 1) { // 只有一張圖時不輪播
            autoPlayInterval = setInterval(nextSlide, 5000); // 5秒換一張
        }
    }

    // 執行偵測
    preloadImages();
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å¯„å›è¡£ç‰©ç™»è¨˜{% endblock %}

{% block content %}
<style>
    .ship-wrapper {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
        position: relative;
    }
    
    /* === ç•™è¨€æ¿å€å¡Š (Board - ç½®é ‚) === */
    .board-section { margin-bottom: 40px; }
    .board-title {
        text-align: center;
        font-size: 24px;
        color: #C48945;
        margin-bottom: 20px;
        font-weight: bold;
    }
    .board-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .board-card {
        background: #fff;
        border-left: 5px solid #C48945;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .board-date-badge {
        background: #333;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        margin-right: 10px;
    }
    .board-info { flex: 1; min-width: 200px; }
    .board-clothes { 
        margin-top: 10px; 
        background: #f9f9f9; 
        padding: 10px; 
        border-radius: 5px;
        font-size: 14px;
        color: #555;
    }

    /* === ä¸‹æ–¹æ•™å­¸å€å¡Š === */
    .instruction-box {
        background: #fff;
        border: 2px solid #E6BA67;
        border-radius: 15px;
        padding: 25px;
        margin-top: 40px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .instruction-title {
        color: #C48945;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
    }
    .black-cat-btn {
        background: #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        margin-top: 15px;
    }
    .black-cat-btn:hover { background: #555; transform: translateY(-2px); }

    /* === æ‡¸æµ®æŒ‰éˆ• (æˆ‘è¦ç™»è¨˜) === */
    .feedback-floating-btn {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 900;
        cursor: pointer;
        transition: transform 0.2s, opacity 0.3s;
        width: 210px;
    }
    .feedback-floating-btn img { width: 100%; height: auto; display: block; }
    .feedback-floating-btn:hover { transform: translateY(-50%) scale(1.05); }

    @media (max-width: 768px) {
        .feedback-floating-btn {
            width: 130px;
            top: auto;
            bottom: 30px;
            transform: none;
        }
        .feedback-floating-btn:hover { transform: scale(1.05); }
    }

    /* === Modal æ¨£å¼ (ç™»è¨˜è¡¨å–®) === */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;
        backdrop-filter: blur(3px);
    }
    .modal-overlay.is-visible { display: flex; }
    .modal-content {
        background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;
        position: relative; border: 3px solid #E6BA67;
        max-height: 90vh; overflow-y: auto;
    }
    .modal-close-btn {
        position: absolute; top: 15px; right: 15px; background: #C48945; color: #fff;
        border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;
    }
    
    /* è¡¨å–®å…ƒä»¶æ¨£å¼ */
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; }
    .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    
    /* è¡£æœè¼¸å…¥åˆ—æ¨£å¼ */
    .clothing-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }
    .clothing-row input {
        flex: 1; /* å…©å€‹è¼¸å…¥æ¡†å¹³åˆ†å¯¬åº¦ */
    }
    
    .remove-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 30px;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .add-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        margin-top: 5px;
    }

    /* é©—è­‰ç¢¼ */
    .captcha-row {
        display: flex; gap: 10px; align-items: center;
    }
    .captcha-q {
        background: #eee; padding: 10px; border-radius: 6px; font-weight: bold; min-width: 80px; text-align: center;
    }
    .btn--brown { background: #C48945; color: #fff; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 16px; cursor: pointer; }
</style>

<main class="ship-wrapper">
    <div id="open-ship-form-btn" class="feedback-floating-btn">
        <img src="{{ url_for('static', filename='images/pages/feedback/new.png') }}" alt="æˆ‘è¦ç™»è¨˜">
    </div>

    <div class="board-section">
        <h2 class="board-title">ğŸ“… è¿‘æœŸæ”¶ä»¶æ¸…å–® (è‡ªå‹•æ›´æ–°)</h2>
        <p style="text-align:center; color:#888; font-size:14px; margin-bottom:20px;">åƒ…é¡¯ç¤º æ˜¨æ—¥ ~ æœªä¾† 5 å¤© å…§çš„ç™»è¨˜è³‡æ–™</p>
        <div id="board-list" class="board-list"><p style="text-align:center;">è¼‰å…¥ä¸­...</p></div>
    </div>

    <div class="instruction-box">
        <div class="instruction-title">ğŸ“¦ é»‘è²“å¯„ä»¶æ•™å­¸</div>
        <p style="line-height:1.8;">
            1. è«‹å°‡è¡£ç‰©æ¸…æ´—ä¸¦åŒ…è£å®Œæ•´ã€‚<br>
            2. é»æ“Šå³å´ï¼ˆæˆ–ä¸‹æ–¹ï¼‰æŒ‰éˆ•ç™»è¨˜ï¼Œç³»çµ±å°‡è¨ˆç®—é è¨ˆæ”¶ä»¶æ—¥ã€‚<br>
            3. å‰å¾€é»‘è²“å®˜ç¶²é ç´„åˆ°åºœæ”¶ä»¶ï¼Œæˆ–è‡³è¶…å•†å¯„ä»¶ã€‚<br>
            <strong>æ”¶ä»¶è³‡è¨Šï¼š</strong>å˜‰ç¾©å¸‚æ–°ç”Ÿè·¯337è™Ÿ (å…«å…«è¸é…’) / 0912345678
        </p>
        <a href="https://www.t-cat.com.tw/" target="_blank" class="black-cat-btn">å‰å¾€é»‘è²“å®…æ€¥ä¾¿å®˜ç¶² â¤</a>
    </div>
</main>

<div id="ship-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h3 style="margin-top:0; color:#C48945; text-align:center;">ç™»è¨˜å¯„å›è¡£ç‰©</h3>
        <p style="color:#666; font-size:14px; text-align:center; margin-bottom:20px;">è«‹ä¾ç…§æ¬„ä½é †åºå¡«å¯«ï¼Œè¡£ç‰©å¯é»æ“Š + æ–°å¢å¤šç­†ã€‚</p>
        
        <form id="ship-form">
            <div class="form-group">
                <label>1. æ‰€å±¬ Line ç¾¤çµ„</label>
                <select id="lineGroup" class="form-control" required>
                    <option value="" disabled selected>è«‹é¸æ“‡ç¾¤çµ„</option>
                    <option value="ç¾¤çµ„ä¸€">ç¾¤çµ„ä¸€</option>
                    <option value="ç¾¤çµ„äºŒ">ç¾¤çµ„äºŒ</option>
                    <option value="ç¾¤çµ„ä¸‰">ç¾¤çµ„ä¸‰</option>
                    <option value="ç¾¤çµ„å››">ç¾¤çµ„å››</option>
                </select>
            </div>

            <div class="form-group">
                <label>2. Line åç¨± (ç¾¤çµ„å…§é¡¯ç¤ºçš„æš±ç¨±)</label>
                <input type="text" id="lineName" class="form-control" placeholder="ä¾‹å¦‚ï¼šå¿«æ¨‚å°æ˜" required>
            </div>

            <div class="form-group">
                <label>3. çœŸå¯¦å§“å (å¯„ä»¶äººå…¨åï¼Œå°‡éš±ç¢¼é¡¯ç¤º)</label>
                <input type="text" id="senderName" class="form-control" placeholder="è«‹å¡«å¯«å…¨å" required>
            </div>

            <div class="form-group">
                <label>4. è¡£æœæ˜ç´° (ç·¨è™Ÿ + åç¨±)</label>
                <div id="clothes-container">
                    <div class="clothing-row">
                        <input type="text" class="form-control clothing-id" placeholder="ç·¨è™Ÿ (å¦‚ A122413)" required>
                        <input type="text" class="form-control clothing-name" placeholder="å§“å" required>
                        <input type="text" class="form-control clothing-name" placeholder="å¹´æ¬¡" required>

                    </div>
                </div>
                <button type="button" class="add-btn" id="add-clothing-btn">ï¼‹ æ–°å¢ä¸‹ä¸€ä»¶</button>
            </div>

            <div class="form-group">
                <label>é©—è­‰ç¢¼ (é˜²æ©Ÿå™¨äºº)</label>
                <div class="captcha-row">
                    <div id="captcha-question" class="captcha-q">Loading...</div>
                    <input type="text" id="captcha-input" class="form-control" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" required style="flex:1;">
                </div>
            </div>

            <p id="preview-date" style="text-align:center; color:#C48945; font-weight:bold; margin-bottom:15px;"></p>
            <button type="submit" class="btn--brown">é€å‡ºç™»è¨˜</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('ship-modal');
    const openBtn = document.getElementById('open-ship-form-btn');
    const closeBtn = document.querySelector('.modal-close-btn');
    const form = document.getElementById('ship-form');
    const boardList = document.getElementById('board-list');
    const datePreview = document.getElementById('preview-date');
    const captchaQ = document.getElementById('captcha-question');
    const clothesContainer = document.getElementById('clothes-container');
    const addClothingBtn = document.getElementById('add-clothing-btn');

    // é–‹å•Ÿ Modal ä¸¦å–å¾—é©—è­‰ç¢¼
    openBtn.addEventListener('click', async () => {
        modal.classList.add('is-visible');
        openBtn.style.zIndex = -1; openBtn.style.opacity = 0;
        await fetchCaptcha();
        await fetchDatePreview();
    });

    // é—œé–‰ Modal
    function closeModal() {
        modal.classList.remove('is-visible');
        openBtn.style.zIndex = 900; openBtn.style.opacity = 1;
    }
    closeBtn.onclick = closeModal;
    modal.onclick = (e) => { if(e.target === modal) closeModal(); };

    // å‹•æ…‹æ–°å¢è¡£æœæ¬„ä½
    addClothingBtn.addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'clothing-row';
        div.innerHTML = `
            <input type="text" class="form-control clothing-id" placeholder="ç·¨è™Ÿ" required>
            <input type="text" class="form-control clothing-name" placeholder="åç¨±" required>
            <button type="button" class="remove-btn" title="åˆªé™¤">Ã—</button>
        `;
        clothesContainer.appendChild(div);
        
        // ç¶å®šåˆªé™¤äº‹ä»¶
        div.querySelector('.remove-btn').addEventListener('click', () => {
            div.remove();
        });
    });

    // å–å¾—é©—è­‰ç¢¼é¡Œç›®
    async function fetchCaptcha() {
        try {
            const res = await fetch('/api/captcha');
            const data = await res.json();
            captchaQ.textContent = data.question;
            document.getElementById('captcha-input').value = ''; // æ¸…ç©ºè¼¸å…¥
        } catch(e) { captchaQ.textContent = "Error"; }
    }

    // å–å¾—é è¨ˆæ—¥æœŸ
    async function fetchDatePreview() {
        try {
            const res = await fetch('/api/shipclothes/calc-date');
            const data = await res.json();
            datePreview.textContent = `é è¨ˆé»‘è²“æ”¶ä»¶æ—¥ï¼š${data.pickupDate}`;
        } catch(e) {}
    }

    // é€å‡ºè¡¨å–®
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // æ”¶é›†è¡£æœè³‡æ–™
        const idInputs = document.querySelectorAll('.clothing-id');
        const nameInputs = document.querySelectorAll('.clothing-name');
        const clothes = [];
        
        for(let i=0; i<idInputs.length; i++) {
            const id = idInputs[i].value.trim();
            const name = nameInputs[i].value.trim();
            if(id && name) {
                clothes.push({ id: id, name: name });
            }
        }

        if(clothes.length === 0) { alert('è«‹è‡³å°‘å¡«å¯«ä¸€ä»¶è¡£æœ'); return; }

        const payload = {
            lineGroup: document.getElementById('lineGroup').value,
            lineName: document.getElementById('lineName').value.trim(),
            name: document.getElementById('senderName').value.trim(),
            clothes: clothes, // ç‰©ä»¶é™£åˆ—
            captcha: document.getElementById('captcha-input').value.trim()
        };

        try {
            const res = await fetch('/api/shipclothes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            if(result.success) {
                alert(`ç™»è¨˜æˆåŠŸï¼\né è¨ˆæ”¶ä»¶æ—¥ï¼š${result.pickupDate}`);
                form.reset();
                // é‡ç½®è¡£æœæ¬„ä½å›é è¨­ç‹€æ…‹ (1è¡Œ)
                clothesContainer.innerHTML = `
                    <div class="clothing-row">
                        <input type="text" class="form-control clothing-id" placeholder="ç·¨è™Ÿ (ä¾‹å¦‚ A001)" required>
                        <input type="text" class="form-control clothing-name" placeholder="åç¨± (ä¾‹å¦‚ ç´…è‰²Tæ¤)" required>
                    </div>`;
                
                closeModal();
                fetchBoardData(); // åˆ·æ–°æ¸…å–®
            } else {
                alert(result.message);
                if(result.message.includes('é©—è­‰ç¢¼')) fetchCaptcha(); // é©—è­‰ç¢¼éŒ¯å°±åˆ·æ–°
            }
        } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
    });

    // è¼‰å…¥æ¸…å–®
    async function fetchBoardData() {
        try {
            const res = await fetch('/api/shipclothes/list');
            const data = await res.json();
            
            if(data.length === 0) {
                boardList.innerHTML = '<p style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰è¿‘æœŸçš„æ”¶ä»¶ç™»è¨˜ã€‚</p>';
                return;
            }

            boardList.innerHTML = data.map(item => {
                // è™•ç†è¡£æœé¡¯ç¤ºæ ¼å¼ï¼š A001 (ç´…è¡£), B002 (è—è¤²)
                const clothesDisplay = item.clothes.map(c => 
                    `<span style="border:1px solid #ddd; padding:2px 6px; border-radius:4px; margin-right:5px; background:#fff; display:inline-block; margin-bottom:4px;">
                        <b>${c.id}</b> <small style="color:#666;">(${c.name})</small>
                    </span>`
                ).join('');

                return `
                <div class="board-card">
                    <div class="board-info">
                        <div style="margin-bottom:8px;">
                            <span class="board-date-badge">é è¨ˆ ${item.pickupDate} æ”¶ä»¶</span>
                            <span style="font-weight:bold; font-size:18px;">${item.name}</span>
                            <span style="color:#C48945; font-size:14px; margin-left:5px;">(${item.lineName})</span>
                            <span style="color:#888; font-size:13px; margin-left:5px;">@${item.lineGroup}</span>
                        </div>
                        <div class="board-clothes">
                            <div style="margin-bottom:4px; font-size:12px; color:#888;">ç”³è«‹æ—¥æœŸ: ${item.submitDate}</div>
                            <div>${clothesDisplay}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { boardList.innerHTML = '<p>è¼‰å…¥å¤±æ•—</p>'; }
    }

    fetchBoardData();
});
</script>
{% endblock %}
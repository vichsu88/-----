{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å¯„å›è¡£ç‰©ç™»è¨˜{% endblock %}

{% block content %}
<style>
    .ship-wrapper {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
    }
    
    /* === ä¸Šæ–¹æ•™å­¸å€å¡Š === */
    .instruction-box {
        background: #fff;
        border: 2px solid #E6BA67;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .instruction-title {
        color: #C48945;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .black-cat-btn {
        background: #333;
        color: #fff;
        padding: 8px 15px;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
        margin-top: 10px;
    }
    .black-cat-btn:hover { background: #555; transform: translateY(-2px); }

    /* === è¡¨å–®å€å¡Š === */
    .form-container {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        padding: 30px;
        border-radius: 15px;
        border: 1px solid #ddd;
        margin-bottom: 50px;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; }
    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box; /* é‡è¦ */
    }
    
    /* å‹•æ…‹è¡£æœç·¨è™Ÿæ¬„ä½ */
    .clothing-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .add-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        font-size: 24px;
        line-height: 35px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 5px;
    }
    .remove-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0 15px;
        cursor: pointer;
    }

    /* === ç•™è¨€æ¿å€å¡Š (Board) === */
    .board-section { margin-top: 50px; }
    .board-title {
        text-align: center;
        font-size: 24px;
        color: #C48945;
        margin-bottom: 20px;
        font-weight: bold;
    }
    .board-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .board-card {
        background: #fff;
        border-left: 5px solid #C48945;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .board-date-badge {
        background: #333;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        margin-right: 10px;
    }
    .board-info { flex: 1; min-width: 200px; }
    .board-clothes { 
        margin-top: 10px; 
        background: #f9f9f9; 
        padding: 10px; 
        border-radius: 5px;
        font-size: 14px;
        color: #555;
    }
    
    /* é è¨ˆæ”¶ä»¶æ—¥å¼·èª¿ */
    .pickup-highlight {
        color: #d9534f;
        font-weight: bold;
    }
</style>

<main class="ship-wrapper">
    <h2 class="section-title">å¯„å›è¡£ç‰©ç™»è¨˜</h2>

    <div class="instruction-box">
        <div class="instruction-title">ğŸ“¦ é»‘è²“å¯„ä»¶æ•™å­¸</div>
        <p style="line-height:1.6;">
            è«‹ç¢ºèªæ‚¨çš„è¡£ç‰©å·²æ¸…æ´—ä¸¦åŒ…è£å®Œæ•´ã€‚<br>
            å¡«å¯«ä¸‹æ–¹è¡¨å–®å¾Œï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—æ”¶ä»¶æ—¥æœŸï¼ˆå·¥ä½œæ—¥ D+2ï¼‰ã€‚<br>
            <strong>é»‘è²“å®…æ€¥ä¾¿ç¶²ç«™</strong>ï¼šæä¾›åˆ°åºœæ”¶ä»¶æˆ–è¶…å•†å¯„ä»¶è³‡è¨Šã€‚
        </p>
        <a href="https://www.t-cat.com.tw/" target="_blank" class="black-cat-btn">å‰å¾€é»‘è²“å®…æ€¥ä¾¿å®˜ç¶² â¤</a>
    </div>

    <div class="form-container">
        <form id="ship-form">
            <div class="form-group">
                <label>çœŸå¯¦å§“å (å°‡ä»¥ O éš±ç¢¼é¡¯ç¤º)</label>
                <input type="text" id="senderName" class="form-control" placeholder="è«‹å¡«å¯«å…¨åï¼Œä¾‹å¦‚ï¼šè¨±ç§‰æ‰¿" required>
            </div>

            <div class="form-group">
                <label>æ‰€å±¬ Line ç¾¤çµ„</label>
                <select id="lineGroup" class="form-control" required>
                    <option value="" disabled selected>è«‹é¸æ“‡ç¾¤çµ„</option>
                    <option value="ç¾¤çµ„ä¸€">ç¾¤çµ„ä¸€</option>
                    <option value="ç¾¤çµ„äºŒ">ç¾¤çµ„äºŒ</option>
                    <option value="ç¾¤çµ„ä¸‰">ç¾¤çµ„ä¸‰</option>
                    <option value="ç¾¤çµ„å››">ç¾¤çµ„å››</option>
                </select>
            </div>

            <div class="form-group">
                <label>è¡£æœç·¨è™Ÿ (å¯å¤šä»¶)</label>
                <div id="clothes-container">
                    <div class="clothing-input-group">
                        <input type="text" class="form-control clothing-id" placeholder="è¼¸å…¥ç·¨è™Ÿ (ä¾‹å¦‚ A001)" required>
                    </div>
                </div>
                <button type="button" class="add-btn" id="add-clothing-btn">+</button>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <p id="calc-date-preview" style="color:#C48945; font-weight:bold; margin-bottom:15px; display:none;">
                    é è¨ˆé»‘è²“æ”¶ä»¶æ—¥ï¼š<span id="preview-date-text"></span>
                </p>
                <button type="submit" class="btn btn--brown" style="width:100%; max-width:300px;">é€å‡ºç™»è¨˜</button>
            </div>
        </form>
    </div>

    <div class="board-section">
        <div class="board-title">ğŸ“… è¿‘æœŸæ”¶ä»¶æ¸…å–® (è‡ªå‹•æ›´æ–°)</div>
        <p style="text-align:center; color:#888; font-size:14px; margin-bottom:20px;">åƒ…é¡¯ç¤º æ˜¨æ—¥ ~ æœªä¾† 5 å¤© å…§çš„ç™»è¨˜è³‡æ–™</p>
        
        <div id="board-list" class="board-list">
            <p style="text-align:center;">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const clothesContainer = document.getElementById('clothes-container');
    const addBtn = document.getElementById('add-clothing-btn');
    const shipForm = document.getElementById('ship-form');
    const boardList = document.getElementById('board-list');
    const previewText = document.getElementById('preview-date-text');
    const previewBox = document.getElementById('calc-date-preview');

    // 1. å‹•æ…‹æ–°å¢è¡£æœæ¬„ä½
    addBtn.addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'clothing-input-group';
        div.innerHTML = `
            <input type="text" class="form-control clothing-id" placeholder="è¼¸å…¥ç·¨è™Ÿ" required>
            <button type="button" class="remove-btn">åˆªé™¤</button>
        `;
        clothesContainer.appendChild(div);
        
        // ç¶å®šåˆªé™¤äº‹ä»¶
        div.querySelector('.remove-btn').addEventListener('click', () => {
            div.remove();
        });
    });

    // 2. é è¦½ D+2 æ—¥æœŸ (å‘¼å«å¾Œç«¯ API è¨ˆç®—)
    async function updatePreviewDate() {
        try {
            const res = await fetch('/api/shipclothes/calc-date');
            const data = await res.json();
            if(data.pickupDate) {
                previewText.textContent = data.pickupDate;
                previewBox.style.display = 'block';
            }
        } catch(e) { console.error(e); }
    }
    updatePreviewDate(); // é€²ä¾†å°±å…ˆç®—ä¸€æ¬¡

    // 3. é€å‡ºè¡¨å–®
    shipForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // æ”¶é›†æ‰€æœ‰è¡£æœç·¨è™Ÿ
        const inputs = document.querySelectorAll('.clothing-id');
        const clothes = Array.from(inputs).map(input => input.value.trim()).filter(v => v);
        
        if(clothes.length === 0) { alert('è«‹è‡³å°‘å¡«å¯«ä¸€ä»¶è¡£æœç·¨è™Ÿ'); return; }

        const payload = {
            name: document.getElementById('senderName').value.trim(),
            lineGroup: document.getElementById('lineGroup').value,
            clothes: clothes
        };

        try {
            const res = await fetch('/api/shipclothes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            if(result.success) {
                alert(`ç™»è¨˜æˆåŠŸï¼\næ‚¨çš„é è¨ˆæ”¶ä»¶æ—¥ç‚ºï¼š${result.pickupDate}`);
                shipForm.reset();
                // é‡ç½®è¡£æœæ¬„ä½åªå‰©ä¸€æ ¼
                clothesContainer.innerHTML = '<div class="clothing-input-group"><input type="text" class="form-control clothing-id" placeholder="è¼¸å…¥ç·¨è™Ÿ (ä¾‹å¦‚ A001)" required></div>';
                fetchBoardData(); // é‡æ–°æ•´ç†ç•™è¨€æ¿
            } else {
                alert('ç™»è¨˜å¤±æ•—ï¼š' + result.message);
            }
        } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
    });

    // 4. è¼‰å…¥ç•™è¨€æ¿è³‡æ–™
    async function fetchBoardData() {
        try {
            const res = await fetch('/api/shipclothes/list');
            const data = await res.json();
            
            if(data.length === 0) {
                boardList.innerHTML = '<p style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰è¿‘æœŸçš„æ”¶ä»¶ç™»è¨˜ã€‚</p>';
                return;
            }

            boardList.innerHTML = data.map(item => {
                const clothesHtml = item.clothes.map(c => `<span style="border:1px solid #ddd; padding:2px 6px; border-radius:4px; margin-right:5px; background:#fff;">${c}</span>`).join('');
                
                return `
                <div class="board-card">
                    <div class="board-info">
                        <div style="margin-bottom:5px;">
                            <span class="board-date-badge">é è¨ˆ ${item.pickupDate} æ”¶ä»¶</span>
                            <span style="font-weight:bold; font-size:18px;">${item.name}</span>
                            <span style="color:#888; font-size:14px; margin-left:10px;">(${item.lineGroup})</span>
                        </div>
                        <div class="board-clothes">
                            ç”³è«‹æ—¥æœŸ: ${item.submitDate} <br>
                            è¡£æœç·¨è™Ÿ: ${clothesHtml}
                        </div>
                    </div>
                </div>`;
            }).join('');
        } catch(e) {
            console.error(e);
            boardList.innerHTML = '<p style="text-align:center;">è³‡æ–™è¼‰å…¥å¤±æ•—</p>';
        }
    }

    fetchBoardData();
});
</script>
{% endblock %}
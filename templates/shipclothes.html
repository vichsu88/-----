{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - æ”¶é©šè¡£æœé ç´„èˆ‡é€²åº¦{% endblock %}

{% block content %}
<style>
    .ship-wrapper {
        padding: 40px 20px;
        max-width: 1000px; /* å¯¬åº¦è¶³ä»¥å®¹ç´æµç¨‹åœ– */
        margin: 0 auto;
        position: relative;
        font-family: 'Noto Sans TC', sans-serif;
    }
    .page-header { text-align: center; margin-bottom: 30px; }

    /* === æµç¨‹åœ–å€å¡Š (Process Flow åŸæ±åŸå‘³ä¿ç•™) === */
    .process-section { margin-bottom: 40px; text-align: center; }
    .process-title {
        font-size: 2rem; color: #C48945; font-weight: bold; margin-bottom: 30px;
        font-family: 'LXGW WenKai TC', serif;
    }
    .process-container { display: flex; justify-content: space-between; gap: 20px; position: relative; }
    .step-card {
        flex: 1; background: #fff; border: 2px solid #E6BA67; border-radius: 15px;
        padding: 20px 15px; position: relative; box-shadow: 0 5px 15px rgba(196, 137, 69, 0.1);
        display: flex; flex-direction: column; align-items: center; transition: transform 0.3s;
    }
    .step-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(196, 137, 69, 0.2); }
    .step-number {
        background: #C48945; color: #fff; width: 40px; height: 40px; border-radius: 50%;
        font-size: 1.2rem; font-weight: bold; display: flex; justify-content: center;
        align-items: center; margin-bottom: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    .step-title { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 10px; }
    .step-desc { font-size: 0.9rem; color: #666; line-height: 1.5; text-align: left; width: 100%; }
    .step-desc ul { padding-left: 20px; margin: 5px 0; }
    .step-desc li { margin-bottom: 4px; }
    @media (max-width: 768px) {
        .process-container { flex-direction: column; }
        .step-card { flex-direction: row; align-items: flex-start; text-align: left; padding: 15px; }
        .step-number { margin-right: 15px; margin-bottom: 0; flex-shrink: 0; }
        .step-content-wrapper { flex: 1; }
    }

    /* === é ç´„å¤§æŒ‰éˆ• === */
    .reserve-action-area { text-align: center; margin-bottom: 50px; }
    .btn-large-reserve {
        display: inline-block; background: #C48945; color: white; border: none; border-radius: 50px;
        padding: 15px 40px; font-size: 20px; font-weight: bold; cursor: pointer;
        box-shadow: 0 5px 15px rgba(196, 137, 69, 0.4); transition: transform 0.2s;
    }
    .btn-large-reserve:hover { transform: scale(1.05); }

    /* === å…¨æ–°ï¼šç¾å ´æº–å‚™é€²åº¦çœ‹æ¿ === */
    .board-section-title {
        color: #333; border-bottom: 2px solid #E6BA67; padding-bottom: 10px; margin-bottom: 25px;
        display: flex; align-items: center; gap: 10px; font-size: 22px; font-weight: bold;
    }
    .date-board {
        background: #fffcf5; border: 2px solid #E6BA67; border-radius: 15px;
        padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .date-board-title { color: #C48945; font-size: 24px; margin-top: 0; margin-bottom: 20px; border-bottom: 1px dashed #E6BA67; padding-bottom: 10px;}
    .board-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media(max-width: 768px) { .board-grid { grid-template-columns: 1fr; } }
    .pickup-col { background: rgba(255,255,255,0.7); border-radius: 10px; padding: 15px; }
    .pickup-col h4 { margin-top: 0; display: flex; align-items: center; gap: 8px; color: #4b2c1c; }
    .cloth-item { 
        padding: 10px; border-bottom: 1px solid #eee; font-size: 16px; color: #333; 
        display: flex; justify-content: space-between; align-items: center;
    }
    .cloth-item:last-child { border-bottom: none; }
    .cloth-id { background: #E6BA67; color: white; padding: 2px 8px; border-radius: 6px; font-size: 14px; font-weight: bold;}

    /* === æ•™å­¸å€å¡Š (åŸæ±åŸå‘³ä¿ç•™) === */
    .instruction-box { background: #fff; border: 2px solid #ddd; border-radius: 15px; padding: 25px; margin-top: 40px; }
    .btn-action {
        display: inline-block; padding: 15px 50px; font-size: 1.3rem; font-weight: bold;
        background: #C48945; color: white; text-decoration: none; border-radius: 50px;
        box-shadow: 0 5px 15px rgba(196, 137, 69, 0.4); transition: 0.3s; cursor: pointer;
    }
    .btn-action:hover { transform: scale(1.05); }

    /* === Modal èˆ‡ è¡¨å–®æ¨£å¼ === */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-overlay.is-visible { display: flex; }
    .modal-content { background: #F3F0EC; padding: 30px; border-radius: 15px; position: relative; max-height: 90vh; overflow-y: auto; width: 90%; max-width: 600px; border: 3px solid #E6BA67; }
    .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #C48945; border: none; border-radius: 50%; width: 35px; height: 35px; color: white; font-size: 20px; cursor: pointer; }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
    .form-group input[type="date"], .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    .radio-group { display: flex; gap: 20px; }
    .radio-group label { font-weight: normal; cursor: pointer; display: flex; align-items: center; gap: 5px;}
    
    .clothes-container { background: #fff; border: 1px dashed #C48945; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .cloth-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .cloth-row input { flex: 1; }
    .btn-remove-cloth { background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 10px; }
    .btn-add-cloth { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; display: inline-flex; align-items: center; gap: 5px;}
    .btn-submit { background: #C48945; color: white; border: none; padding: 12px; width: 100%; border-radius: 25px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
</style>

<main class="ship-wrapper">
    <div class="page-header">
        <h2 class="section-title">æ”¶é©šè¡£æœå¯„å›èˆ‡è‡ªå–</h2>
    </div>

    <section class="process-section">
        <h2 class="process-title">è¡£ç‰©å¯„å›æœå‹™æµç¨‹</h2>
        <div class="process-container">
            <div class="step-card">
                <div class="step-number">1</div>
                <div class="step-content-wrapper">
                    <div class="step-title">ç¢ºèªåå–®</div>
                    <div class="step-desc">
                        <ul>
                            <li>LINEç¾¤çµ„é€šçŸ¥åå–®ä¸­æ‰¾åˆ°æ‚¨çš„åå­—æˆ–è¡£ç‰©ç·¨è™Ÿã€‚</li>
                            <li>ä»£è¡¨æ”¶é©šå®Œæˆï¼Œå¯é€²å…¥æ‰“åŒ…ç¨‹åºã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="step-card">
                <div class="step-number">2</div>
                <div class="step-content-wrapper">
                    <div class="step-title">ç³»çµ±é ç´„</div>
                    <div class="step-desc">
                        <ul>
                            <li>é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå¡«å¯«ã€Œé ç´„å–®ã€ã€‚</li>
                            <li>ç³»çµ±å°‡ç‚ºæ‚¨é–å®š<strong>å¯å–ä»¶æ—¥æœŸ</strong>ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="step-card">
                <div class="step-number">3</div>
                <div class="step-content-wrapper">
                    <div class="step-title">é ç´„ç‰©æµ</div>
                    <div class="step-desc">
                        <ul>
                            <li>è‡ªè¡Œè¯ç¹«é»‘è²“å®…æ€¥ä¾¿ã€‚</li>
                            <li>é¸<strong>ã€Œåˆ°åºœæ”¶ä»¶ã€ã€ã€Œé‹è²»åˆ°ä»˜ã€</strong>ã€‚</li>
                            <li><strong>å–ä»¶æ™‚é–“ï¼š</strong>å‹™å¿…è¨­å®šç‚ºæ‚¨åœ¨ç³»çµ±é ç´„çš„æ—¥æœŸã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="step-card">
                <div class="step-number">4</div>
                <div class="step-content-wrapper">
                    <div class="step-title">ç­‰å¾…æ”¶è²¨</div>
                    <div class="step-desc">
                        <ul>
                            <li><strong>æµç¨‹ï¼š</strong>å¸æ©Ÿè‡³å»Ÿæ”¶è²¨&rarr; é…é€&rarr; æ‚¨åœ¨å®¶æ”¶è²¨ä¸¦ä»˜æ¬¾ã€‚</li>
                            <li><strong>åœ“æ»¿ï¼š</strong>æµç¨‹çµæŸï¼Œé—”å®¶å¹³å®‰ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="reserve-action-area">
        <button id="open-reserve-btn" class="btn-large-reserve">ğŸ‘• æˆ‘è¦é ç´„å–ä»¶</button>
        <p style="color: #666; margin-top: 15px;">â€» æ”¶åˆ°å¯å–ä»¶é€šçŸ¥å¾Œï¼Œè«‹å¡«å¯«é ç´„å–®ï¼Œè®“é–€å¸‚äººå“¡ç‚ºæ‚¨ææ—©æº–å‚™ã€‚</p>
    </div>

    <h3 class="board-section-title">ğŸ“‹ ç¾å ´æº–å‚™é€²åº¦çœ‹æ¿</h3>
    <div id="public-board-container">
        <p style="text-align: center; color: #888;">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="instruction-box">
        <h3 style="color:#C48945; margin-top:0;">ä¸‹ä¸€æ­¥: é»‘è²“å®…æ€¥ä¾¿ App é ç´„æ•™å­¸</h3>
        <ol style="line-height: 1.8; color: #555;">
            <li>ä¸‹è¼‰ä¸¦é–‹å•Ÿã€Œé»‘è²“å®…æ€¥ä¾¿ Appã€ã€‚</li>
            <li>é¸æ“‡ã€Œå¸¸æº«å®…æ€¥ä¾¿ã€ &gt; ä»¶æ•¸é¸ã€Œ1ã€ã€‚</li>
            <li>å¯„ä»¶æ–¹å¼é¸ã€Œåˆ°åºœ (é»‘è²“åˆ°åºœå°å–®å¯„åŒ…è£¹)ã€ã€‚</li>
            <li>ä»˜è²»æ–¹å¼é¸ã€Œ<strong>åˆ°ä»˜å®…æ€¥ä¾¿</strong>ã€ã€‚</li>
            <li><strong>å¯„ä»¶äººè³‡è¨Š (å…«å…«è¸é…’)</strong>ï¼š
                <ul>
                    <li>å§“åï¼šå…«å…«è¸é…’</li>
                    <li>åœ°å€ï¼š600å˜‰ç¾©å¸‚æ±å€æ–°ç”Ÿè·¯337è™Ÿ</li>
                </ul>
            </li>
            <li><strong>æ”¶ä»¶äººè³‡è¨Š (æ‚¨çš„è³‡æ–™)</strong>ï¼š
                <ul>
                    <li>å§“åï¼šæ‚¨çš„åå­— + æ”¶é©šç·¨è™Ÿ</li>
                    <li>åœ°å€ï¼šæ‚¨çš„æ”¶ä»¶åœ°å€</li>
                </ul>
            </li>
            <li>å…§å®¹ï¼šå¡«å¯«ã€Œè¡£æœç¸½ä»¶æ•¸ã€ (å¦‚ï¼š3)ã€‚</li>
            <li><strong>å¯„ä»¶æ—¥</strong>ï¼šè«‹ä¾ç…§ä¸Šæ–¹ç³»çµ±é–å®šçš„é ç´„æ—¥æœŸå¡«å¯«ã€‚</li>
        </ol>
        <div style="text-align:center; margin-top:30px; border-top:1px dashed #ccc; padding-top:20px;">
            <p style="font-weight:bold; color:#333;">å·²å¡«å¯«å¯„ä»¶ç”³è«‹ï¼Œæ‹¿åˆ°é ç´„æ—¥æœŸäº†å—ï¼Ÿ</p>
            <a href="https://www.t-cat.com.tw/consign/icatapp.aspx" target="_blank" class="btn-action">
                Step2: é–‹å•Ÿé»‘è²“ APP
            </a>
        </div>
    </div>
</main>

<div id="reserve-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        
        <div id="login-prompt" style="display:none; text-align:center; padding: 30px 10px;">
            <h3 style="color: #C48945;">è«‹å…ˆç¶å®š LINE ç¹¼çºŒæ“ä½œ</h3>
            <p style="color:#666; margin-bottom:20px;">ç™»å…¥å¾Œå³å¯å¿«é€Ÿé ç´„ï¼Œä¸¦æ–¼å€‹äººå°ˆå€æŸ¥çœ‹é€²åº¦ã€‚</p>
            <a href="/api/line/login?next=/shipclothes" style="background: #06C755; color: white; padding: 10px 25px; border-radius: 25px; text-decoration: none; font-weight: bold;">ä½¿ç”¨ LINE ç™»å…¥</a>
        </div>

        <form id="reserve-form" style="display:none;">
            <h2 style="color: #C48945; text-align: center; margin-top: 0; border-bottom: 1px dashed #ccc; padding-bottom: 10px;">å¡«å¯«é ç´„å–®</h2>
            
            <div class="form-group">
                <label>ğŸ“ å–ä»¶æ–¹å¼</label>
                <div class="radio-group">
                    <label><input type="radio" name="pickupType" value="self" checked> ğŸƒ ç¾å ´è‡ªå–</label>
                    <label><input type="radio" name="pickupType" value="delivery"> ğŸšš é»‘è²“å¯„ä»¶</label>
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ“… é ç´„æ—¥æœŸ <span id="date-hint" style="color:#dc3545; font-size: 13px; font-weight:normal;">(æœ€å¿«å¯é ç´„å¾Œå¤©)</span></label>
                <input type="date" id="pickupDate" name="pickupDate" required>
            </div>

            <label style="font-weight: bold; color: #333; display:block; margin-bottom: 8px;">ğŸ‘• è¡£æœæ¸…å–® (å¯æ–°å¢å¤šä»¶)</label>
            <div id="clothes-list">
                <div class="clothes-container">
                    <div class="cloth-row">
                        <input type="text" name="clothId[]" placeholder="è¡£æœç·¨è™Ÿ(å¿…å¡«)" required>
                        <input type="text" name="clothName[]" placeholder="å§“å(å¿…å¡«)" required>
                        <input type="number" name="clothBirth[]" placeholder="è¾²æ›†å¹´ä»½(ä¾‹:84)" required style="width: 120px;">
                    </div>
                </div>
            </div>
            
            <button type="button" id="btn-add" class="btn-add-cloth">â• æ–°å¢ä¸€ä»¶è¡£æœ</button>
            <button type="submit" id="btn-submit" class="btn-submit">ç¢ºèªé ç´„</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const getCsrfToken = () => document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    const boardContainer = document.getElementById('public-board-container');
    const openBtn = document.getElementById('open-reserve-btn');
    const modal = document.getElementById('reserve-modal');
    const loginPrompt = document.getElementById('login-prompt');
    const form = document.getElementById('reserve-form');
    
    // --- 1. è¼‰å…¥çœ‹æ¿è³‡æ–™ ---
    function loadPublicBoard() {
        fetch('/api/pickup/public')
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) {
                    boardContainer.innerHTML = '<p style="text-align:center; padding: 20px;">ç›®å‰å°šç„¡æº–å‚™ä¸­çš„é ç´„è³‡æ–™ã€‚</p>';
                    return;
                }
                
                boardContainer.innerHTML = data.map(day => {
                    const selfHtml = day.self.length ? day.self.map(c => `
                        <div class="cloth-item">
                            <span>${c.name} (${c.birthYear})</span>
                            <span class="cloth-id">${c.clothId}</span>
                        </div>
                    `).join('') : '<p style="color:#888; font-size:14px; text-align:center;">ç„¡</p>';
                    
                    const deliveryHtml = day.delivery.length ? day.delivery.map(c => `
                        <div class="cloth-item">
                            <span>${c.name} (${c.birthYear})</span>
                            <span class="cloth-id">${c.clothId}</span>
                        </div>
                    `).join('') : '<p style="color:#888; font-size:14px; text-align:center;">ç„¡</p>';

                    return `
                    <div class="date-board">
                        <h3 class="date-board-title">ğŸ“… ${day.date}</h3>
                        <div class="board-grid">
                            <div class="pickup-col">
                                <h4>ğŸƒ ç¾å ´è‡ªå–å€</h4>
                                ${selfHtml}
                            </div>
                            <div class="pickup-col">
                                <h4>ğŸšš é»‘è²“å¯„ä»¶å€</h4>
                                ${deliveryHtml}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            });
    }
    loadPublicBoard();

    // --- 2. æ—¥æœŸé‚è¼¯è¨­å®š (D+2 ~ D+14) ---
    const dateInput = document.getElementById('pickupDate');
    const typeRadios = document.querySelectorAll('input[name="pickupType"]');
    const dateHint = document.getElementById('date-hint');

    const today = new Date();
    const d2 = new Date(today); d2.setDate(today.getDate() + 2);
    const d14 = new Date(today); d14.setDate(today.getDate() + 14);

    const formatDate = (d) => {
        const tzOffset = d.getTimezoneOffset() * 60000;
        return (new Date(d - tzOffset)).toISOString().split('T')[0];
    };

    const minDateStr = formatDate(d2);
    const maxDateStr = formatDate(d14);

    function updateDateLimits() {
        const selectedType = document.querySelector('input[name="pickupType"]:checked').value;
        if (selectedType === 'delivery') {
            dateInput.min = minDateStr;
            dateInput.max = minDateStr;
            dateInput.value = minDateStr;
            dateInput.readOnly = true; 
            dateHint.textContent = "(é»‘è²“å¯„ä»¶åƒ…é™æŒ‡å®šå¾Œå¤©æº–å‚™)";
        } else {
            dateInput.min = minDateStr;
            dateInput.max = maxDateStr;
            dateInput.value = minDateStr;
            dateInput.readOnly = false;
            dateHint.textContent = "(å¯é ç´„ 2~14 å¤©å…§)";
        }
    }
    typeRadios.forEach(r => r.addEventListener('change', updateDateLimits));

    // --- 3. å‹•æ…‹æ–°å¢è¡£æœæ¬„ä½ ---
    const clothesList = document.getElementById('clothes-list');
    document.getElementById('btn-add').addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'clothes-container';
        div.innerHTML = `
            <div class="cloth-row">
                <input type="text" name="clothId[]" placeholder="è¡£æœç·¨è™Ÿ(å¿…å¡«)" required>
                <input type="text" name="clothName[]" placeholder="å§“å(å¿…å¡«)" required>
                <input type="number" name="clothBirth[]" placeholder="è¾²æ›†å¹´ä»½(ä¾‹:84)" required style="width: 120px;">
                <button type="button" class="btn-remove-cloth">âŒ</button>
            </div>
        `;
        clothesList.appendChild(div);
        div.querySelector('.btn-remove-cloth').addEventListener('click', () => clothesList.removeChild(div));
    });

    // --- 4. Modal æ§åˆ¶èˆ‡èº«åˆ†æª¢æŸ¥ ---
    openBtn.addEventListener('click', () => {
        modal.classList.add('is-visible');
        fetch('/api/user/me')
            .then(res => res.json())
            .then(data => {
                if (data.logged_in) {
                    loginPrompt.style.display = 'none';
                    form.style.display = 'block';
                    updateDateLimits();
                } else {
                    loginPrompt.style.display = 'block';
                    form.style.display = 'none';
                }
            });
    });

    document.querySelector('.modal-close-btn').addEventListener('click', () => modal.classList.remove('is-visible'));
    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('is-visible'); });

    // --- 5. é€å‡ºè¡¨å–® ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('btn-submit');
        submitBtn.disabled = true; submitBtn.textContent = 'è™•ç†ä¸­...';

        const ids = document.querySelectorAll('input[name="clothId[]"]');
        const names = document.querySelectorAll('input[name="clothName[]"]');
        const births = document.querySelectorAll('input[name="clothBirth[]"]');
        
        const clothesData = [];
        for(let i=0; i<ids.length; i++) {
            clothesData.push({ clothId: ids[i].value.trim(), name: names[i].value.trim(), birthYear: births[i].value.trim() });
        }

        const payload = {
            pickupType: document.querySelector('input[name="pickupType"]:checked').value,
            pickupDate: document.getElementById('pickupDate').value,
            clothes: clothesData
        };

        try {
            const res = await fetch('/api/pickup/reserve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('é ç´„å¤±æ•—');
            
            alert('é ç´„æˆåŠŸï¼æ‚¨å¯ä»¥åœ¨ã€Œå€‹äººå°ˆå€ã€æŸ¥çœ‹é ç´„ç´€éŒ„ã€‚');
            modal.classList.remove('is-visible');
            form.reset();
            loadPublicBoard();
        } catch (err) {
            alert(err.message);
        } finally {
            submitBtn.disabled = false; submitBtn.textContent = 'ç¢ºèªé ç´„';
        }
    });
});
</script>
{% endblock %}
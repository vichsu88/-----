{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å¯„å›è¡£ç‰©ç™»è¨˜{% endblock %}

{% block content %}
<style>
    .ship-wrapper {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
        position: relative;
    }
    
    /* === ç•™è¨€æ¿å€å¡Š (Board) === */
    .board-section { margin-bottom: 40px; }
    .board-title {
        text-align: center; font-size: 24px; color: #C48945; margin-bottom: 20px; font-weight: bold;
    }
    .board-list { display: flex; flex-direction: column; gap: 25px; } /* å¢åŠ é–“è· */
    
    /* æ—¥æœŸåˆ†çµ„å®¹å™¨ */
    .date-group {
        border: 2px solid #E6BA67;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    
    /* æ—¥æœŸæ¨™é¡Œ (Header) */
    .date-header {
        background: #E6BA67;
        color: #fff;
        padding: 12px 20px;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* è©²æ—¥æœŸçš„æ‰€æœ‰å¡ç‰‡å®¹å™¨ */
    .date-content {
        padding: 15px;
        background: #fff;
    }

    /* å–®ç­†ç”³è«‹å¡ç‰‡ */
    .submission-card {
        padding: 15px;
        border-bottom: 1px dashed #ddd;
    }
    .submission-card:last-child { border-bottom: none; }
    
    .card-user-info {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
    }
    .tag-line { background: #eee; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: normal;}
    .card-clothes-list {
        margin-left: 10px;
    }
    .cloth-item {
        display: inline-block;
        background: #f9f9f9;
        border: 1px solid #eee;
        padding: 4px 8px;
        margin: 0 5px 5px 0;
        border-radius: 4px;
        font-size: 14px;
        color: #555;
    }

    /* === ä¸‹æ–¹æ•™å­¸å€å¡Š === */
    .instruction-box {
        background: #fff; border: 2px solid #ddd; border-radius: 15px; padding: 25px; margin-top: 40px;
    }
    .instruction-title { color: #555; font-size: 20px; font-weight: bold; margin-bottom: 15px; }
    .black-cat-btn {
        background: #333; color: #fff; padding: 10px 20px; border-radius: 5px; text-decoration: none;
        font-size: 14px; display: inline-block; margin-top: 15px;
    }
    .black-cat-btn:hover { background: #555; transform: translateY(-2px); }

    /* === æ‡¸æµ®æŒ‰éˆ• === */
    .feedback-floating-btn {
        position: fixed; top: 50%; right: 0; transform: translateY(-50%); z-index: 900; cursor: pointer;
        transition: transform 0.2s, opacity 0.3s; width: 210px;
    }
    .feedback-floating-btn img { width: 100%; height: auto; display: block; }
    .feedback-floating-btn:hover { transform: translateY(-50%) scale(1.05); }
    @media (max-width: 768px) {
        .feedback-floating-btn { width: 130px;
            top: auto;
            bottom: 85px; /* æ”¹ç‚º 85pxï¼Œé¿é–‹ä¸‹æ–¹çš„ TOP æŒ‰éˆ• */
            transform: none;
            right: 10px; }
        .feedback-floating-btn:hover { transform: scale(1.05); }
    }

    /* === Modal æ¨£å¼ === */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center;
        backdrop-filter: blur(3px);
    }
    .modal-overlay.is-visible { display: flex; }
    .modal-content {
        background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;
        position: relative; border: 3px solid #E6BA67; max-height: 90vh; overflow-y: auto;
    }
    .modal-close-btn {
        position: absolute; top: 15px; right: 15px; background: #C48945; color: #fff;
        border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; }
    .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    
    .clothing-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .clothing-row input { flex: 1; }
    
    .remove-btn {
        background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px;
        line-height: 30px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .add-btn {
        background: #28a745; color: white; border: none; border-radius: 5px; padding: 8px 15px;
        font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; margin-top: 5px;
    }
    .captcha-row { display: flex; gap: 10px; align-items: center; }
    .captcha-q { background: #eee; padding: 10px; border-radius: 6px; font-weight: bold; min-width: 80px; text-align: center; }
    .btn--brown { background: #C48945; color: #fff; border: none; padding: 12px; width: 100%; border-radius: 6px; font-size: 16px; cursor: pointer; }
</style>

<main class="ship-wrapper">
    <div id="open-ship-form-btn" class="feedback-floating-btn">
        <img src="{{ url_for('static', filename='images/pages/feedback/ship.png') }}" alt="æˆ‘è¦ç™»è¨˜">
    </div>

    <div class="board-section">
        <h2 class="board-title">ğŸ“… è¿‘æœŸæ”¶ä»¶æ¸…å–® (è‡ªå‹•æ›´æ–°)</h2>
        <p style="text-align:center; color:#888; font-size:14px; margin-bottom:20px;">åƒ…é¡¯ç¤º æ˜¨æ—¥ ~ æœªä¾† 5 å¤© å…§çš„ç™»è¨˜è³‡æ–™</p>
        <div id="board-list" class="board-list"><p style="text-align:center;">è¼‰å…¥ä¸­...</p></div>
    </div>

    <div class="instruction-box">
        <div class="instruction-title">ğŸ“¦ Step2:é ç´„é»‘è²“å¯„ä»¶</div>
        <p style="line-height:1.8;">
            1. å…ˆå¡«å¯«"æˆ‘è¦å¯„å›å–®"ç¢ºèªå…«å…«å¯æ”¶ä»¶æ—¥æœŸã€‚<br>
            2. å‰å¾€é»‘è²“å®˜ç¶²é ç´„é‹è²»åˆ°ä»˜å¯„ä»¶ã€‚<br>
            <strong>æ”¶ä»¶è³‡è¨Šï¼š</strong>600å˜‰ç¾©å¸‚æ±å€æ–°ç”Ÿè·¯337è™Ÿ
        </p>
        <a href="https://www.t-cat.com.tw/" target="_blank" class="black-cat-btn">å‰å¾€é»‘è²“å®…æ€¥ä¾¿å®˜ç¶² â¤</a>
    </div>
</main>

<div id="ship-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h3 style="margin-top:0; color:#C48945; text-align:center;">ç™»è¨˜å¯„å›è¡£ç‰©</h3>
        <p style="color:#666; font-size:14px; text-align:center; margin-bottom:20px;">è«‹ä¾ç…§æ¬„ä½é †åºå¡«å¯«ï¼Œè¡£ç‰©å¯é»æ“Š + æ–°å¢å¤šç­†ã€‚</p>
        
        <form id="ship-form">
            <div class="form-group">
                <label>1. æ‰€å±¬ Line ç¾¤çµ„</label>
                <select id="lineGroup" class="form-control" required>
                    <option value="" disabled selected>è«‹é¸æ“‡ç¾¤çµ„</option>
                    <option value="ç¾¤çµ„ä¸€">ç¾¤çµ„ä¸€</option>
                    <option value="ç¾¤çµ„äºŒ">ç¾¤çµ„äºŒ</option>
                    <option value="ç¾¤çµ„ä¸‰">ç¾¤çµ„ä¸‰</option>
                    <option value="ç¾¤çµ„å››">ç¾¤çµ„å››</option>
                </select>
            </div>

            <div class="form-group">
                <label>2. Line åç¨± (ç¾¤çµ„å…§æš±ç¨±)</label>
                <input type="text" id="lineName" class="form-control" placeholder="ä¾‹å¦‚ï¼šå¿«æ¨‚å°æ˜" required>
            </div>

            <div class="form-group">
                <label>3. å¯„ä»¶äººçœŸå¯¦å§“å (éš±ç¢¼é¡¯ç¤º)</label>
                <input type="text" id="senderName" class="form-control" placeholder="è«‹å¡«å¯«å…¨å" required>
            </div>

            <div class="form-group">
                <label>4. è¡£æœæ˜ç´° (ç·¨è™Ÿ/å§“å/å¹´åˆ†)</label>
                <div id="clothes-container">
                    <div class="clothing-row">
                        <input type="text" class="form-control clothing-id" placeholder="ç·¨è™Ÿ (ä¾‹å¦‚ 122413)" required>
                        <input type="text" class="form-control clothing-owner" placeholder="æœ¬å" required>
                        <input type="text" id="birthYear" class="form-control" placeholder="æ°‘åœ‹å¹´ä»½" required>
                    </div>
                </div>
                <button type="button" class="add-btn" id="add-clothing-btn">ï¼‹ æ–°å¢ä¸‹ä¸€ä»¶</button>
            </div>

            <div class="form-group">
                <label>é©—è­‰ç¢¼ </label>
                <div class="captcha-row">
                    <div id="captcha-question" class="captcha-q">...</div>
                    <input type="text" id="captcha-input" class="form-control" placeholder="ç­”æ¡ˆ" required style="flex:1;">
                </div>
            </div>

            <p id="preview-date" style="text-align:center; color:#C48945; font-weight:bold; margin-bottom:15px;"></p>
            <button type="submit" class="btn--brown">é€å‡ºç™»è¨˜</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('ship-modal');
    const openBtn = document.getElementById('open-ship-form-btn');
    const closeBtn = document.querySelector('.modal-close-btn');
    const form = document.getElementById('ship-form');
    const boardList = document.getElementById('board-list');
    const datePreview = document.getElementById('preview-date');
    const captchaQ = document.getElementById('captcha-question');
    const clothesContainer = document.getElementById('clothes-container');
    const addClothingBtn = document.getElementById('add-clothing-btn');

    openBtn.onclick = async () => { modal.classList.add('is-visible'); openBtn.style.opacity=0; openBtn.style.zIndex=-1; await fetchCaptcha(); await fetchDatePreview(); };
    function closeModal() { modal.classList.remove('is-visible'); openBtn.style.opacity=1; openBtn.style.zIndex=900; }
    closeBtn.onclick = closeModal;
    modal.onclick = (e) => { if(e.target===modal) closeModal(); };

    // æ–°å¢è¡£æœæ¬„ä½
    addClothingBtn.onclick = () => {
        const div = document.createElement('div');
        div.className = 'clothing-row';
        div.innerHTML = `
            <input type="text" class="form-control clothing-id" placeholder="ç·¨è™Ÿ" required>
            <input type="text" class="form-control clothing-owner" placeholder="ä¸»äººå§“å" required>
            <button type="button" class="remove-btn">Ã—</button>
        `;
        clothesContainer.appendChild(div);
        div.querySelector('.remove-btn').onclick = () => div.remove();
    };

    async function fetchCaptcha() {
        try {
            const res = await fetch('/api/captcha');
            const data = await res.json();
            captchaQ.textContent = data.question;
            document.getElementById('captcha-input').value = '';
        } catch(e){}
    }
    async function fetchDatePreview() {
        try {
            const res = await fetch('/api/shipclothes/calc-date');
            const data = await res.json();
            datePreview.textContent = `é»‘è²“æ”¶ä»¶æ—¥ï¼š${data.pickupDate}`;
        } catch(e){}
    }

    form.onsubmit = async (e) => {
        e.preventDefault();
        const idInputs = document.querySelectorAll('.clothing-id');
        const ownerInputs = document.querySelectorAll('.clothing-owner');
        const clothes = [];
        for(let i=0; i<idInputs.length; i++) {
            const id = idInputs[i].value.trim();
            const owner = ownerInputs[i].value.trim();
            if(id && owner) clothes.push({ id, owner });
        }
        if(!clothes.length) { alert('è«‹å¡«å¯«è¡£æœ'); return; }

        const payload = {
            lineGroup: document.getElementById('lineGroup').value,
            lineName: document.getElementById('lineName').value.trim(),
            name: document.getElementById('senderName').value.trim(),
            birthYear: document.getElementById('birthYear').value.trim(),
            clothes: clothes,
            captcha: document.getElementById('captcha-input').value.trim()
        };

        try {
            const res = await fetch('/api/shipclothes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')},
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if(result.success) {
                alert(`ç™»è¨˜æˆåŠŸï¼\né è¨ˆæ”¶ä»¶æ—¥ï¼š${result.pickupDate}`);
                form.reset();
                clothesContainer.innerHTML = `<div class="clothing-row"><input type="text" class="form-control clothing-id" placeholder="ç·¨è™Ÿ (ä¾‹å¦‚ A001)" required><input type="text" class="form-control clothing-owner" placeholder="ä¸»äººå§“å (æœ¬å)" required></div>`;
                closeModal();
                fetchBoardData();
            } else {
                alert(result.message);
                if(result.message.includes('é©—è­‰ç¢¼')) fetchCaptcha();
            }
        } catch(e) { alert('é€£ç·šéŒ¯èª¤'); }
    };

    // è¼‰å…¥æ¸…å–® (ä¾ç…§æ—¥æœŸåˆ†çµ„é¡¯ç¤º)
    async function fetchBoardData() {
        try {
            const res = await fetch('/api/shipclothes/list');
            const data = await res.json();
            if(data.length === 0) { boardList.innerHTML = '<p style="text-align:center;color:#999;">ç›®å‰ç„¡è³‡æ–™</p>'; return; }

            // 1. è³‡æ–™åˆ†çµ„ï¼š { "2023/10/27": [item1, item2], "2023/10/28": [item3] }
            const grouped = {};
            data.forEach(item => {
                if(!grouped[item.pickupDate]) grouped[item.pickupDate] = [];
                grouped[item.pickupDate].push(item);
            });

            // 2. æ¸²æŸ“ HTML
            let html = '';
            for (const [date, items] of Object.entries(grouped)) {
                // ç”Ÿæˆè©²æ—¥æœŸçš„æ‰€æœ‰ç”³è«‹å¡ç‰‡
                const itemsHtml = items.map(item => {
                    const clothesHtml = item.clothes.map(c => 
                        `<span class="cloth-item"><b>${c.id}</b> <small>(${c.owner})</small></span>`
                    ).join('');
                    
                    return `
                    <div class="submission-card">
                        <div class="card-user-info">
                            ${item.name} <span style="font-weight:normal; font-size:14px; color:#666;">(${item.birthYear}å¹´æ¬¡)</span>
                            <span class="tag-line">${item.lineName}</span>
                            <span class="tag-line">@${item.lineGroup}</span>
                        </div>
                        <div class="card-clothes-list">
                            ${clothesHtml}
                        </div>
                    </div>`;
                }).join('');

                // çµ„åˆæ—¥æœŸå€å¡Š
                html += `
                <div class="date-group">
                    <div class="date-header">ğŸ“… é è¨ˆæ”¶ä»¶æ—¥ï¼š${date}</div>
                    <div class="date-content">
                        ${itemsHtml}
                    </div>
                </div>`;
            }
            boardList.innerHTML = html;

        } catch(e) { boardList.innerHTML = '<p>è¼‰å…¥å¤±æ•—</p>'; }
    }

    fetchBoardData();
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}承天中承府 - 信徒回饋{% endblock %}

{% block content %}

<style>
    /* --- 本頁專屬樣式 --- */
    .feedback-page-wrapper {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
        position: relative;
    }
    .feedback-header {
        text-align: center;
        margin-bottom: 40px;
    }

    /* 列表卡片樣式 */
    .feedback-card{
        font-family:'Noto Sans TC', sans-serif;
        border:2px solid #E6BA67;
        border-radius:30px;
        padding:20px 24px;
        margin:0 auto 25px auto;
        max-width: 600px;
        background:#FFF;
    }
    .feedback-card__header{
        margin:0 0 12px 0;
        font-size:22px;
        font-weight:bold;
        color:#C48945;
        line-height:1.3;
    }
    .feedback-card__content{
        font-size:16px;
        line-height:1.9;
        color:#555;
        white-space:pre-wrap;
        word-break:break-word; /* 防止長文字爆版 */
    }

    /* 浮動按鈕 (電腦版) */
    .feedback-floating-btn {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 900;
        cursor: pointer;
        transition: transform 0.2s, opacity 0.3s;
        width: 210px;
    }
    .feedback-floating-btn img { width: 100%; height: auto; display: block; }
    .feedback-floating-btn:hover { transform: translateY(-50%) scale(1.05); }

    /* 手機版浮動按鈕 */
    @media (max-width: 768px) {
        .feedback-floating-btn {
            width: 130px;
            top: auto;
            bottom: 30px;
            transform: none;
        }
        .feedback-floating-btn:hover { transform: scale(1.05); }
    }

    /* --- Modal 共用樣式 --- */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 1000;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.is-visible { display: flex; }
    
    /* ★★★ 版面寬度優化 ★★★ */
    .modal-content {
        background: #F3F0EC; 
        padding: 30px; 
        border-radius: 15px;
        position: relative;
        max-height: 90vh; 
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        
        /* 電腦版寬度 85% */
        width: 85%;
        max-width: 1000px; 
    }

    /* 手機版寬度 98% */
    @media (max-width: 768px) {
        .modal-content {
            width: 98%;
            padding: 20px 15px; /* 減少內距以爭取空間 */
        }
    }
    
    .modal-close-btn {
        position: absolute; top: 15px; right: 15px; background: #C48945;
        border: 1px solid #D9B88A; border-radius: 50%; width: 35px; height: 35px;
        color: white; font-size: 20px; line-height: 35px; text-align: center;
        cursor: pointer; padding: 0;
    }

    /* 表單樣式 */
    .feedback-note{ line-height:1.7; letter-spacing:.05em; text-align:left; margin-bottom:18px; }
    .feedback-note strong{ display:block; font-size:clamp(18px,4vw,22px); color:#C48945; margin:0 0 8px 0; }
    
    .form-fieldset{ 
        padding:20px 18px; 
        border-radius:35px; 
        border:2px solid #E6BA67; 
        background:rgba(255,255,255,.50); 
        box-shadow:0 0 5px rgba(255,255,255,.50) inset; 
        backdrop-filter:blur(7.5px); 
        margin-bottom: 20px;
    }
    
    .form-fieldset label, .single-choice{display:block;margin-bottom:12px;font-size:15px;}
    .form-fieldset input[type=text], .form-fieldset input[type=tel], .form-fieldset textarea, .form-fieldset select { 
        width:100%;border:1px solid #ccc;border-radius:6px;padding:8px 10px; font-size:15px;box-sizing:border-box; 
    }
    .single-choice label{margin-right:10px;font-weight:normal; display: inline-block;}
    
    .btn-primary{ 
        width:100%;max-width:200px;margin:0 auto;display:block; 
        background:#C48945;color:#fff;font-size:17px;font-weight:bold; 
        border:none;border-radius:25px;padding:12px 0;cursor:pointer; 
        box-shadow:0 4px 10px rgba(0,0,0,.15); transition:opacity .2s; 
    }
    .btn-primary:disabled{opacity:.45;cursor:not-allowed; background:#999;}
    
    /* 第二階段確認視窗樣式 */
    .review-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        table-layout: fixed; /* 固定表格佈局 */
    }
    .review-table th, .review-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: left;
        vertical-align: top;
    }
    .review-table th {
        background: #E6BA67;
        color: white;
        width: 120px; /* 固定標題寬度 */
        font-weight: normal;
    }
    /* ★★★ 內容防爆版關鍵 ★★★ */
    .review-table td {
        word-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap;
    }

    .agree-box {
        background: #fff; padding: 15px; border-radius: 8px; border: 1px dashed #C48945;
        margin-bottom: 20px; font-size: 14px; line-height: 1.6;
    }
    .action-buttons { display: flex; gap: 15px; justify-content: center; }
    .btn-secondary {
        background: #6c757d; color: white; border: none; border-radius: 25px;
        padding: 12px 25px; font-size: 16px; cursor: pointer;
    }
</style>

<main class="feedback-page-wrapper">
    <div class="feedback-header">
        <h2 class="section-title">信徒回饋</h2>
    </div>

    <a href="#" id="show-feedback-form-btn" class="feedback-floating-btn">
        <img src="{{ url_for('static', filename='images/pages/feedback/new.png') }}" alt="我要回饋">
    </a>

    <div id="feedback-list-container">
        </div>
</main>

<div id="feedback-form-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <form id="feedback-form">
            <h2 class="section-title" style="margin-top:0">我要回饋</h2>
            <p class="feedback-note">
                <strong>一份善緣，一份心意</strong><br>
                每一份感動、每一次在生活中受到的護佑，都是元帥慈悲的珍貴見證。<br>
                請完整填寫以下資訊（所有欄位皆為必填），下一步將進行資料確認。
            </p>
            
            <div class="form-fieldset">
                <label>真實姓名：<input type="text" name="realName" required placeholder="請填寫真實姓名"></label>
                <label>暱稱 (公開顯示)：<input type="text" name="nickname" required placeholder="例如：陳信徒"></label>
                
                <div class="single-choice">
                    <p style="margin-bottom:5px; font-weight:bold;">類別（擇一）：</p>
                    <label><input type="radio" name="category" value="運途" required> 運途</label>
                    <label><input type="radio" name="category" value="事業"> 事業</label>
                    <label><input type="radio" name="category" value="財運"> 財運</label>
                    <label><input type="radio" name="category" value="身體"> 身體</label>
                    <label><input type="radio" name="category" value="姻緣"> 姻緣</label>
                    <label><input type="radio" name="category" value="收驚"> 收驚</label>
                    <label><input type="radio" name="category" value="其他"> 其他</label>
                </div>

                <label>回饋內容（至少 100 字）：
                    <textarea name="content" rows="6" minlength="100" required placeholder="請分享您的故事..."></textarea>
                </label>

                <div class="form-group">
                    <label for="lunarBirthday">農曆生日 (YYYY/MM/DD) <span style="color:red;font-size:12px;">*必填</span></label>
                    <input type="text" id="lunarBirthday" name="lunarBirthday" 
                          placeholder="例如：1995/08/21" maxlength="10" required>
                    <small style="color:#888;">格式範例：1995/01/01 (月日請補0)</small>
                </div>

                <div class="form-group">
                    <label for="birthTime">出生時辰 <span style="color:red;font-size:12px;">*必填</span></label>
                    <select id="birthTime" name="birthTime" required>
                        <option value="" disabled selected>請選擇時辰</option>
                        <option value="吉時 (不知道)">吉時 (不知道)</option>
                        <option value="子時 (23:00-01:00)">子時 (23:00-01:00)</option>
                        <option value="丑時 (01:00-03:00)">丑時 (01:00-03:00)</option>
                        <option value="寅時 (03:00-05:00)">寅時 (03:00-05:00)</option>
                        <option value="卯時 (05:00-07:00)">卯時 (05:00-07:00)</option>
                        <option value="辰時 (07:00-09:00)">辰時 (07:00-09:00)</option>
                        <option value="巳時 (09:00-11:00)">巳時 (09:00-11:00)</option>
                        <option value="午時 (11:00-13:00)">午時 (11:00-13:00)</option>
                        <option value="未時 (13:00-15:00)">未時 (13:00-15:00)</option>
                        <option value="申時 (15:00-17:00)">申時 (15:00-17:00)</option>
                        <option value="酉時 (17:00-19:00)">酉時 (17:00-19:00)</option>
                        <option value="戌時 (19:00-21:00)">戌時 (19:00-21:00)</option>
                        <option value="亥時 (21:00-23:00)">亥時 (21:00-23:00)</option>
                    </select>
                </div>

                <label>寄件地址：<input type="text" name="address" required placeholder="請填寫完整收件地址"></label>
                <label>聯絡電話：<input type="tel" name="phone" required placeholder="例如：0912345678"></label>
            </div>

            <button type="button" id="go-to-review-btn" class="btn-primary" disabled>下一步：確認資料</button>
        </form>
    </div>
</div>

<div id="review-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="section-title" style="margin-top:0">確認資料</h2>
        
        <table class="review-table">
            <tr><th>真實姓名</th><td id="review-realName"></td></tr>
            <tr><th>暱稱</th><td id="review-nickname"></td></tr>
            <tr><th>類別</th><td id="review-category"></td></tr>
            <tr><th>農曆生日</th><td id="review-lunarBirthday"></td></tr>
            <tr><th>時辰</th><td id="review-birthTime"></td></tr>
            <tr><th>電話</th><td id="review-phone"></td></tr>
            <tr><th>地址</th><td id="review-address"></td></tr>
            <tr>
                <th colspan="2" style="text-align:center; background:#f0f0f0; color:#555;">回饋內容</th>
            </tr>
            <tr>
                <td colspan="2" id="review-content"></td>
            </tr>
        </table>

        <div class="agree-box">
            <label style="cursor:pointer; display:flex; align-items:flex-start;">
                <input type="checkbox" id="review-agreed" style="margin-right:10px; margin-top:4px; transform: scale(1.2);">
                <span>
                    我已詳閱並同意授權上述內容供本府公開刊登。<br>
                    <span style="color:#d9534f;">※ 資料送出後無法自行修改，若資料不完整恕無法重新寄送平安符，請確認無誤。</span>
                </span>
            </label>
        </div>

        <div class="action-buttons">
            <button type="button" id="back-to-edit-btn" class="btn-secondary">返回修改</button>
            <button type="button" id="confirm-submit-btn" class="btn-primary" disabled>確認送出</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const getCsrfToken = () => document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  
  // DOM Elements
  const feedbackListContainer = document.getElementById('feedback-list-container');
  const showFormBtn = document.getElementById('show-feedback-form-btn');
  
  // Modals
  const formModal = document.getElementById('feedback-form-modal');
  const reviewModal = document.getElementById('review-modal');
  
  // Buttons
  const goToReviewBtn = document.getElementById('go-to-review-btn');
  const backToEditBtn = document.getElementById('back-to-edit-btn');
  const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
  
  // Form Inputs
  const feedbackForm = document.getElementById('feedback-form');
  const agreeCheckbox = document.getElementById('review-agreed');
  const lunarInput = document.getElementById('lunarBirthday');

  // --- 1. 自動載入回饋列表 ---
  async function fetchAndRenderFeedback() {
    try {
      const res = await fetch('/api/feedback/approved', { credentials:'include' });
      if (!res.ok) throw new Error('讀取回饋資料失敗');
      const data = await res.json();
      
      feedbackListContainer.innerHTML = '';
      if (data.length === 0) {
        feedbackListContainer.innerHTML = '<p style="text-align:center;">目前沒有已刊登的信徒回饋。</p>';
        return;
      }
      
      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'feedback-card';
        const nickname = item.nickname || '匿名';
        const category = Array.isArray(item.category) ? item.category.join(', ') : '';
        const header = document.createElement('h3');
        header.className = 'feedback-card__header';
        header.innerHTML = `<span class="nickname">${nickname}</span> / ${category}`;
        const content = document.createElement('p');
        content.className = 'feedback-card__content';
        content.textContent = item.content;
        content.innerHTML = content.innerHTML.replace(/\n/g, '<br>');
        card.appendChild(header);
        card.appendChild(content);
        feedbackListContainer.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      feedbackListContainer.innerHTML = '<p style="text-align:center;">讀取資料時發生錯誤，請稍後再試。</p>';
    }
  }

  // --- 2. Fix: 農曆生日輸入修正 (解決重複輸入問題 + 範圍驗證) ---
  if(lunarInput){
      let isComposing = false; 

      lunarInput.addEventListener('compositionstart', () => { isComposing = true; });
      lunarInput.addEventListener('compositionend', () => { isComposing = false; handleInput(); });

      lunarInput.addEventListener('input', (e) => {
          if (isComposing) return;
          handleInput(e);
      });

      function handleInput(e) {
        let v = lunarInput.value.replace(/\D/g, ''); // 只保留數字
        if (v.length > 8) v = v.slice(0, 8); // YYYYMMDD 最多8碼

        // 格式化邏輯
        let formatted = '';
        if (v.length > 4) {
          formatted = v.slice(0, 4) + '/' + v.slice(4);
        } else if (v.length === 4) {
           // 只有在不是刪除鍵操作時才自動補斜線
           if(e && e.inputType !== 'deleteContentBackward') formatted = v + '/';
           else formatted = v;
        } else {
          formatted = v;
        }

        if (formatted.length > 7) {
           // formatted 現在像 1995/08
           let rawDate = v.slice(4, 6); // 月份部分
           
           // 自動補第二個斜線
           if(v.length >= 7) {
               formatted = v.slice(0, 4) + '/' + v.slice(4, 6) + '/' + v.slice(6);
           }
        }
        
        // 只有當格式化後的字串跟當前顯示的不一樣時才更新
        if (lunarInput.value !== formatted) {
            lunarInput.value = formatted;
        }
        
        checkFormValidity(); // 每次輸入都檢查按鈕狀態
      }
  }

  // 日期有效性檢查 (YYYY/MM/DD)
  function isValidDate(dateString) {
      const regex = /^\d{4}\/\d{2}\/\d{2}$/;
      if (!regex.test(dateString)) return false;
      
      const parts = dateString.split('/');
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const day = parseInt(parts[2], 10);

      // 檢查範圍
      if (month < 1 || month > 12) return false;
      if (day < 1 || day > 31) return false;
      
      // 簡單檢查年份合理性
      if (year < 1900 || year > new Date().getFullYear()) return false;

      return true;
  }

  // --- 3. 檢查表單完整性 (所有欄位必填) ---
  function checkFormValidity() {
    const isRealName = feedbackForm.realName.value.trim().length > 0;
    const isNickname = feedbackForm.nickname.value.trim().length > 0;
    const isCategory = !!feedbackForm.category.value;
    const isContentOk = feedbackForm.content.value.trim().length >= 100;
    const isPhone = feedbackForm.phone.value.trim().length > 0;
    const isAddress = feedbackForm.address.value.trim().length > 0;
    const isBirthTime = feedbackForm.birthTime.value !== "";
    
    // 日期檢查
    const dateVal = lunarInput.value;
    const isDateOk = isValidDate(dateVal);

    // 只有全部通過，按鈕才啟用
    const allValid = isRealName && isNickname && isCategory && isContentOk && isPhone && isAddress && isBirthTime && isDateOk;
    goToReviewBtn.disabled = !allValid;
  }

  feedbackForm.addEventListener('input', checkFormValidity);
  feedbackForm.addEventListener('change', checkFormValidity); // 針對 radio 和 select

  // --- 4. 點擊「下一步：確認資料」 ---
  goToReviewBtn.addEventListener('click', () => {
    document.getElementById('review-realName').textContent = feedbackForm.realName.value;
    document.getElementById('review-nickname').textContent = feedbackForm.nickname.value;
    document.getElementById('review-category').textContent = feedbackForm.category.value;
    document.getElementById('review-lunarBirthday').textContent = feedbackForm.lunarBirthday.value;
    document.getElementById('review-birthTime').textContent = feedbackForm.birthTime.value;
    document.getElementById('review-phone').textContent = feedbackForm.phone.value;
    document.getElementById('review-address').textContent = feedbackForm.address.value;
    document.getElementById('review-content').textContent = feedbackForm.content.value;
    
    agreeCheckbox.checked = false;
    confirmSubmitBtn.disabled = true;

    formModal.classList.remove('is-visible');
    reviewModal.classList.add('is-visible');
  });

  // --- 5. 點擊「返回修改」 ---
  backToEditBtn.addEventListener('click', () => {
    reviewModal.classList.remove('is-visible');
    formModal.classList.add('is-visible');
  });

  // --- 6. 同意條款連動送出按鈕 ---
  agreeCheckbox.addEventListener('change', () => {
    confirmSubmitBtn.disabled = !agreeCheckbox.checked;
  });

  // --- 7. 最終送出 (Call API) ---
  confirmSubmitBtn.addEventListener('click', async () => {
    confirmSubmitBtn.disabled = true;
    confirmSubmitBtn.textContent = '送出中...';

    const payload = {
      realName: feedbackForm.realName.value.trim(),
      nickname: feedbackForm.nickname.value.trim(),
      category: [feedbackForm.category.value],
      content: feedbackForm.content.value.trim(),
      lunarBirthday: feedbackForm.lunarBirthday.value.trim(),
      birthTime: feedbackForm.birthTime.value,
      address: feedbackForm.address.value.trim(),
      phone: feedbackForm.phone.value.trim(),
      agreed: true 
    };

    try {
      const res = await fetch('/api/feedback', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(payload)
      });
      
      if (!res.ok) {
          let errorMessage;
          try {
              const errorData = await res.json();
              errorMessage = errorData.error || '送出失敗';
          } catch {
              errorMessage = await res.text() || '發生未知錯誤';
          }
          throw new Error(errorMessage);
      }

      alert('送出成功！待審核後將刊登。');
      reviewModal.classList.remove('is-visible');
      feedbackForm.reset(); 
      goToReviewBtn.disabled = true; 
      
      showFormBtn.style.zIndex = '900';
      showFormBtn.style.opacity = '1';

    } catch (err) {
      alert(err.message);
    } finally {
        confirmSubmitBtn.textContent = '確認送出';
    }
  });

  // --- 8. UI 控制 ---
  showFormBtn.addEventListener('click', e => {
    e.preventDefault();
    formModal.classList.add('is-visible');
    showFormBtn.style.zIndex = '-1'; 
    showFormBtn.style.opacity = '0';
  });

  document.querySelectorAll('.modal-close-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      formModal.classList.remove('is-visible');
      reviewModal.classList.remove('is-visible');
      showFormBtn.style.zIndex = '900';
      showFormBtn.style.opacity = '1';
    });
  });
  
  [formModal, reviewModal].forEach(modal => {
      modal.addEventListener('click', e => {
          if (e.target === modal) {
              modal.classList.remove('is-visible');
              showFormBtn.style.zIndex = '900';
              showFormBtn.style.opacity = '1';
          }
      });
  });

  fetchAndRenderFeedback();
});
</script>
{% endblock %}
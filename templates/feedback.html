{% extends "base.html" %}

{% block title %}承天中承府 - 信徒回饋{% endblock %}

{% block content %}
<style>
    /* --- 本頁專屬樣式 --- */
    .feedback-page-wrapper {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
        position: relative;
        font-family: 'Noto Sans TC', sans-serif;
    }
    .feedback-header {
        text-align: center;
        margin-bottom: 40px;
    }

    /* 列表卡片樣式 */
    .feedback-card {
        border: 2px solid #E6BA67;
        border-radius: 30px;
        padding: 20px 24px;
        margin: 0 auto 25px auto;
        max-width: 600px;
        background: #FFF;
    }
    .feedback-card__header {
        margin: 0 0 12px 0;
        font-size: 22px;
        font-weight: bold;
        color: #C48945;
        line-height: 1.3;
    }
    .feedback-card__content {
        font-size: 16px;
        line-height: 1.9;
        color: #555;
        white-space: pre-wrap;
        word-break: break-word; /* 防止長文字爆版 */
    }

    /* 浮動按鈕 (電腦版) */
    .feedback-floating-btn {
        position: fixed;
        top: 50%;
        right: 0;
        transform: translateY(-50%);
        z-index: 900;
        cursor: pointer;
        transition: transform 0.2s, opacity 0.3s;
        width: 210px;
    }
    .feedback-floating-btn img { width: 100%; height: auto; display: block; }
    .feedback-floating-btn:hover { transform: translateY(-50%) scale(1.05); }

    /* 手機版浮動按鈕 */
    @media (max-width: 768px) {
        .feedback-floating-btn {
            width: 130px;
            top: auto;
            bottom: 90px;
            transform: none;
        }
        .feedback-floating-btn:hover { transform: scale(1.05); }
    }

    /* --- Modal 共用樣式 --- */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 1000;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.is-visible { display: flex; }
    
    .modal-content {
        background: #F3F0EC; 
        padding: 30px; 
        border-radius: 15px;
        position: relative;
        max-height: 90vh; 
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 600px; /* 表單變簡單了，寬度可以縮小 */
    }
    
    .modal-close-btn {
        position: absolute; top: 15px; right: 15px; background: #C48945;
        border: 1px solid #D9B88A; border-radius: 50%; width: 35px; height: 35px;
        color: white; font-size: 20px; line-height: 35px; text-align: center;
        cursor: pointer; padding: 0;
    }

    /* 表單樣式 */
    .form-fieldset { 
        padding: 20px 18px; 
        border-radius: 20px; 
        border: 2px solid #E6BA67; 
        background: #fff; 
        margin-bottom: 20px;
    }
    
    .form-fieldset label, .single-choice p { display: block; margin-bottom: 12px; font-size: 15px; font-weight: bold; }
    .form-fieldset input[type=text], .form-fieldset textarea { 
        width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 10px; font-size: 15px; box-sizing: border-box; margin-top: 5px;
    }
    .single-choice label { margin-right: 15px; font-weight: normal; display: inline-block; cursor: pointer; }
    
    .btn-primary { 
        width: 100%; display: block; 
        background: #C48945; color: #fff; font-size: 17px; font-weight: bold; 
        border: none; border-radius: 25px; padding: 12px 0; cursor: pointer; 
        box-shadow: 0 4px 10px rgba(0,0,0,.15); transition: opacity .2s; 
    }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; background: #999; box-shadow: none;}
</style>

<main class="feedback-page-wrapper">
    <div class="feedback-header">
        <h2 class="section-title">信徒回饋</h2>
    </div>

    <a href="#" id="show-feedback-form-btn" class="feedback-floating-btn">
        <img src="{{ url_for('static', filename='images/pages/feedback/new.png') }}" alt="我要回饋">
    </a>

    <div id="feedback-list-container">
        </div>
</main>

<div id="feedback-form-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        
        <div id="login-section" style="text-align: center; padding: 40px 20px; background: #fffcf5; border-radius: 12px; margin: 20px 0;">
            <h3 style="color: #C48945; margin-bottom: 15px;">請先綁定 LINE 繼續操作</h3>
            <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                系統將自動綁定您的專屬會員紀錄。<br>
                未來使用服務將自動帶入寄送資訊，無需重複填寫。
            </p>
            <a href="/api/line/login?next=/feedback" style="background-color: #06C755; color: white; padding: 12px 30px; border-radius: 50px; text-decoration: none; font-weight: bold; font-size: 16px; display: inline-flex; align-items: center; box-shadow: 0 4px 10px rgba(6,199,85,0.3);">
                <img src="{{ url_for('static', filename='images/icons/footer-line.png') }}" alt="LINE" style="width: 24px; margin-right: 10px; filter: brightness(0) invert(1);">
                使用 LINE 登入
            </a>
        </div>

        <div id="profile-warning-section" style="display: none; text-align: center; padding: 30px 20px; background: #fff3cd; border: 2px solid #ffeeba; border-radius: 15px; margin: 20px 0;">
            <h3 style="color: #856404; margin-top: 0;">⚠️ 尚未完善會員資料</h3>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                為了在文章刊登後能順利將「小神衣」等結緣品寄送給您，<br>請先至個人專區填寫您的<strong>收件地址與聯絡電話</strong>。
            </p>
            <a href="/profile" class="btn-primary" style="text-decoration: none; display: inline-block; width: auto; padding: 10px 30px;">前往填寫資料</a>
        </div>

        <div id="feedback-form-section" style="display: none;">
            <form id="feedback-form">
                <h2 style="color: #C48945; text-align: center; margin-top: 0; margin-bottom: 20px;">分享我的故事</h2>
                
                <div class="form-fieldset">
                    <label>發文暱稱 (公開顯示)：
                        <input type="text" name="nickname" required placeholder="例如：陳信徒 或 王小姐">
                    </label>
                    
                    <div class="single-choice" style="margin-top: 20px;">
                        <p>類別（擇一）：</p>
                        <label><input type="radio" name="category" value="運途" required> 運途</label>
                        <label><input type="radio" name="category" value="事業"> 事業</label>
                        <label><input type="radio" name="category" value="財運"> 財運</label>
                        <label><input type="radio" name="category" value="身體"> 身體</label>
                        <label><input type="radio" name="category" value="姻緣"> 姻緣</label>
                        <label><input type="radio" name="category" value="收驚"> 收驚</label>
                        <label><input type="radio" name="category" value="其他"> 其他</label>
                    </div>

                    <label style="margin-top: 20px;">回饋內容（至少 50 字）：
                        <textarea name="content" rows="8" minlength="50" required placeholder="請分享您與元帥的故事，每一次的分享都是最珍貴的法布施..."></textarea>
                    </label>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                    <label style="cursor:pointer; display:flex; align-items:flex-start;">
                        <input type="checkbox" id="review-agreed" required style="margin-right:10px; margin-top:3px; transform: scale(1.2);">
                        <span style="line-height: 1.5;">
                            我已詳閱並同意授權上述內容供承天中承府公開刊登，並確認<a href="/profile" target="_blank" style="color: #C48945;">會員專區</a>的收件資料填寫無誤。
                        </span>
                    </label>
                </div>

                <button type="submit" id="confirm-submit-btn" class="btn-primary" disabled>確認送出</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const getCsrfToken = () => document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // --- DOM Elements ---
    const showFormBtn = document.getElementById('show-feedback-form-btn');
    const formModal = document.getElementById('feedback-form-modal');
    const loginSection = document.getElementById('login-section');
    const warningSection = document.getElementById('profile-warning-section');
    const formSection = document.getElementById('feedback-form-section');
    
    const feedbackForm = document.getElementById('feedback-form');
    const confirmBtn = document.getElementById('confirm-submit-btn');
    const agreeCheckbox = document.getElementById('review-agreed');

    // --- 1. 檢查狀態與資料完整度 ---
    fetch('/api/user/me')
        .then(res => res.json())
        .then(data => {
            if (data.logged_in) {
                const u = data.user;
                loginSection.style.display = 'none';
                
                // 檢查是否填寫了必填聯絡資料 (防呆機制)
                if (!u.realName || !u.phone || !u.address) {
                    warningSection.style.display = 'block';
                } else {
                    formSection.style.display = 'block';
                    // 自動帶入暱稱
                    if (u.nickname) feedbackForm.nickname.value = u.nickname;
                    else feedbackForm.nickname.value = u.displayName || '';
                }
            }
        })
        .catch(err => console.error('無法取得會員資料', err));

    // --- 2. 載入已刊登文章列表 ---
    function fetchAndRenderFeedback() {
        fetch('/api/feedback/approved', { credentials:'include' })
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('feedback-list-container');
                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">目前沒有已刊登的信徒回饋。</p>';
                    return;
                }
                container.innerHTML = data.map(item => {
                    const cat = Array.isArray(item.category) ? item.category.join(', ') : item.category;
                    const fbIdHtml = item.feedbackId ? `<div style="font-size: 13px; color: #aaa; margin-bottom: 5px; font-family: monospace; letter-spacing: 1px;">#${item.feedbackId}</div>` : '';
                    return `
                    <div class="feedback-card">
                        ${fbIdHtml}
                        <h3 class="feedback-card__header">${item.nickname} / ${cat}</h3>
                        <p class="feedback-card__content">${item.content.replace(/\n/g, '<br>')}</p>
                    </div>`;
                }).join('');
            })
            .catch(err => console.error('載入回饋失敗', err));
    }
    fetchAndRenderFeedback();

    // --- 3. 表單即時驗證 ---
    function checkValidity() {
        const isNickname = feedbackForm.nickname.value.trim().length > 0;
        const isCat = !!feedbackForm.category.value;
        const isContent = feedbackForm.content.value.trim().length >= 50; // 字數門檻降至 50 字
        
        confirmBtn.disabled = !(isNickname && isCat && isContent && agreeCheckbox.checked);
    }
    feedbackForm.addEventListener('input', checkValidity);
    feedbackForm.addEventListener('change', checkValidity);

    // --- 4. 直接送出表單 (移除原有的 step2) ---
    feedbackForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        confirmBtn.disabled = true;
        confirmBtn.textContent = '送出中...';

        const payload = {
            nickname: feedbackForm.nickname.value.trim(),
            category: [feedbackForm.category.value],
            content: feedbackForm.content.value.trim(),
            agreed: true 
        };

        try {
            const res = await fetch('/api/feedback', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': getCsrfToken() 
                },
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) {
                let errText = await res.text();
                throw new Error('送出失敗: ' + errText);
            }
            
            alert('感謝您的法布施！回饋已成功送出，待廟方審核後將會刊登。');
            formModal.classList.remove('is-visible');
            feedbackForm.reset();
            checkValidity(); // 重置按鈕狀態
            
        } catch (err) {
            alert(err.message);
        } finally {
            confirmBtn.textContent = '確認送出';
            confirmBtn.disabled = false;
        }
    });

    // --- 5. Modal UI 控制 ---
    showFormBtn.addEventListener('click', e => { 
        e.preventDefault(); 
        formModal.classList.add('is-visible'); 
    });
    
    document.querySelector('.modal-close-btn').addEventListener('click', () => {
        formModal.classList.remove('is-visible');
    });
    
    formModal.addEventListener('click', e => {
        if (e.target === formModal) formModal.classList.remove('is-visible');
    });
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}承天中承府 - 信徒回饋{% endblock %}

{% block content %}
<style>
    /* --- 本頁專屬樣式 (您的 CSS 都會被保留) --- */
    .feedback-page-wrapper {
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
        position: relative;
    }
    .feedback-header {
        text-align: center;
        margin-bottom: 40px;
    }
    .feedback-action-btn {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 90px;
        height: 90px;
        border-radius: 25px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: transform 0.2s ease-out;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        z-index: 997;
    }
    .feedback-action-btn:hover { transform: scale(1.05); }
    .feedback-action-btn img {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        object-fit: cover;
        z-index: 1;
    }
    .feedback-action-btn .btn-label {
        position: relative;
        z-index: 2;
        color: white;
        font-weight: bold;
        font-size: 14px;
        text-align: center;
        line-height: 1.2;
        text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        pointer-events: none;
        padding: 2px 6px;
    }
    .feedback-card{
        font-family:'Noto Sans TC', sans-serif;
        border:2px solid #E6BA67;
        border-radius:30px;
        padding:20px 24px;
        margin:0 auto 25px auto;
        max-width: 600px;
        background:#FFF;
    }
    .feedback-card__header{
        margin:0 0 12px 0;
        font-size:22px;
        font-weight:bold;
        color:#C48945;
        line-height:1.3;
    }
    .feedback-card__content{
        font-size:16px;
        line-height:1.9;
        color:#555;
        white-space:pre-wrap;
        word-break:break-all;
    }
    .feedback-form-modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 1000;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
    }
    .feedback-form-modal.is-visible { display: flex; }
    .feedback-form-content {
        background: #F3F0EC; padding: 30px; border-radius: 15px;
        width: 90%; max-width: 600px; position: relative;
        max-height:90vh; overflow-y:auto;
    }
    .modal-close-btn {
        position: absolute; top: 15px; right: 15px; background: #C48945;
        border: 1px solid #D9B88A; border-radius: 50%; width: 35px; height: 35px;
        color: white; font-size: 20px; line-height: 35px; text-align: center;
        cursor: pointer; padding: 0;
    }
    .feedback-note{ line-height:1.7; letter-spacing:.05em; text-align:left; margin-bottom:18px; }
    .feedback-note strong{ display:block; font-size:clamp(18px,4vw,22px); color:#C48945; margin:0 0 8px 0; }
    .form-fieldset{ padding:20px 18px; border-radius:35px; border:2px solid #E6BA67; background:rgba(255,255,255,.50); box-shadow:0 0 5px rgba(255,255,255,.50) inset; backdrop-filter:blur(7.5px); }
    .form-fieldset label, .single-choice{display:block;margin-bottom:12px;font-size:15px;}
    .form-fieldset input[type=text], .form-fieldset input[type=tel], .form-fieldset textarea{ width:100%;border:1px solid #ccc;border-radius:6px;padding:6px 8px; font-size:15px;box-sizing:border-box; }
    .single-choice label{margin-right:10px;font-weight:normal;}
    .agree-box{display:block;margin:15px 0;font-size:14px;line-height:1.6;}
    .btn-primary{ width:100%;max-width:200px;margin:0 auto;display:block; background:#C48945;color:#fff;font-size:17px;font-weight:bold; border:none;border-radius:25px;padding:10px 0;cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.15); transition:opacity .2s; }
    .btn-primary:disabled{opacity:.45;cursor:not-allowed;}
</style>

<main class="feedback-page-wrapper">
    <div class="feedback-header">
        <h2 class="section-title">信徒回饋</h2>
    </div>

    <a href="#" id="show-feedback-form-btn" class="feedback-action-btn" aria-label="打開回饋表單">
        <img src="{{ url_for('static', filename='images/avatars/feedbackavator.png') }}" alt="" aria-hidden="true" loading="lazy">
        <span class="btn-label">我要回饋</span>
    </a>

    <div id="feedback-list-container">
        </div>
</main>

<div id="feedback-form-modal" class="feedback-form-modal">
    <div class="feedback-form-content">
        <button class="modal-close-btn">&times;</button>
        <form id="feedback-form" class="feedback-create-form">
            <h2 class="section-title" style="margin-top:0">我要回饋</h2>
            <p class="feedback-note">
                <strong>一份善緣，一份心意</strong><br>
                每一份感動、每一次在生活中受到的護佑，都是元帥慈悲的珍貴見證。<br>
                1. 回饋內容送出後，視為同意授權公開刊登於本府網站。<br>
                2. 回饋將於通過審核後方能刊登，敬請耐心等候。<br>
                3. 未經審核通過者恕不另行通知與回覆。<br>
                4. 個人資料僅用於寄送贈品與必要聯繫，不作其他用途，敬請安心填寫。<br>
                5. 平安符須由元帥娘親自審核與開符，故每位信眾僅限領取乙份。
            </p>
            <div class="form-fieldset">
                <label>真實姓名：<input type="text" name="realName" required></label>
                <label>暱稱：<input type="text" name="nickname" required></label>
                <div class="single-choice">
                    <p>類別（擇一）：</p>
                    <label><input type="radio" name="category" value="運途" required> 運途</label>
                    <label><input type="radio" name="category" value="事業"> 事業</label>
                    <label><input type="radio" name="category" value="財運"> 財運</label>
                    <label><input type="radio" name="category" value="身體"> 身體</label>
                    <label><input type="radio" name="category" value="姻緣"> 姻緣</label>
                    <label><input type="radio" name="category" value="收驚"> 收驚</label>
                    <label><input type="radio" name="category" value="其他"> 其他</label>
                </div>
                <label>回饋內容（至少 100 字）：<textarea name="content" rows="6" minlength="100" required></textarea></label>
                <label>寄件地址：<input type="text" name="address"></label>
                <label>聯絡電話：<input type="tel" name="phone"></label>
            </div>
            <label class="agree-box">
                <input type="checkbox" name="agreed" required>
                我已詳閱並同意上述授權與注意事項，並願意提供回饋供本府公開刊登。
            </label>
            <button type="submit" id="submit-feedback-btn" class="btn-primary" disabled>提交回饋</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const getCsrfToken = () => document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const feedbackListContainer = document.getElementById('feedback-list-container');
  const showFormBtn = document.getElementById('show-feedback-form-btn');
  const formModal = document.getElementById('feedback-form-modal');
  const feedbackForm = document.getElementById('feedback-form');
  const submitBtn = document.getElementById('submit-feedback-btn');

  async function fetchAndRenderFeedback() {
    try {
      // 【優化】加上 credentials:'include'，確保未來跨域部署時 cookie 能正常傳送
      const res = await fetch('/api/feedback/approved', { credentials:'include' });
      if (!res.ok) throw new Error('讀取回饋資料失敗');
      const data = await res.json();
      
      feedbackListContainer.innerHTML = '';
      if (data.length === 0) {
        feedbackListContainer.innerHTML = '<p style="text-align:center;">目前沒有已刊登的信徒回饋。</p>';
        return;
      }
      
      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'feedback-card';
        
        // 【優化】處理 nickname 和 category 可能為空的情況
        const nickname = item.nickname || '匿名';
        const category = Array.isArray(item.category) ? item.category.join(', ') : '';

        // 【安全修正】防止 XSS 攻擊，先用 textContent 轉義，再處理換行
        const header = document.createElement('h3');
        header.className = 'feedback-card__header';
        header.innerHTML = `<span class="nickname">${nickname}</span> / ${category}`;

        const content = document.createElement('p');
        content.className = 'feedback-card__content';
        content.textContent = item.content; // 1. 先用 textContent 安全地插入純文字
        content.innerHTML = content.innerHTML.replace(/\n/g, '<br>'); // 2. 再將純文字中的換行符轉為 <br>

        card.appendChild(header);
        card.appendChild(content);
        feedbackListContainer.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      feedbackListContainer.innerHTML = '<p style="text-align:center;">讀取資料時發生錯誤，請稍後再試。</p>';
    }
  }

  showFormBtn.addEventListener('click', e => {
    e.preventDefault();
    formModal.classList.add('is-visible');
  });

  formModal.addEventListener('click', e => {
    if (e.target.classList.contains('modal-close-btn') || e.target.id === 'feedback-form-modal') {
      formModal.classList.remove('is-visible');
    }
  });

  feedbackForm.addEventListener('input', () => {
    const isContentOk = feedbackForm.content.value.trim().length >= 100;
    const isAgreed = feedbackForm.agreed.checked;
    submitBtn.disabled = !(isContentOk && isAgreed);
  });

  feedbackForm.addEventListener('submit', async e => {
    e.preventDefault();
    submitBtn.disabled = true;
    const payload = {
      realName: feedbackForm.realName.value.trim(),
      nickname: feedbackForm.nickname.value.trim(),
      category: [feedbackForm.category.value],
      content: feedbackForm.content.value.trim(),
      address: feedbackForm.address.value.trim(),
      phone: feedbackForm.phone.value.trim(),
      agreed: feedbackForm.agreed.checked
    };

    try {
      const res = await fetch('/api/feedback', {
        method: 'POST',
        credentials: 'include', // ★ 確保 cookie 與 CSRF token 一同發送
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(payload)
      });
      
      // 【優化】更穩固的錯誤處理
      if (!res.ok) {
          let errorMessage;
          try {
              const errorData = await res.json();
              errorMessage = errorData.error || '送出失敗';
          } catch {
              errorMessage = await res.text() || '發生未知錯誤';
          }
          throw new Error(errorMessage);
      }

      alert('送出成功！待審核後將刊登。');
      formModal.classList.remove('is-visible');
      feedbackForm.reset();
      submitBtn.disabled = true;
    } catch (err) {
      alert(err.message);
      submitBtn.disabled = false;
    }
  });

  fetchAndRenderFeedback();
});
</script>
{% endblock %}
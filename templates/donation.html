{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - è­·æŒå…¬å£‡{% endblock %}

{% block content %}
<style>
    /* === é ‚éƒ¨è¦–è¦º Hero === */
    .donation-hero {
        background: url('{{ url_for("static", filename="images/pages/index/banner_PC.png") }}') no-repeat center center/cover;
        height: 60vh;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
        text-align: center;
    }
    .donation-hero::before {
        content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.5);
    }
    .hero-text { position: relative; z-index: 2; padding: 20px; }
    .hero-text h1 { font-family: 'KouzanBrushFontOTF', serif; font-size: 3.5rem; margin-bottom: 10px; text-shadow: 2px 2px 5px rgba(0,0,0,0.7); }
    .hero-text p { font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }

    /* === å…§å®¹å€å¡Š === */
    .donation-container {
        max-width: 1100px; margin: -50px auto 50px auto;
        background: #fff; border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        position: relative; z-index: 3;
        padding: 40px;
        border-top: 5px solid #C48945;
    }

    /* === 1. ç†å¿µå€ === */
    .concept-section { text-align: center; margin-bottom: 50px; }
    .concept-section h2 { color: #8B4513; margin-bottom: 20px; font-size: 2rem; position: relative; display: inline-block; }
    .concept-section h2::after { content:''; display:block; width: 60px; height: 3px; background: #C48945; margin: 10px auto 0 auto; }
    .concept-text { font-size: 1.1rem; line-height: 1.8; color: #555; max-width: 800px; margin: 0 auto; }
    .concept-highlight { color: #C48945; font-weight: bold; background: #fffcf5; padding: 15px; border-radius: 10px; border: 1px dashed #C48945; margin-top: 20px; }

    /* === 2. èŠ³åéŒ„å€ (Marquee) - ä¿®æ”¹ç‚ºç´…åº• === */
    .honor-roll-section {
        background: #8B0000; /* â˜… æ”¹ç‚ºæ·±ç´…è‰² */
        color: #FFD700; /* é‡‘è‰²å­—é«” */
        padding: 20px;
        border-radius: 10px; margin-bottom: 40px;
        display: flex; align-items: center; gap: 20px;
        overflow: hidden;
        border: 2px solid #B22222;
        box-shadow: 0 4px 10px rgba(139, 0, 0, 0.3);
    }
    .honor-title { font-size: 1.5rem; font-weight: bold; writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 5px; border-left: 2px solid #FFD700; padding-left: 10px; flex-shrink: 0; }
    
    .marquee-container { flex: 1; height: 150px; overflow: hidden; position: relative; }
    .marquee-content { position: absolute; width: 100%; animation: scrollUp 20s linear infinite; }
    .donor-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ffb3b3; font-size: 1.1rem; }
    
    @keyframes scrollUp {
        0% { top: 100%; }
        100% { top: -200%; } 
    }

    /* === 3. å±•é–‹æŒ‰éˆ•å€ (CTA) === */
    .cta-container { text-align: center; margin: 40px 0; }
    .btn-cta-show {
        background: linear-gradient(135deg, #C48945, #d69d58);
        color: #fff; font-size: 1.5rem; padding: 15px 50px;
        border: none; border-radius: 50px; cursor: pointer;
        box-shadow: 0 4px 15px rgba(196, 137, 69, 0.4);
        transition: 0.3s; font-weight: bold;
        animation: pulse 2s infinite;
    }
    .btn-cta-show:hover { transform: scale(1.05); }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(196, 137, 69, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(196, 137, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(196, 137, 69, 0); }
    }

    /* === 4. éš±è—çš„è¡¨å–®æ“ä½œå€ === */
    #donation-action-area { display: none; /* é è¨­éš±è— */ }

    .donation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .donation-card {
        border: 1px solid #eee; border-radius: 10px; overflow: hidden;
        transition: 0.3s; position: relative; cursor: pointer;
    }
    .donation-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(196, 137, 69, 0.2); border-color: #C48945; }
    .donation-card.selected { border: 2px solid #C48945; background: #fffcf5; }
    
    .d-img { width: 100%; height: 200px; object-fit: cover; background: #eee; }
    .d-info { padding: 15px; text-align: center; }
    .d-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
    .d-price { color: #C48945; font-size: 1.1rem; font-weight: bold; }
    .check-mark { position: absolute; top: 10px; right: 10px; background: #C48945; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; }
    .donation-card.selected .check-mark { display: flex; }

    /* === è¡¨å–®å€ === */
    .form-section { background: #f9f9f9; padding: 30px; border-radius: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
    .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    
    .btn-submit {
        background: #C48945; color: #fff; width: 100%; padding: 15px;
        border: none; border-radius: 50px; font-size: 1.3rem; font-weight: bold;
        cursor: pointer; transition: 0.3s; margin-top: 20px;
    }
    .btn-submit:hover { background: #a06d35; transform: scale(1.02); }

    /* æ‰‹æ©Ÿç‰ˆ RWD */
    @media (max-width: 768px) {
        .donation-hero { height: 40vh; }
        .hero-text h1 { font-size: 2.2rem; }
        .donation-container { margin-top: 0; border-radius: 0; padding: 20px; }
        .donation-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
        .d-img { height: 150px; }
        .donor-item { font-size: 0.9rem; }
    }
</style>

<div class="donation-hero">
    <div class="hero-text">
        <h1>è­·æŒå…¬å£‡ â€§ é¦™ç«å‚³é</h1>
        <p>æ‚¨çš„æ¯ä¸€ä»½å¿ƒæ„ï¼Œéƒ½å°‡åŒ–ä½œä¸Šé”å¤©è½çš„ç¸·ç¸·æ¸…é¦™</p>
    </div>
</div>

<div class="donation-container">
    <div class="concept-section">
        <h2>å…±é€ ç¦ç”° â€§ å»£çµå–„ç·£</h2>
        <div class="concept-text">
            <p>æ‰¿å¤©ä¸­æ‰¿åºœçš„ã€Œå…¬å£‡ã€ï¼Œæ˜¯å…ƒå¸¥ç‚ºä¿¡å¾’è§£æƒ‘ã€å®‰æ’«å¿ƒéˆçš„æ‰€åœ¨ã€‚æ¯ä¸€æ¬¡çš„é–‹å£‡è¾¦äº‹ï¼Œéƒ½éœ€è¦ä½¿ç”¨å¤§é‡çš„é¦™å“èˆ‡ç‰©è³‡ã€‚</p>
            <p><strong>ã€Œæé¦™ã€</strong>ï¼Œä¸åƒ…æ˜¯ç‰©è³ªä¸Šçš„æ”¯æŒï¼Œæ›´æ˜¯ä¸€ä»½<strong>å®ˆè­·çš„æ‰¿è«¾</strong>ã€‚æ‚¨æ‰€æç»çš„æ¯ä¸€æŸ±é¦™ï¼Œéƒ½å°‡åœ¨å…¬å£‡è¾¦äº‹æ™‚é»ç‡ƒï¼Œå”åŠ©å…ƒå¸¥åŸ·è¡Œè–å‹™ã€‚</p>
            <div class="concept-highlight">
                ğŸ™ æ‚¨çš„å¿ƒæ„ï¼Œå…ƒå¸¥éƒ½çŸ¥é“<br>
                å‡¡åƒèˆ‡æé¦™ä¹‹ä¿¡å¾’ï¼Œæˆ‘å€‘å°‡æ–¼ä¸‹ä¸€æ¬¡å…¬å£‡è¾¦äº‹æ™‚ï¼Œ<br>
                ç”±åŸ·äº‹äººå“¡å°‡æ‚¨çš„å§“åèˆ‡ç¥ˆé¡˜ï¼Œå®Œæ•´å‘ç…™å³¶å…ƒå¸¥ç¨Ÿå ±ã€‚
            </div>
        </div>
    </div>

    <div class="honor-roll-section">
        <div class="honor-title">æè´ˆèŠ³åéŒ„</div>
        <div class="marquee-container">
            <div class="marquee-content" id="honor-list">
                <div style="padding:10px; text-align:center; color:#FFD700;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <div class="cta-container" id="cta-block">
        <button class="btn-cta-show" onclick="showDonationForm()">ğŸ™‹ æˆ‘ä¹Ÿè¦æé¦™</button>
    </div>

    <div id="donation-action-area">
        <form id="donation-form">
            <h3 style="border-left: 5px solid #C48945; padding-left: 10px; margin-bottom: 20px;">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡æè´ˆé …ç›®</h3>
            <div class="donation-grid" id="donation-grid">
                </div>

            <h3 style="border-left: 5px solid #C48945; padding-left: 10px; margin-bottom: 20px; margin-top: 40px;">ç¬¬äºŒæ­¥ï¼šå¡«å¯«ç¥ˆç¦è³‡æ–™</h3>
            <div class="form-section">
                <p style="color:red; font-size:0.9rem; margin-bottom:15px;">â€» æ­¤ç‚ºä»£æé …ç›®ï¼Œä¸æœƒå¯„é€å¯¦é«”å•†å“</p>
                
                <div class="form-group"><label>ä¿¡å£«å§“å</label><input type="text" name="name" class="form-control" required placeholder="è«‹å¡«å¯«çœŸå¯¦å§“å"></div>
                <div class="form-group"><label>è¯çµ¡é›»è©±</label><input type="tel" name="phone" class="form-control" required></div>
                <div class="form-group"><label>é›»å­ä¿¡ç®± (æ¥æ”¶é›»å­æ„Ÿè¬ç‹€)</label><input type="email" name="email" class="form-control" required></div>
                <div class="form-group"><label>æ”¶ä»¶åœ°å€</label><input type="text" name="address" class="form-control" required></div>
                <div class="form-group"><label>è¾²æ›†ç”Ÿæ—¥ (æ ¼å¼ï¼š68å¹´ 5æœˆ 5æ—¥)</label><input type="text" name="lunarBirthday" class="form-control" placeholder="ä¾‹ï¼š75å¹´ 8æœˆ 15æ—¥ å‰æ™‚"></div>
                <div class="form-group"><label>åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label><input type="text" name="last5" class="form-control" maxlength="5" required></div>
                
                <div style="text-align:right; font-size:1.5rem; font-weight:bold; color:#C48945; margin: 20px 0;">
                    ç¸½æè´ˆé‡‘é¡ï¼šNT$ <span id="total-amount">0</span>
                </div>

                <button type="submit" class="btn-submit">ç¢ºèªæè´ˆä¸¦é€å‡º</button>
            </div>
        </form>
    </div>
</div>

<div id="success-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:30px; border-radius:10px; text-align:center; max-width:400px; width:90%;">
        <h2 style="color:#C48945;">åŠŸå¾·ç„¡é‡ ğŸ™</h2>
        <p>æ‚¨çš„æè´ˆè¨‚å–®å·²é€å‡ºã€‚</p>
        <p>è«‹æ–¼ 2 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ï¼Œ<br>æˆ‘å€‘æ ¸å°å¾Œå°‡æœƒå¯„å‡ºé›»å­æ„Ÿè¬ç‹€ã€‚</p>
        <button onclick="location.href='{{ url_for('home') }}'" style="background:#C48945; color:#fff; padding:10px 30px; border:none; border-radius:5px; cursor:pointer; margin-top:20px;">å›é¦–é </button>
    </div>
</div>

<script>
    let donationItems = []; // å­˜è³¼ç‰©è»Š
    
    document.addEventListener('DOMContentLoaded', () => {
        loadMarquee();
        loadProducts();
    });

    // å±•é–‹è¡¨å–®åŠŸèƒ½
    function showDonationForm() {
        const area = document.getElementById('donation-action-area');
        const btnBlock = document.getElementById('cta-block');
        
        btnBlock.style.display = 'none'; // éš±è—æŒ‰éˆ•
        area.style.display = 'block'; // é¡¯ç¤ºè¡¨å–®
        
        // å¹³æ»‘æ»¾å‹•åˆ°è¡¨å–®å€åŸŸ
        area.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 1. è¼‰å…¥èŠ³åéŒ„
    function loadMarquee() {
        fetch('/api/donations/public')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('honor-list');
                if(data.length === 0) {
                    list.innerHTML = '<div style="text-align:center; padding:10px; color:#FFD700;">ç›®å‰å°šç„¡æè´ˆç´€éŒ„ï¼Œæ­¡è¿æˆç‚ºç¬¬ä¸€ä½è­·æŒè€…ï¼</div>';
                    return;
                }
                const html = data.map(d => `
                    <div class="donor-item">
                        <span>${d.name}</span>
                        <span>${d.items}</span>
                    </div>
                `).join('');
                
                list.innerHTML = html + html; 
            });
    }

    // 2. è¼‰å…¥æè´ˆå•†å“
    function loadProducts() {
        fetch('/api/products')
            .then(res => res.json())
            .then(products => {
                // éæ¿¾ isDonation ç‚º true çš„å•†å“
                const donations = products.filter(p => p.isDonation === true && p.isActive);
                const grid = document.getElementById('donation-grid');
                
                if(donations.length === 0) {
                    grid.innerHTML = '<p>ç›®å‰æ²’æœ‰é–‹æ”¾çš„æè´ˆé …ç›®ã€‚</p>';
                    return;
                }

                grid.innerHTML = donations.map(p => `
                    <div class="donation-card" onclick="toggleItem('${p._id}', '${p.name}', ${p.price}, this)">
                        <div class="check-mark">âœ”</div>
                        <img src="${p.image || '/static/images/common/default_product.png'}" class="d-img" onerror="this.src='/static/images/common/default_product.png'">
                        <div class="d-info">
                            <div class="d-title">${p.name}</div>
                            <div class="d-price">è­·æŒé‡‘ NT$ ${p.price}</div>
                        </div>
                    </div>
                `).join('');
            });
    }

    window.toggleItem = (id, name, price, cardEl) => {
        const idx = donationItems.findIndex(x => x.id === id);
        
        if (idx > -1) {
            donationItems.splice(idx, 1);
            cardEl.classList.remove('selected');
        } else {
            donationItems.push({ id, name, price, qty: 1 });
            cardEl.classList.add('selected');
        }
        updateTotal();
    };

    function updateTotal() {
        const total = donationItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
        document.getElementById('total-amount').textContent = total;
    }

    // 3. é€å‡ºè¡¨å–® (å·²ç§»é™¤ prayer)
    document.getElementById('donation-form').onsubmit = async (e) => {
        e.preventDefault();
        if (donationItems.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æè´ˆé …ç›®');
        
        const f = e.target;
        const total = parseInt(document.getElementById('total-amount').textContent);
        
        const payload = {
            orderType: 'donation', 
            name: f.name.value,
            phone: f.phone.value,
            email: f.email.value,
            address: f.address.value,
            lunarBirthday: f.lunarBirthday.value,
            last5: f.last5.value,
            items: donationItems,
            total: total
        };

        const btn = f.querySelector('.btn-submit');
        btn.disabled = true; btn.textContent = "è™•ç†ä¸­...";

        try {
            const res = await fetch('/api/orders', {
                method:'POST',
                headers:{'Content-Type':'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content},
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if(result.success) {
                document.getElementById('success-modal').style.display = 'flex';
            } else {
                alert('éŒ¯èª¤: ' + result.message);
                btn.disabled = false; btn.textContent = "ç¢ºèªæè´ˆä¸¦é€å‡º";
            }
        } catch(err) {
            alert('é€å‡ºå¤±æ•—');
            btn.disabled = false; btn.textContent = "ç¢ºèªæè´ˆä¸¦é€å‡º";
        }
    };
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - è­·æŒå…¬å£‡{% endblock %}

{% block content %}
<style>
    /* === é ‚éƒ¨è¦–è¦º Hero === */
    .donation-hero {
        background: url('{{ url_for("static", filename="images/pages/gongtan/signuppic.jpg") }}') no-repeat center center/cover;
        height: 60vh;
        position: relative; display: flex; justify-content: center; align-items: center; color: #fff; text-align: center;
    }
    .donation-hero::before { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); }
    .hero-text { position: relative; z-index: 2; padding: 20px; }
    .hero-text h1 { font-family: 'KouzanBrushFontOTF', serif; font-size: 3.5rem; margin-bottom: 10px; text-shadow: 2px 2px 5px rgba(0,0,0,0.7); }
    .hero-text p { font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }

    /* === å…§å®¹å€å¡Š === */
    .donation-container {
        max-width: 1100px; margin: -50px auto 50px auto; background: #fff; border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; z-index: 3; padding: 40px;
        border-top: 5px solid #C48945;
    }

    /* === 1. ç†å¿µå€ === */
    .concept-section { text-align: center; margin-bottom: 40px; }
    .concept-section h2 { color: #8B4513; margin-bottom: 20px; font-size: 2rem; position: relative; display: inline-block; }
    .concept-section h2::after { content:''; display:block; width: 60px; height: 3px; background: #C48945; margin: 10px auto 0 auto; }
    .concept-text { font-size: 1.1rem; line-height: 1.8; color: #555; max-width: 800px; margin: 0 auto; }
    .concept-highlight { color: #C48945; font-weight: bold; background: #fffcf5; padding: 15px; border-radius: 10px; border: 1px dashed #C48945; margin-top: 20px; }

    /* === 2. èŠ³åéŒ„å€ (è¦–è¦ºå‡ç´šï¼šç´…åº•é‡‘ç·š) === */
    .honor-roll-section {
        background: #8B0000; /* å®®å»Ÿæ·±ç´… */
        background-image: linear-gradient(180deg, #9E2A2B 0%, #800000 100%);
        color: #FFD700; /* é‡‘è‰²å­—é«” */
        padding: 20px; 
        border-radius: 12px; 
        margin-bottom: 40px;
        display: flex; align-items: center; gap: 20px;
        overflow: hidden;
        /* é‡‘è‰²é›™ç·šé‚Šæ¡†è£é£¾ */
        border: 4px double #FFD700;
        box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
    }
    .honor-title { 
        font-size: 1.5rem; font-weight: bold; writing-mode: vertical-rl; text-orientation: upright; 
        letter-spacing: 5px; 
        border-left: 3px solid #FFD700; /* å·¦å´é‡‘ç·š */
        padding-left: 15px; flex-shrink: 0; 
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .marquee-container { flex: 1; height: 150px; overflow: hidden; position: relative; }
    .marquee-content { position: absolute; width: 100%; animation: scrollUp 30s linear infinite; }
    
    /* èŠ³åéŒ„é …ç›® (é‡‘è‰²åˆ†éš”ç·š) */
    .donor-item { 
        display: flex; justify-content: space-between; padding: 10px 5px; 
        border-bottom: 1px dashed rgba(255, 215, 0, 0.5); 
        font-size: 1.1rem; 
    }
    .donor-item span:first-child { font-weight: bold; }
    
    @keyframes scrollUp {
        0% { top: 100%; }
        100% { top: -200%; }
    }

    /* === å•Ÿå‹•æŒ‰éˆ• (CTA) === */
    .cta-container { text-align: center; margin: 30px 0; }
    .start-donate-btn {
        background: linear-gradient(45deg, #C48945, #FFD700); 
        color: #fff; padding: 15px 50px; font-size: 22px; border-radius: 50px;
        border: 2px solid #fff; cursor: pointer; transition: 0.3s; 
        box-shadow: 0 4px 15px rgba(196, 137, 69, 0.4);
        display: inline-flex; align-items: center; gap: 10px; font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .start-donate-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(196, 137, 69, 0.6); }

    /* === æè´ˆæµç¨‹åœ– (Flowchart) === */
    .process-flow-wrapper {
        margin-bottom: 40px;
        padding: 20px 0;
        border-bottom: 1px dashed #ddd;
    }
    .process-flow {
        display: flex; justify-content: space-between; align-items: flex-start;
        position: relative; max-width: 900px; margin: 0 auto;
    }
    /* é€£æ¥ç·š */
    .process-flow::before {
        content: ''; position: absolute; top: 25px; left: 5%; width: 90%; height: 2px; background: #e0e0e0; z-index: 0;
    }
    .p-step { position: relative; z-index: 1; text-align: center; flex: 1; padding: 0 5px; }
    .p-icon {
        width: 50px; height: 50px; background: #fffcf5; border: 2px solid #C48945; border-radius: 50%;
        margin: 0 auto 10px auto; display: flex; justify-content: center; align-items: center;
        font-weight: bold; color: #C48945; font-size: 1.2rem; 
        box-shadow: 0 0 0 5px #fff; /* ç”¨ç™½è‰²é™°å½±é®æ“‹æ©«ç·š */
    }
    .p-text { font-size: 1rem; color: #333; font-weight: bold; line-height: 1.4; }
    .p-desc { font-size: 0.85rem; color: #777; margin-top: 5px; line-height: 1.4; }

    /* === æè´ˆè¡¨å–®å€åŸŸ (é è¨­éš±è—) === */
    #donation-process-area { display: none; opacity: 0; transition: opacity 0.5s ease; }
    #donation-process-area.show { display: block; opacity: 1; }

    /* === 3. æè´ˆé …ç›®å¡ç‰‡ === */
    .donation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .donation-card {
        border: 1px solid #eee; border-radius: 10px; overflow: hidden;
        transition: 0.3s; position: relative; background: #fff; display: flex; flex-direction: column;
    }
    .donation-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(196, 137, 69, 0.2); }
    .donation-card.active { border: 2px solid #C48945; background: #fffcf5; box-shadow: 0 0 10px rgba(196, 137, 69, 0.3); }
    
    .d-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
    .d-info { padding: 15px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .d-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; color: #333; }
    .d-price { color: #C48945; font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; }
    
    /* æ•¸é‡æ§åˆ¶å™¨ */
    .qty-control { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
    .qty-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 18px; color: #555; transition: 0.2s; display: flex; justify-content: center; align-items: center; }
    .qty-btn:hover { background: #C48945; color: #fff; border-color: #C48945; }
    .qty-display { font-size: 18px; font-weight: bold; width: 40px; text-align: center; color: #333; }

    /* === 4. æ‘˜è¦è¡¨èˆ‡è¡¨å–® === */
    .summary-section { background: #fffcf5; border: 2px solid #E6BA67; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
    .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .summary-table th { text-align: left; padding: 10px; border-bottom: 2px solid #E6BA67; color: #8B4513; }
    .summary-table td { padding: 10px; border-bottom: 1px dashed #ddd; }
    .summary-total { text-align: right; font-size: 1.3rem; font-weight: bold; color: #C48945; padding-top: 15px; }

    .form-section { background: #f9f9f9; padding: 30px; border-radius: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
    .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    
    .btn-submit {
        background: #C48945; color: #fff; width: 100%; padding: 15px;
        border: none; border-radius: 50px; font-size: 1.3rem; font-weight: bold;
        cursor: pointer; transition: 0.3s; margin-top: 20px;
        text-align: center; display: block; text-decoration: none;
    }
    .btn-submit:hover { background: #a06d35; transform: scale(1.02); }

    /* æ‰‹æ©Ÿç‰ˆ RWD */
    @media (max-width: 768px) {
        .donation-hero { height: 40vh; }
        .hero-text h1 { font-size: 2.2rem; }
        .donation-container { margin-top: 0; border-radius: 0; padding: 20px; }
        .donation-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
        .d-img { height: 140px; }
        .qty-btn { width: 30px; height: 30px; font-size: 16px; }
        .honor-title { font-size: 1.2rem; padding-left: 10px; letter-spacing: 2px; }

        /* æµç¨‹åœ–æ‰‹æ©Ÿç‰ˆå‚ç›´æ’åˆ— */
        .process-flow { flex-direction: column; gap: 20px; align-items: flex-start; padding-left: 10px; }
        .process-flow::before {
            width: 2px; height: 90%; top: 0; left: 35px; /* å‚ç›´é€£ç·š */
        }
        .p-step { display: flex; align-items: flex-start; gap: 15px; text-align: left; width: 100%; }
        .p-icon { margin: 0; flex-shrink: 0; }
        .p-info-box { flex: 1; }
    }
</style>

<div class="donation-hero">
    <div class="hero-text">
        <h1>è­·æŒå…¬å£‡ â€§ é¦™ç«å‚³é</h1>
        <p>æ‚¨çš„æ¯ä¸€ä»½å¿ƒæ„ï¼Œéƒ½å°‡åŒ–ä½œä¸Šé”å¤©è½çš„ç¸·ç¸·æ¸…é¦™</p>
    </div>
</div>

<div class="donation-container">
    <div class="concept-section">
        <h2>å…±é€ ç¦ç”° â€§ å»£çµå–„ç·£</h2>
        <div class="concept-text">
            <p>æ‰¿å¤©ä¸­æ‰¿åºœçš„ã€Œå…¬å£‡ã€ï¼Œæ˜¯å…ƒå¸¥ç‚ºä¿¡å¾’è§£æƒ‘ã€å®‰æ’«å¿ƒéˆçš„æ‰€åœ¨ã€‚æ¯ä¸€æ¬¡çš„é–‹å£‡è¾¦äº‹ï¼Œéƒ½éœ€è¦ä½¿ç”¨å¤§é‡çš„é¦™å“èˆ‡ç‰©è³‡ã€‚</p>
            <p><strong>ã€Œæé¦™ã€</strong>ï¼Œä¸åƒ…æ˜¯ç‰©è³ªä¸Šçš„æ”¯æŒï¼Œæ›´æ˜¯ä¸€ä»½<strong>å®ˆè­·çš„æ‰¿è«¾</strong>ã€‚æ‚¨æ‰€æç»çš„æ¯ä¸€æŸ±é¦™ï¼Œéƒ½å°‡åœ¨å…¬å£‡è¾¦äº‹æ™‚é»ç‡ƒï¼Œå”åŠ©å…ƒå¸¥åŸ·è¡Œè–å‹™ã€‚</p>
            <div class="concept-highlight">
                ğŸ™ æ‚¨çš„å¿ƒæ„ï¼Œå…ƒå¸¥éƒ½çŸ¥é“<br>
                å‡¡åƒèˆ‡æé¦™ä¹‹ä¿¡å¾’ï¼Œæˆ‘å€‘å°‡æ–¼ä¸‹ä¸€æ¬¡å…¬å£‡è¾¦äº‹æ™‚ï¼Œ<br>
                ç”±å…ƒå¸¥å¨˜å°‡å®Œæ•´å‘ç…™å³¶å…ƒå¸¥ç¨Ÿå ±ã€‚
            </div>
        </div>
    </div>

    <div class="honor-roll-section">
        <div class="honor-title">æè´ˆèŠ³åéŒ„</div>
        <div class="marquee-container">
            <div class="marquee-content" id="honor-list">
                <div style="padding:10px; text-align:center;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <div class="cta-container" id="cta-container">
        <button class="start-donate-btn" onclick="startDonation()">ğŸ™ æˆ‘ä¹Ÿè¦æé¦™</button>
    </div>

    <div id="donation-process-area">
        <div class="process-flow-wrapper">
            <h3 style="text-align:center; color:#8B4513; margin-bottom:30px;">è­·æŒæµç¨‹èªªæ˜</h3>
            <div class="process-flow">
                <div class="p-step">
                    <div class="p-icon">1</div>
                    <div class="p-info-box">
                        <div class="p-text">é¸æ“‡é …ç›®</div>
                        <div class="p-desc">æŒ‘é¸æ‚¨æ¬²è­·æŒçš„é¦™å“é …ç›®èˆ‡æ•¸é‡ã€‚</div>
                    </div>
                </div>
                <div class="p-step">
                    <div class="p-icon">2</div>
                    <div class="p-info-box">
                        <div class="p-text">éŠ€è¡ŒåŒ¯æ¬¾</div>
                        <div class="p-desc">å¡«å–®å¾Œè«‹æ–¼2å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾è½‰å¸³ã€‚</div>
                    </div>
                </div>
                <div class="p-step">
                    <div class="p-icon">3</div>
                    <div class="p-info-box">
                        <div class="p-text">æ ¸å°ç´€éŒ„</div>
                        <div class="p-desc">ç¢ºèªæ¬¾é …å¾Œï¼Œç™»éŒ„èŠ³åéŒ„ä¸¦å¯„é€é›»å­æ„Ÿè¬ç‹€ã€‚</div>
                    </div>
                </div>
                <div class="p-step">
                    <div class="p-icon">4</div>
                    <div class="p-info-box">
                        <div class="p-text">å…¬å£‡ç¨Ÿå ±</div>
                        <div class="p-desc">æ–¼ä¸‹æ¬¡å…¬å£‡è¾¦äº‹æ™‚ï¼Œå‘å…ƒå¸¥å®Œæ•´ç¨Ÿå ±æ‚¨çš„å¿ƒæ„ã€‚</div>
                    </div>
                </div>
            </div>
        </div>

        <form id="donation-form">
            <h3 style="border-left: 5px solid #C48945; padding-left: 10px; margin-bottom: 20px;">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡è­·æŒé …ç›®</h3>
            <div class="donation-grid" id="donation-grid">
                </div>

            <div class="summary-section" id="summary-section" style="display:none;">
                <h4 style="margin-top:0; color:#8B4513;">ğŸ“‹ æ‚¨çš„è­·æŒæ¸…å–®</h4>
                <table class="summary-table">
                    <thead><tr><th>é …ç›®</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr></thead>
                    <tbody id="summary-body"></tbody>
                </table>
                <div class="summary-total">ç¸½è¨ˆé‡‘é¡ï¼šNT$ <span id="summary-total">0</span></div>
            </div>

            <h3 style="border-left: 5px solid #C48945; padding-left: 10px; margin-bottom: 20px; margin-top: 40px;">ç¬¬äºŒæ­¥ï¼šå¡«å¯«ç¥ˆç¦è³‡æ–™</h3>
            <div class="form-section">
                <p style="color:red; font-size:0.9rem; margin-bottom:15px;">â€» æ­¤ç‚ºä»£æé …ç›®ï¼Œä¸æœƒå¯„é€å¯¦é«”å•†å“ã€‚</p>
                
                <div class="form-group"><label>å§“å</label><input type="text" name="name" class="form-control" required placeholder="è«‹å¡«å¯«çœŸå¯¦å§“å"></div>
                
                <div class="form-group">
                    <label>è¯çµ¡é›»è©± (09XX-XXX-XXX)</label>
                    <input type="tel" name="phone" id="phone-input" class="form-control" placeholder="09XX-XXX-XXX" required maxlength="12">
                </div>
                <div class="form-group"><label>é›»å­ä¿¡ç®± (æ¥æ”¶é›»å­æ„Ÿè¬ç‹€)</label><input type="email" name="email" class="form-control" required></div>
                <div class="form-group"><label>åœ°å€ </label><input type="text" name="address" class="form-control" required></div>
                
                <div class="form-group">
                    <label>è¾²æ›†ç”Ÿæ—¥ (è«‹ç›´æ¥è¼¸å…¥æ•¸å­—ï¼Œå¦‚ï¼š750815 æˆ– 1120101)</label>
                    <input type="text" name="lunarBirthday" id="birthday-input" class="form-control" placeholder="ä¾‹ï¼š750815" maxlength="10">
                </div>

                <div class="form-group">
                    <label>åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                    <input type="text" name="last5" class="form-control" maxlength="5" pattern="\d{5}" placeholder="è«‹å¡«å¯«5ç¢¼æ•¸å­—" required title="è«‹è¼¸å…¥5ä½æ•¸å­—">
                </div>

                <div style="margin-top:20px;">
                    <button type="submit" class="btn-submit">ç¢ºèªæè´ˆä¸¦é€å‡º</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="success-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:30px; border-radius:10px; text-align:center; max-width:400px; width:90%;">
        <h2 style="color:#C48945;">åŠŸå¾·ç„¡é‡ ğŸ™</h2>
        <p>æ‚¨çš„æè´ˆè¨‚å–®å·²é€å‡ºã€‚</p>
        <p>è«‹æ–¼ 2 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ï¼Œ<br>æˆ‘å€‘æ ¸å°å¾Œå°‡æœƒå¯„å‡ºé›»å­æ„Ÿè¬ç‹€ã€‚</p>
        <a href="{{ url_for('home') }}" class="btn-submit" style="text-decoration:none; display:inline-block; width:auto; margin-top:20px; padding:10px 30px;">å›é¦–é </a>
    </div>
</div>

<script>
    let products = [];
    let selectedItems = {}; // { id: {name, price, qty} }

    document.addEventListener('DOMContentLoaded', () => {
        loadMarquee();
        loadProducts();
        setupFormatters();
        
        // â˜… æ–°å¢ï¼šæª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰åƒæ•¸ï¼Œå¦‚æœæ˜¯ç™»å…¥å¾Œè·³è½‰å›ä¾†ï¼Œè‡ªå‹•é–‹å•Ÿè¡¨å–®
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'donate') {
            startDonation();
        }
    });

    // â˜… ä¿®æ”¹ï¼šå•Ÿå‹•æè´ˆæµç¨‹ (åŠ å…¥ LINE ç™»å…¥æª¢æŸ¥)
    window.startDonation = async () => {
        const btn = document.querySelector('.start-donate-btn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'è®€å–è³‡æ–™ä¸­...';

        try {
            // 1. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const res = await fetch('/api/user/me');
            const data = await res.json();

            if (!data.logged_in) {
                // æœªç™»å…¥ï¼šè¨˜éŒ„ç•¶å‰æ„åœ–ï¼Œè·³è½‰å» LINE ç™»å…¥ï¼Œä¸¦å¸¶ä¸Šåƒæ•¸è®“å›ä¾†æ™‚çŸ¥é“è¦ç¹¼çºŒ
                alert('ç‚ºäº†è¨˜éŒ„æ‚¨çš„åŠŸå¾·ä¸¦å¯„é€æ„Ÿè¬ç‹€ï¼Œè«‹å…ˆé€²è¡Œ LINE ç™»å…¥ã€‚');
                // next åƒæ•¸è¨­ç‚º /donation?action=donateï¼Œé€™æ¨£ç™»å…¥å›ä¾†å¯ä»¥è‡ªå‹•è§¸ç™¼
                window.location.href = '/api/line/login?next=' + encodeURIComponent('/donation?action=donate');
                return;
            }

            // 2. å·²ç™»å…¥ï¼šè‡ªå‹•å¸¶å…¥æœƒå“¡è³‡æ–™
            const user = data.user || {};
            const form = document.getElementById('donation-form');
            
            // å¦‚æœæ¬„ä½æ˜¯ç©ºçš„ï¼Œæ‰è‡ªå‹•å¸¶å…¥ (é¿å…è¦†è“‹ä½¿ç”¨è€…å‰›æ‰“çš„å­—)
            if(!form.name.value && user.realName) form.name.value = user.realName;
            if(!form.phone.value && user.phone) form.phone.value = user.phone;
            if(!form.email.value && user.email) form.email.value = user.email;
            if(!form.address.value && user.address) form.address.value = user.address;
            
            // è¾²æ›†ç”Ÿæ—¥è™•ç†
            if(!form.lunarBirthday.value && user.lunarBirthday) {
                form.lunarBirthday.value = user.lunarBirthday;
            }

            // 3. é¡¯ç¤ºæè´ˆå€å¡Š
            const area = document.getElementById('donation-process-area');
            area.style.display = 'block';
            setTimeout(() => {
                area.classList.add('show');
                area.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 10);
            
            // éš±è—æŒ‰éˆ• (é¸æ“‡æ€§)
            document.getElementById('cta-container').style.display = 'none';

        } catch (e) {
            console.error(e);
            alert('ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    };

    // 1. è¼‰å…¥å•†å“ (ç¶­æŒä¸è®Š)
    function loadProducts() {
        // ... (åŸç¨‹å¼ç¢¼ä¸è®Š)
        fetch('/api/products')
            .then(res => res.json())
            .then(data => {
                products = data.filter(p => p.isDonation === true && p.isActive);
                const grid = document.getElementById('donation-grid');
                if(products.length === 0) { grid.innerHTML = '<p>ç›®å‰æ²’æœ‰é–‹æ”¾çš„æè´ˆé …ç›®ã€‚</p>'; return; }

                grid.innerHTML = products.map(p => `
                    <div class="donation-card" id="card-${p._id}">
                        <img src="${p.image || '/static/images/common/default_product.png'}" class="d-img" onerror="this.src='/static/images/common/default_product.png'">
                        <div class="d-info">
                            <div class="d-title">${p.name}</div>
                            <div class="d-price">è­·æŒé‡‘ NT$ ${p.price}</div>
                            <div class="qty-control">
                                <button type="button" class="qty-btn" onclick="changeQty('${p._id}', -1)">-</button>
                                <span class="qty-display" id="qty-${p._id}">0</span>
                                <button type="button" class="qty-btn" onclick="changeQty('${p._id}', 1)">+</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
    }

    // 2. æ•¸é‡è®Šæ›´é‚è¼¯ (ç¶­æŒä¸è®Š)
    window.changeQty = (id, delta) => {
        // ... (åŸç¨‹å¼ç¢¼ä¸è®Š)
        const p = products.find(x => x._id === id);
        if(!selectedItems[id]) selectedItems[id] = { id: p._id, name: p.name, price: p.price, qty: 0 };
        
        selectedItems[id].qty += delta;
        if(selectedItems[id].qty < 0) selectedItems[id].qty = 0;
        
        document.getElementById(`qty-${id}`).textContent = selectedItems[id].qty;
        const card = document.getElementById(`card-${id}`);
        if(selectedItems[id].qty > 0) card.classList.add('active'); else card.classList.remove('active');
        
        if(selectedItems[id].qty === 0) delete selectedItems[id];
        updateSummary();
    };

    // 3. æ›´æ–°æ‘˜è¦è¡¨ (ç¶­æŒä¸è®Š)
    function updateSummary() {
        // ... (åŸç¨‹å¼ç¢¼ä¸è®Š)
        const tbody = document.getElementById('summary-body');
        const section = document.getElementById('summary-section');
        const items = Object.values(selectedItems);
        
        if(items.length === 0) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        let total = 0;
        tbody.innerHTML = items.map(item => {
            const subtotal = item.price * item.qty;
            total += subtotal;
            return `<tr><td>${item.name}</td><td>${item.qty}</td><td>$${subtotal}</td></tr>`;
        }).join('');
        document.getElementById('summary-total').textContent = total;
    }

    // 4. è‡ªå‹•æ ¼å¼åŒ–èˆ‡é©—è­‰ (ç¶­æŒä¸è®Š)
    function setupFormatters() {
        // ... (åŸç¨‹å¼ç¢¼ä¸è®Š)
        const phoneInput = document.getElementById('phone-input');
        phoneInput.addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g, ''); 
            if (v.length > 10) v = v.slice(0, 10);
            if (v.length > 7) v = v.replace(/(\d{4})(\d{3})(\d{0,3})/, '$1-$2-$3');
            else if (v.length > 4) v = v.replace(/(\d{4})(\d{0,3})/, '$1-$2');
            e.target.value = v;
        });

        const bdayInput = document.getElementById('birthday-input');
        bdayInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
        bdayInput.addEventListener('blur', (e) => {
            let v = e.target.value;
            if(v.length === 6) {
                e.target.value = v.replace(/(\d{2})(\d{2})(\d{2})/, '$1/$2/$3');
            } else if (v.length === 7) {
                e.target.value = v.replace(/(\d{3})(\d{2})(\d{2})/, '$1/$2/$3');
            }
        });
    }

    // 5. é€å‡ºè¡¨å–® (ç¶­æŒä¸è®Š)
    document.getElementById('donation-form').onsubmit = async (e) => {
        // ... (åŸç¨‹å¼ç¢¼ä¸è®Š)
        e.preventDefault();
        const items = Object.values(selectedItems);
        if (items.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è­·æŒé …ç›®');
        
        const phone = document.getElementById('phone-input').value;
        if(!/^09\d{2}-\d{3}-\d{3}$/.test(phone)) return alert('é›»è©±æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªç‚º 09XX-XXX-XXX');
        
        const bday = document.getElementById('birthday-input').value;
        if(bday && !/^\d{2,3}\/\d{2}\/\d{2}$/.test(bday)) return alert('ç”Ÿæ—¥æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ°‘åœ‹å¹´æ•¸å­— (å¦‚ 750821 æˆ– 1120101)');

        const f = e.target;
        const payload = {
            orderType: 'donation',
            name: f.name.value,
            phone: phone,
            email: f.email.value,
            address: f.address.value,
            lunarBirthday: bday,
            prayer: '', 
            last5: f.last5.value,
            items: items,
            total: parseInt(document.getElementById('summary-total').textContent)
        };

        const btn = f.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = "è™•ç†ä¸­...";

        try {
            const res = await fetch('/api/orders', {
                method:'POST',
                headers:{'Content-Type':'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content},
                body: JSON.stringify(payload)
            });
            
            // â˜… æ–°å¢ï¼šè‹¥ Token éæœŸæˆ–è¢«ç™»å‡ºï¼Œé€™é‚Šæœƒæ¥åˆ° 401 éŒ¯èª¤
            if (res.status === 401) {
                alert('æ‚¨çš„ç™»å…¥æ™‚æ•ˆå·²éï¼Œè«‹é‡æ–°ç™»å…¥ LINE');
                window.location.href = '/api/line/login?next=' + encodeURIComponent('/donation?action=donate');
                return;
            }

            if((await res.json()).success) {
                document.getElementById('success-modal').style.display = 'flex';
            } else {
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                btn.disabled = false;
                btn.textContent = "ç¢ºèªæè´ˆä¸¦é€å‡º";
            }
        } catch(err) {
            alert('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            btn.disabled = false;
            btn.textContent = "ç¢ºèªæè´ˆä¸¦é€å‡º";
        }
    };

    // èŠ³åéŒ„ (ç¶­æŒä¸è®Š)
    function loadMarquee() {
        fetch('/api/donations/public').then(r=>r.json()).then(data => {
            const list = document.getElementById('honor-list');
            if(!data.length) { list.innerHTML='<div style="text-align:center;">å°šç„¡ç´€éŒ„</div>'; return; }
            const html = data.map(d => `<div class="donor-item"><span>${d.name}</span><span>${d.items}</span></div>`).join('');
            list.innerHTML = html + html; 
        });
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - è­·æŒå…¬å£‡{% endblock %}

{% block content %}
<style>
    :root {
        --c-primary: #C48945;     /* ä¸»è‰²èª¿ */
        --c-primary-dark: #a06d35;
        --c-secondary: #8B4513;   /* æ·±æ£•è‰² */
        --c-accent: #FFD700;      /* é‡‘è‰² */
        --c-red-bg: #8B0000;      /* å®®å»Ÿç´… */
        --c-bg-light: #fffcf5;    /* æ·ºåº•è‰² */
        --c-text: #333;
        --c-text-gray: #555;
        --shadow-std: 0 10px 30px rgba(0,0,0,0.1);
        --radius-std: 15px;
    }

    /* === é€šç”¨å·¥å…·é¡ === */
    .d-none { display: none !important; }
    .d-block { display: block !important; }
    .text-center { text-align: center; }
    .flex-center { display: flex; justify-content: center; align-items: center; }
    .relative { position: relative; }
    .pointer { cursor: pointer; }

    /* === é ‚éƒ¨è¦–è¦º Hero === */
    .donation-hero {
        background: url('{{ url_for("static", filename="images/pages/gongtan/signuppic.jpg") }}') no-repeat center center/cover;
        height: 60vh;
        color: #fff;
    }
    .donation-hero::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
    .hero-text { position: relative; z-index: 2; padding: 20px; }
    .hero-text h1 { font-family: 'KouzanBrushFontOTF', serif; font-size: 3.5rem; margin-bottom: 10px; text-shadow: 2px 2px 5px rgba(0,0,0,0.7); }
    .hero-text p { font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }

    /* === å…§å®¹å®¹å™¨ === */
    .donation-container {
        max-width: 1100px; margin: -50px auto 50px auto; 
        background: #fff; border-radius: var(--radius-std);
        box-shadow: var(--shadow-std); position: relative; z-index: 3; padding: 40px;
        border-top: 5px solid var(--c-primary);
    }

    /* === å€å¡Šæ¨£å¼ === */
    .concept-section { margin-bottom: 40px; }
    .concept-section h2 { 
        color: var(--c-secondary); margin-bottom: 20px; font-size: 2rem; 
        position: relative; display: inline-block; 
    }
    .concept-section h2::after { content:''; display:block; width: 60px; height: 3px; background: var(--c-primary); margin: 10px auto 0 auto; }
    .concept-text { font-size: 1.1rem; line-height: 1.8; color: var(--c-text-gray); max-width: 800px; margin: 0 auto; }
    .concept-highlight { 
        color: var(--c-primary); font-weight: bold; background: var(--c-bg-light); 
        padding: 15px; border-radius: 10px; border: 1px dashed var(--c-primary); margin-top: 20px; 
    }

    /* === èŠ³åéŒ„å€ === */
    .honor-roll-section {
        background: linear-gradient(180deg, #9E2A2B 0%, var(--c-red-bg) 100%);
        color: var(--c-accent); padding: 20px; border-radius: 12px; margin-bottom: 40px;
        display: flex; align-items: center; gap: 20px; overflow: hidden;
        border: 4px double var(--c-accent); box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
    }
    .honor-title { 
        font-size: 1.5rem; font-weight: bold; writing-mode: vertical-rl; text-orientation: upright; 
        letter-spacing: 5px; border-left: 3px solid var(--c-accent); padding-left: 15px; flex-shrink: 0; 
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .marquee-container { flex: 1; height: 150px; overflow: hidden; position: relative; }
    .marquee-content { position: absolute; width: 100%; animation: scrollUp 30s linear infinite; }
    .donor-item { 
        display: flex; justify-content: space-between; padding: 10px 5px; 
        border-bottom: 1px dashed rgba(255, 215, 0, 0.5); font-size: 1.1rem; 
    }
    .donor-item span:first-child { font-weight: bold; }
    @keyframes scrollUp { 0% { top: 100%; } 100% { top: -200%; } }

    /* === æµç¨‹èˆ‡è¡¨å–® === */
    .cta-container { margin: 30px 0; }
    .start-donate-btn {
        background: linear-gradient(45deg, var(--c-primary), var(--c-accent)); 
        color: #fff; padding: 15px 50px; font-size: 22px; border-radius: 50px;
        border: 2px solid #fff; transition: 0.3s; 
        box-shadow: 0 4px 15px rgba(196, 137, 69, 0.4);
        display: inline-flex; align-items: center; gap: 10px; font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .start-donate-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 6px 20px rgba(196, 137, 69, 0.6); }

    .process-flow-wrapper { margin-bottom: 40px; padding: 20px 0; border-bottom: 1px dashed #ddd; }
    .process-flow { display: flex; justify-content: space-between; align-items: flex-start; position: relative; max-width: 900px; margin: 0 auto; }
    .process-flow::before { content: ''; position: absolute; top: 25px; left: 5%; width: 90%; height: 2px; background: #e0e0e0; z-index: 0; }
    
    .p-step { position: relative; z-index: 1; text-align: center; flex: 1; padding: 0 5px; }
    .p-icon {
        width: 50px; height: 50px; background: var(--c-bg-light); border: 2px solid var(--c-primary); border-radius: 50%;
        margin: 0 auto 10px auto; display: flex; justify-content: center; align-items: center;
        font-weight: bold; color: var(--c-primary); font-size: 1.2rem; 
        box-shadow: 0 0 0 5px #fff;
    }
    .p-text { font-size: 1rem; color: var(--c-text); font-weight: bold; line-height: 1.4; }
    .p-desc { font-size: 0.85rem; color: #777; margin-top: 5px; line-height: 1.4; }

    #donation-process-area { opacity: 0; transition: opacity 0.5s ease; }
    #donation-process-area.show { opacity: 1; }

    /* === å•†å“å¡ç‰‡ === */
    .donation-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .donation-card {
        border: 1px solid #eee; border-radius: 10px; overflow: hidden;
        transition: 0.3s; position: relative; background: #fff; display: flex; flex-direction: column;
    }
    .donation-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(196, 137, 69, 0.2); }
    .donation-card.active { border: 2px solid var(--c-primary); background: var(--c-bg-light); box-shadow: 0 0 10px rgba(196, 137, 69, 0.3); }
    .d-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
    .d-info { padding: 15px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .d-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; color: var(--c-text); }
    .d-price { color: var(--c-primary); font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; }
    
    .qty-control { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
    .qty-btn { 
        width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: #fff; 
        cursor: pointer; font-size: 18px; color: #555; transition: 0.2s; 
        display: flex; justify-content: center; align-items: center; 
    }
    .qty-btn:hover { background: var(--c-primary); color: #fff; border-color: var(--c-primary); }
    .qty-display { font-size: 18px; font-weight: bold; width: 40px; text-align: center; color: var(--c-text); }

    /* === æ‘˜è¦èˆ‡è¡¨å–® === */
    .summary-section { background: var(--c-bg-light); border: 2px solid #E6BA67; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
    .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .summary-table th { text-align: left; padding: 10px; border-bottom: 2px solid #E6BA67; color: var(--c-secondary); }
    .summary-table td { padding: 10px; border-bottom: 1px dashed #ddd; }
    .summary-total { text-align: right; font-size: 1.3rem; font-weight: bold; color: var(--c-primary); padding-top: 15px; }

    .step-title { border-left: 5px solid var(--c-primary); padding-left: 10px; margin-bottom: 20px; }
    .form-section { background: #f9f9f9; padding: 30px; border-radius: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--c-text); }
    .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    
    .btn-submit {
        background: var(--c-primary); color: #fff; width: 100%; padding: 15px;
        border: none; border-radius: 50px; font-size: 1.3rem; font-weight: bold;
        cursor: pointer; transition: 0.3s; margin-top: 20px;
        text-align: center; display: block; text-decoration: none;
    }
    .btn-submit:hover { background: var(--c-primary-dark); transform: scale(1.02); }

    /* === Modal === */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.7); z-index: 9999; 
    }
    .modal-box { background: #fff; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px; width: 90%; }

    /* === RWD === */
    @media (max-width: 768px) {
        .donation-hero { height: 40vh; }
        .hero-text h1 { font-size: 2.2rem; }
        .donation-container { margin-top: 0; border-radius: 0; padding: 20px; }
        .donation-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
        .d-img { height: 140px; }
        .qty-btn { width: 30px; height: 30px; font-size: 16px; }
        .honor-title { font-size: 1.2rem; padding-left: 10px; letter-spacing: 2px; }
        .process-flow { flex-direction: column; gap: 20px; align-items: flex-start; padding-left: 10px; }
        .process-flow::before { width: 2px; height: 90%; top: 0; left: 35px; }
        .p-step { display: flex; align-items: flex-start; gap: 15px; text-align: left; width: 100%; }
        .p-icon { margin: 0; flex-shrink: 0; }
        .p-info-box { flex: 1; }
    }
</style>

<div class="donation-hero flex-center relative">
    <div class="hero-text text-center">
        <h1>è­·æŒå…¬å£‡ â€§ é¦™ç«å‚³é</h1>
        <p>æ‚¨çš„æ¯ä¸€ä»½å¿ƒæ„ï¼Œéƒ½å°‡åŒ–ä½œä¸Šé”å¤©è½çš„ç¸·ç¸·æ¸…é¦™</p>
    </div>
</div>

<div class="donation-container">
    <section class="concept-section text-center">
        <h2>å…±é€ ç¦ç”° â€§ å»£çµå–„ç·£</h2>
        <div class="concept-text">
            <p>æ‰¿å¤©ä¸­æ‰¿åºœçš„ã€Œå…¬å£‡ã€ï¼Œæ˜¯å…ƒå¸¥ç‚ºä¿¡å¾’è§£æƒ‘ã€å®‰æ’«å¿ƒéˆçš„æ‰€åœ¨ã€‚æ¯ä¸€æ¬¡çš„é–‹å£‡è¾¦äº‹ï¼Œéƒ½éœ€è¦ä½¿ç”¨å¤§é‡çš„é¦™å“èˆ‡ç‰©è³‡ã€‚</p>
            <p><strong>ã€Œæé¦™ã€</strong>ï¼Œä¸åƒ…æ˜¯ç‰©è³ªä¸Šçš„æ”¯æŒï¼Œæ›´æ˜¯ä¸€ä»½<strong>å®ˆè­·çš„æ‰¿è«¾</strong>ã€‚æ‚¨æ‰€æç»çš„æ¯ä¸€æŸ±é¦™ï¼Œéƒ½å°‡åœ¨å…¬å£‡è¾¦äº‹æ™‚é»ç‡ƒï¼Œå”åŠ©å…ƒå¸¥åŸ·è¡Œè–å‹™ã€‚</p>
            <div class="concept-highlight">
                ğŸ™ æ‚¨çš„å¿ƒæ„ï¼Œå…ƒå¸¥éƒ½çŸ¥é“<br>
                å‡¡åƒèˆ‡æé¦™ä¹‹ä¿¡å¾’ï¼Œæˆ‘å€‘å°‡æ–¼ä¸‹ä¸€æ¬¡å…¬å£‡è¾¦äº‹æ™‚ï¼Œ<br>
                ç”±å…ƒå¸¥å¨˜å°‡å®Œæ•´å‘ç…™å³¶å…ƒå¸¥ç¨Ÿå ±ã€‚
            </div>
        </div>
    </section>

    <section class="honor-roll-section">
        <div class="honor-title">æè´ˆèŠ³åéŒ„</div>
        <div class="marquee-container">
            <div class="marquee-content" id="honor-list">
                <div class="text-center" style="padding:10px;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </section>

    <div class="cta-container text-center" id="cta-container">
        <button class="start-donate-btn pointer" onclick="startDonation()">ğŸ™ æˆ‘ä¹Ÿè¦æé¦™</button>
    </div>

    <div id="donation-process-area" class="d-none">
        <div class="process-flow-wrapper">
            <h3 class="text-center" style="color:var(--c-secondary); margin-bottom:30px;">è­·æŒæµç¨‹èªªæ˜</h3>
            <div class="process-flow">
                <div class="p-step">
                    <div class="p-icon">1</div>
                    <div class="p-info-box">
                        <div class="p-text">é¸æ“‡é …ç›®</div>
                        <div class="p-desc">æŒ‘é¸æ‚¨æ¬²è­·æŒçš„é¦™å“é …ç›®èˆ‡æ•¸é‡ã€‚</div>
                    </div>
                </div>
                <div class="p-step">
                    <div class="p-icon">2</div>
                    <div class="p-info-box">
                        <div class="p-text">éŠ€è¡ŒåŒ¯æ¬¾</div>
                        <div class="p-desc">å¡«å–®å¾Œè«‹æ–¼2å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾è½‰å¸³ã€‚</div>
                    </div>
                </div>
                <div class="p-step">
                    <div class="p-icon">3</div>
                    <div class="p-info-box">
                        <div class="p-text">æ ¸å°ç´€éŒ„</div>
                        <div class="p-desc">ç¢ºèªæ¬¾é …å¾Œï¼Œç™»éŒ„èŠ³åéŒ„ä¸¦å¯„é€é›»å­æ„Ÿè¬ç‹€ã€‚</div>
                    </div>
                </div>
                <div class="p-step">
                    <div class="p-icon">4</div>
                    <div class="p-info-box">
                        <div class="p-text">å…¬å£‡ç¨Ÿå ±</div>
                        <div class="p-desc">æ–¼ä¸‹æ¬¡å…¬å£‡è¾¦äº‹æ™‚ï¼Œå‘å…ƒå¸¥å®Œæ•´ç¨Ÿå ±æ‚¨çš„å¿ƒæ„ã€‚</div>
                    </div>
                </div>
            </div>
        </div>

        <form id="donation-form">
            <h3 class="step-title">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡è­·æŒé …ç›®</h3>
            <div class="donation-grid" id="donation-grid"></div>

            <div class="summary-section d-none" id="summary-section">
                <h4 style="margin-top:0; color:var(--c-secondary);">ğŸ“‹ æ‚¨çš„è­·æŒæ¸…å–®</h4>
                <table class="summary-table">
                    <thead><tr><th>é …ç›®</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr></thead>
                    <tbody id="summary-body"></tbody>
                </table>
                <div class="summary-total">ç¸½è¨ˆé‡‘é¡ï¼šNT$ <span id="summary-total">0</span></div>
            </div>

            <h3 class="step-title" style="margin-top: 40px;">ç¬¬äºŒæ­¥ï¼šå¡«å¯«ç¥ˆç¦è³‡æ–™</h3>
            <div class="form-section">
                <p style="color:red; font-size:0.9rem; margin-bottom:15px;">â€» æ­¤ç‚ºä»£æé …ç›®ï¼Œä¸æœƒå¯„é€å¯¦é«”å•†å“ã€‚</p>
                
                <div class="form-group"><label>å§“å</label><input type="text" name="name" class="form-control" required placeholder="è«‹å¡«å¯«çœŸå¯¦å§“å"></div>
                
                <div class="form-group">
                    <label>è¯çµ¡é›»è©± (09XX-XXX-XXX)</label>
                    <input type="tel" name="phone" id="phone-input" class="form-control" placeholder="09XX-XXX-XXX" required maxlength="12">
                </div>
                <div class="form-group"><label>é›»å­ä¿¡ç®± (æ¥æ”¶é›»å­æ„Ÿè¬ç‹€)</label><input type="email" name="email" class="form-control" required></div>
                <div class="form-group"><label>åœ°å€ </label><input type="text" name="address" class="form-control" required></div>
                
                <div class="form-group">
                    <label>è¾²æ›†ç”Ÿæ—¥ (è«‹ç›´æ¥è¼¸å…¥æ•¸å­—ï¼Œå¦‚ï¼š750815 æˆ– 1120101)</label>
                    <input type="text" name="lunarBirthday" id="birthday-input" class="form-control" placeholder="ä¾‹ï¼š750815" maxlength="10">
                </div>

                <div class="form-group">
                    <label>åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                    <input type="text" name="last5" class="form-control" maxlength="5" pattern="\d{5}" placeholder="è«‹å¡«å¯«5ç¢¼æ•¸å­—" required title="è«‹è¼¸å…¥5ä½æ•¸å­—">
                </div>

                <div style="margin-top:20px;">
                    <button type="submit" class="btn-submit">ç¢ºèªæè´ˆä¸¦é€å‡º</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="success-modal" class="modal-overlay d-none flex-center">
    <div class="modal-box">
        <h2 style="color:var(--c-primary);">åŠŸå¾·ç„¡é‡ ğŸ™</h2>
        <p>æ‚¨çš„æè´ˆè¨‚å–®å·²é€å‡ºã€‚</p>
        <p>è«‹æ–¼ 2 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ï¼Œ<br>æˆ‘å€‘æ ¸å°å¾Œå°‡æœƒå¯„å‡ºé›»å­æ„Ÿè¬ç‹€ã€‚</p>
        <a href="{{ url_for('home') }}" class="btn-submit" style="display:inline-block; width:auto; margin-top:20px; padding:10px 30px;">å›é¦–é </a>
    </div>
</div>

<script>
    let products = [];
    const selectedItems = {}; // { id: {name, price, qty} }

    document.addEventListener('DOMContentLoaded', () => {
        loadMarquee();
        loadProducts();
        setupFormatters();
        
        // æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰åƒæ•¸ï¼Œå¦‚æœæ˜¯ç™»å…¥å¾Œè·³è½‰å›ä¾†ï¼Œè‡ªå‹•é–‹å•Ÿè¡¨å–®
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('action') === 'donate') {
            startDonation();
        }
    });

    // å•Ÿå‹•æè´ˆæµç¨‹ (åŠ å…¥ LINE ç™»å…¥æª¢æŸ¥)
    window.startDonation = async () => {
        const btn = document.querySelector('.start-donate-btn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'è®€å–è³‡æ–™ä¸­...';

        try {
            const res = await fetch('/api/user/me');
            const data = await res.json();

            if (!data.logged_in) {
                alert('ç‚ºäº†è¨˜éŒ„æ‚¨çš„åŠŸå¾·ä¸¦å¯„é€æ„Ÿè¬ç‹€ï¼Œè«‹å…ˆé€²è¡Œ LINE ç™»å…¥ã€‚');
                window.location.href = '/api/line/login?next=' + encodeURIComponent('/donation?action=donate');
                return;
            }

            // å·²ç™»å…¥ï¼šè‡ªå‹•å¸¶å…¥æœƒå“¡è³‡æ–™
            const user = data.user || {};
            const form = document.getElementById('donation-form');
            const setVal = (input, val) => { if (!input.value && val) input.value = val; };

            setVal(form.name, user.realName);
            setVal(form.phone, user.phone);
            setVal(form.email, user.email);
            setVal(form.address, user.address);
            setVal(form.lunarBirthday, user.lunarBirthday);

            // é¡¯ç¤ºæè´ˆå€å¡Š
            const area = document.getElementById('donation-process-area');
            area.classList.remove('d-none');
            // è®“ç€è¦½å™¨æœ‰æ™‚é–“æ¸²æŸ“ d-none ç§»é™¤å¾Œçš„ç‹€æ…‹ï¼Œå†åŠ  show è§¸ç™¼ transition
            requestAnimationFrame(() => {
                area.classList.add('show');
                area.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
            
            document.getElementById('cta-container').classList.add('d-none');

        } catch (e) {
            console.error(e);
            alert('ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    };

    // è¼‰å…¥å•†å“
    async function loadProducts() {
        try {
            const res = await fetch('/api/products');
            const data = await res.json();
            products = data.filter(p => p.isDonation === true && p.isActive);
            
            const grid = document.getElementById('donation-grid');
            if(products.length === 0) { 
                grid.innerHTML = '<p>ç›®å‰æ²’æœ‰é–‹æ”¾çš„æè´ˆé …ç›®ã€‚</p>'; 
                return; 
            }

            grid.innerHTML = products.map(p => `
                <div class="donation-card" id="card-${p._id}">
                    <img src="${p.image || '/static/images/common/default_product.png'}" 
                         class="d-img" loading="lazy" 
                         onerror="this.src='/static/images/common/default_product.png'">
                    <div class="d-info">
                        <div class="d-title">${p.name}</div>
                        <div class="d-price">è­·æŒé‡‘ NT$ ${p.price}</div>
                        <div class="qty-control">
                            <button type="button" class="qty-btn" onclick="changeQty('${p._id}', -1)">-</button>
                            <span class="qty-display" id="qty-${p._id}">0</span>
                            <button type="button" class="qty-btn" onclick="changeQty('${p._id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch(e) { console.error('Load products failed', e); }
    }

    // æ•¸é‡è®Šæ›´é‚è¼¯
    window.changeQty = (id, delta) => {
        const p = products.find(x => x._id === id);
        if(!selectedItems[id]) selectedItems[id] = { id: p._id, name: p.name, price: p.price, qty: 0 };
        
        selectedItems[id].qty = Math.max(0, selectedItems[id].qty + delta);
        
        document.getElementById(`qty-${id}`).textContent = selectedItems[id].qty;
        const card = document.getElementById(`card-${id}`);
        card.classList.toggle('active', selectedItems[id].qty > 0);
        
        if(selectedItems[id].qty === 0) delete selectedItems[id];
        updateSummary();
    };

    // æ›´æ–°æ‘˜è¦è¡¨
    function updateSummary() {
        const items = Object.values(selectedItems);
        const section = document.getElementById('summary-section');
        
        if(items.length === 0) {
            section.classList.add('d-none');
            return;
        }
        
        section.classList.remove('d-none');
        document.getElementById('summary-body').innerHTML = items.map(item => 
            `<tr><td>${item.name}</td><td>${item.qty}</td><td>$${item.price * item.qty}</td></tr>`
        ).join('');
        
        const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
        document.getElementById('summary-total').textContent = total;
    }

    // è‡ªå‹•æ ¼å¼åŒ–èˆ‡é©—è­‰
    function setupFormatters() {
        const formatInput = (id, regex, replaceFn) => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                if(replaceFn) e.target.value = replaceFn(v);
                else e.target.value = v;
            });
        };

        // Phone formatter
        const phoneInput = document.getElementById('phone-input');
        phoneInput.addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g, '').slice(0, 10);
            if (v.length > 7) v = v.replace(/(\d{4})(\d{3})(\d{0,3})/, '$1-$2-$3');
            else if (v.length > 4) v = v.replace(/(\d{4})(\d{0,3})/, '$1-$2');
            e.target.value = v;
        });

        // Birthday input restrictions
        document.getElementById('birthday-input').addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, ''));
        document.getElementById('birthday-input').addEventListener('blur', e => {
            let v = e.target.value;
            if(v.length === 6) e.target.value = v.replace(/(\d{2})(\d{2})(\d{2})/, '$1/$2/$3');
            else if (v.length === 7) e.target.value = v.replace(/(\d{3})(\d{2})(\d{2})/, '$1/$2/$3');
        });
    }

    // é€å‡ºè¡¨å–®
    document.getElementById('donation-form').onsubmit = async (e) => {
        e.preventDefault();
        const items = Object.values(selectedItems);
        if (items.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è­·æŒé …ç›®');
        
        const f = e.target;
        if(!/^09\d{2}-\d{3}-\d{3}$/.test(f.phone.value)) return alert('é›»è©±æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªç‚º 09XX-XXX-XXX');
        if(f.lunarBirthday.value && !/^\d{2,3}\/\d{2}\/\d{2}$/.test(f.lunarBirthday.value)) return alert('ç”Ÿæ—¥æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ°‘åœ‹å¹´æ•¸å­— (å¦‚ 750821 æˆ– 1120101)');

        const payload = {
            orderType: 'donation',
            name: f.name.value,
            phone: f.phone.value,
            email: f.email.value,
            address: f.address.value,
            lunarBirthday: f.lunarBirthday.value,
            prayer: '', 
            last5: f.last5.value,
            items: items,
            total: parseInt(document.getElementById('summary-total').textContent)
        };

        const btn = f.querySelector('button[type="submit"]');
        const originalBtnText = btn.textContent;
        btn.disabled = true; btn.textContent = "è™•ç†ä¸­...";

        try {
            const res = await fetch('/api/orders', {
                method:'POST',
                headers:{'Content-Type':'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content},
                body: JSON.stringify(payload)
            });
            
            if (res.status === 401) {
                alert('æ‚¨çš„ç™»å…¥æ™‚æ•ˆå·²éï¼Œè«‹é‡æ–°ç™»å…¥ LINE');
                window.location.href = '/api/line/login?next=' + encodeURIComponent('/donation?action=donate');
                return;
            }

            const result = await res.json();
            if(result.success) {
                document.getElementById('success-modal').classList.remove('d-none');
            } else {
                throw new Error('API returned failure');
            }
        } catch(err) {
            console.error(err);
            alert('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦');
            btn.disabled = false;
            btn.textContent = originalBtnText;
        }
    };

    // èŠ³åéŒ„
    function loadMarquee() {
        fetch('/api/donations/public').then(r=>r.json()).then(data => {
            const list = document.getElementById('honor-list');
            if(!data.length) { list.innerHTML='<div class="text-center">å°šç„¡ç´€éŒ„</div>'; return; }
            const html = data.map(d => `<div class="donor-item"><span>${d.name}</span><span>${d.items}</span></div>`).join('');
            list.innerHTML = html + html; 
        }).catch(e => console.error(e));
    }
</script>
{% endblock %}
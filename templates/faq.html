{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å¸¸è¦‹å•é¡Œ{% endblock %}

{% block content %}
<main style="max-width: 860px; margin: 0 auto; padding: 54px 20px 36px 20px;">

  <div style="text-align: center;">
    <h2 class="section-title">å¸¸è¦‹å•é¡Œ</h2>
    
    <div class="search-container" style="margin-bottom: 20px;">
        <input type="text" id="faqSearch" class="faq-search-input" placeholder="ğŸ” æœå°‹å•é¡Œé—œéµå­—..." style="width: 100%; max-width: 400px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div id="faq-category-btns" style="margin-bottom: 34px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
        </div>
  </div>
  
  <div id="faq-list" class="faq-list">
      <p style="text-align:center;">è¼‰å…¥ä¸­...</p>
  </div>

</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const faqListDiv = document.getElementById('faq-list');
    const faqCategoryBtnsDiv = document.getElementById('faq-category-btns');
    const searchInput = document.getElementById('faqSearch');
    
    let currentFaqCategory = '';
    let allFaqsData = []; // ç”¨ä¾†å„²å­˜ç›®å‰åˆ†é¡ä¸‹çš„æ‰€æœ‰è³‡æ–™ï¼Œä¾›æœå°‹éæ¿¾ä½¿ç”¨

    // 1. å–å¾—åˆ†é¡
    async function fetchFaqCategories() {
        try {
            const res = await fetch('/api/faq/categories');
            if (!res.ok) throw new Error('ç„¡æ³•å–å¾—åˆ†é¡');
            const categories = await res.json();
            renderFaqCategoryBtns(categories);
        } catch (error) {
            console.error(error);
            faqCategoryBtnsDiv.innerHTML = `<p style="text-align:center; color: red;">åˆ†é¡è¼‰å…¥å¤±æ•—</p>`;
        }
    }

    // 2. æ¸²æŸ“åˆ†é¡æŒ‰éˆ•
    function renderFaqCategoryBtns(categories) {
        const baseClasses = 'btn btn--brown'; // è«‹ç¢ºä¿ä½ çš„ CSS æœ‰é€™å€‹ class
        // "å…¨éƒ¨" æŒ‰éˆ•
        let html = `<button class="${baseClasses}${currentFaqCategory === '' ? ' active' : ''}" data-category="">å…¨éƒ¨</button>`;
        
        // å…¶ä»–åˆ†é¡æŒ‰éˆ•
        categories.forEach(cat => {
            html += `<button class="${baseClasses}${cat === currentFaqCategory ? ' active' : ''}" data-category="${cat}">${cat}</button>`;
        });

        faqCategoryBtnsDiv.innerHTML = html;

        // ç¶å®šé»æ“Šäº‹ä»¶
        faqCategoryBtnsDiv.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼
                faqCategoryBtnsDiv.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // æ›´æ–°ç•¶å‰åˆ†é¡ä¸¦é‡æ–°æŠ“å–
                currentFaqCategory = btn.dataset.category;
                searchInput.value = ''; // åˆ‡æ›åˆ†é¡æ™‚æ¸…ç©ºæœå°‹æ¡†
                fetchFaqs(); 
            });
        });
    }

    // 3. å–å¾— FAQ è³‡æ–™
    async function fetchFaqs() {
        let url = '/api/faq';
        if (currentFaqCategory) url += '?category=' + encodeURIComponent(currentFaqCategory);
        
        faqListDiv.innerHTML = `<p style="text-align:center;">è¼‰å…¥ä¸­...</p>`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('ç„¡æ³•å–å¾—å•ç­”');
            allFaqsData = await res.json(); // å°‡è³‡æ–™å­˜å…¥å…¨åŸŸè®Šæ•¸
            
            renderFaqs(allFaqsData); // åˆå§‹æ¸²æŸ“å…¨éƒ¨

        } catch (error) {
            console.error(error);
            faqListDiv.innerHTML = `<p style="text-align:center; color: red;">å•ç­”è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>`;
        }
    }

    // 4. æ¸²æŸ“ FAQ åˆ—è¡¨ (åŒ…å«æœå°‹éæ¿¾é‚è¼¯)
    function renderFaqs(data) {
        if (!Array.isArray(data) || data.length === 0) {
            faqListDiv.innerHTML = `<div id="no-result-msg" style="text-align: center; color: #666; margin-top: 20px;">ç›®å‰æ²’æœ‰æ­¤åˆ†é¡çš„å•ç­”ã€‚</div>`;
            return;
        }

        // ç”¢ç”Ÿ HTML
        const html = data.map(faq => `
            <div class="faq-item-card">
                <div class="faq-q">Qï¼š${faq.question}</div>
                <div class="faq-a">Aï¼š${faq.answer}</div>
            </div>
        `).join('');
        
        faqListDiv.innerHTML = html;
    }

    // 5. æœå°‹åŠŸèƒ½ç›£è½
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            
            // å¾ allFaqsData ä¸­éæ¿¾ç¬¦åˆæ¨™é¡Œæˆ–å…§å®¹çš„é …ç›®
            const filteredData = allFaqsData.filter(faq => {
                const q = faq.question ? faq.question.toLowerCase() : '';
                const a = faq.answer ? faq.answer.toLowerCase() : '';
                return q.includes(searchTerm) || a.includes(searchTerm);
            });

            // é‡æ–°æ¸²æŸ“éæ¿¾å¾Œçš„çµæœ
            if (filteredData.length > 0) {
                renderFaqs(filteredData);
            } else {
                faqListDiv.innerHTML = `<div id="no-result-msg" style="text-align: center; color: #666; margin-top: 20px;">æŸ¥ç„¡ç›¸é—œå•é¡Œï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—ã€‚</div>`;
            }
        });
    }

    // åˆå§‹åŒ–
    fetchFaqCategories();
    fetchFaqs();
});
</script>

<style>
/* ç°¡å–®è£œå¼·ä¸€äº›æ¨£å¼ï¼Œç¢ºä¿æŒ‰éˆ•æœ‰å›é¥‹æ„Ÿ */
.btn--brown {
    padding: 8px 16px;
    border: 1px solid #8b5a2b;
    background-color: white;
    color: #8b5a2b;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
}
.btn--brown:hover, .btn--brown.active {
    background-color: #8b5a2b;
    color: white;
}
.faq-item-card {
    background: #fff;
    border: 1px solid #eee;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.faq-q {
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}
.faq-a {
    color: #555;
    white-space: pre-line; /* è®“æ›è¡Œç¬¦è™Ÿæ­£å¸¸é¡¯ç¤º */
}
</style>
{% endblock %}
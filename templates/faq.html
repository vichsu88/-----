{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å¸¸è¦‹å•é¡Œ{% endblock %}

{% block content %}
<main style="max-width: 860px; margin: 0 auto; padding: 54px 20px 36px 20px;">

  <div style="text-align: center;">
    <h2 class="section-title">å¸¸è¦‹å•é¡Œ</h2>
    
    <div class="search-container" style="margin-bottom: 20px;">
        <input type="text" id="faqSearch" placeholder="ğŸ” æœå°‹å•é¡Œé—œéµå­—..." 
               style="width: 100%; max-width: 500px; padding: 10px 15px; 
                      border: 2px solid #E6BA67; border-radius: 50px; 
                      font-size: 18pt; outline: none; background-color: rgba(255,255,255,0.8);">
    </div>

    <div id="faq-category-btns" style="margin-bottom: 34px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
        </div>
  </div>
  
  <div id="faq-list" class="faq-list">
      <p style="text-align:center;">è¼‰å…¥ä¸­...</p>
  </div>

</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const faqListDiv = document.getElementById('faq-list');
    const faqCategoryBtnsDiv = document.getElementById('faq-category-btns');
    const searchInput = document.getElementById('faqSearch');
    
    let currentFaqCategory = '';
    let allFaqsData = []; // ç”¨ä¾†å„²å­˜ç›®å‰åˆ†é¡ä¸‹çš„æ‰€æœ‰è³‡æ–™

    // 1. å–å¾—åˆ†é¡ä¸¦ç”¢ç”ŸæŒ‰éˆ•
    async function fetchFaqCategories() {
        try {
            const res = await fetch('/api/faq/categories');
            if (!res.ok) throw new Error('ç„¡æ³•å–å¾—åˆ†é¡');
            const categories = await res.json();
            renderFaqCategoryBtns(categories);
        } catch (error) {
            console.error(error);
            // å¤±æ•—æ™‚è‡³å°‘é¡¯ç¤ºå…¨éƒ¨æŒ‰éˆ•
            renderFaqCategoryBtns([]);
        }
    }

    // 2. æ¸²æŸ“åˆ†é¡æŒ‰éˆ•
    function renderFaqCategoryBtns(categories) {
        // ä½¿ç”¨æ‚¨åŸæœ¬çš„ CSS classï¼Œä¸é¡å¤–è¦†å¯«æ¨£å¼
        const baseClasses = 'btn btn--brown'; 
        
        // "å…¨éƒ¨" æŒ‰éˆ•
        let html = `<button class="${baseClasses}" data-category="">å…¨éƒ¨</button>`;
        
        // å…¶ä»–åˆ†é¡æŒ‰éˆ•
        if(Array.isArray(categories)){
            categories.forEach(cat => {
                html += `<button class="${baseClasses}" data-category="${cat}">${cat}</button>`;
            });
        }

        faqCategoryBtnsDiv.innerHTML = html;

        // ç¶å®šé»æ“Šäº‹ä»¶
        faqCategoryBtnsDiv.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                // æ›´æ–°æŒ‰éˆ•å¤–è§€ (è‹¥åŸæœ¬ CSS æœ‰ :active æˆ–å…¶ä»–å°æ‡‰æ¨£å¼å¯åœ¨æ­¤åŠ å¼·ï¼Œé€™è£¡ä¸»è¦è™•ç†é‚è¼¯)
                // ç‚ºäº†è®“ä½¿ç”¨è€…çŸ¥é“ç•¶å‰é¸ä¸­ï¼Œæˆ‘å€‘å¯ä»¥ç°¡å–®åŠ ä¸Šä¸€é»é€æ˜åº¦è®ŠåŒ–æˆ–ä¾è³´åŸæœ¬çš„ active æ¨£å¼
                faqCategoryBtnsDiv.querySelectorAll('button').forEach(b => b.style.opacity = '1');
                btn.style.opacity = '0.8'; // ç°¡å–®çš„è¦–è¦ºå›é¥‹

                // æ›´æ–°ç•¶å‰åˆ†é¡ä¸¦é‡æ–°æŠ“å–
                currentFaqCategory = btn.dataset.category;
                searchInput.value = ''; // åˆ‡æ›åˆ†é¡æ™‚æ¸…ç©ºæœå°‹æ¡†
                fetchFaqs(); 
            });
        });
    }

    // 3. å–å¾— FAQ è³‡æ–™
    async function fetchFaqs() {
        let url = '/api/faq';
        if (currentFaqCategory) url += '?category=' + encodeURIComponent(currentFaqCategory);
        
        faqListDiv.innerHTML = `<p style="text-align:center;">è¼‰å…¥ä¸­...</p>`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('ç„¡æ³•å–å¾—å•ç­”');
            allFaqsData = await res.json(); // å°‡è³‡æ–™å­˜å…¥å…¨åŸŸè®Šæ•¸
            
            renderFaqs(allFaqsData); // åˆå§‹æ¸²æŸ“å…¨éƒ¨

        } catch (error) {
            console.error(error);
            faqListDiv.innerHTML = `<p style="text-align:center; color: red;">å•ç­”è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>`;
        }
    }

    // 4. æ¸²æŸ“ FAQ åˆ—è¡¨
    function renderFaqs(data) {
        if (!Array.isArray(data) || data.length === 0) {
            faqListDiv.innerHTML = `<div id="no-result-msg" style="text-align: center; color: #666; margin-top: 20px;">ç›®å‰æ²’æœ‰æ­¤åˆ†é¡çš„å•ç­”ã€‚</div>`;
            return;
        }

        const html = data.map(faq => `
            <div class="faq-item-card">
                <div class="faq-q">Qï¼š${faq.question}</div>
                <div class="faq-a">Aï¼š${faq.answer}</div>
            </div>
        `).join('');
        
        faqListDiv.innerHTML = html;
    }

    // 5. æœå°‹åŠŸèƒ½ç›£è½
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            
            // è‹¥æ²’æœ‰è³‡æ–™ï¼Œç›´æ¥è·³é
            if (!allFaqsData || allFaqsData.length === 0) return;

            // å¾ allFaqsData ä¸­éæ¿¾ç¬¦åˆæ¨™é¡Œæˆ–å…§å®¹çš„é …ç›®
            const filteredData = allFaqsData.filter(faq => {
                const q = faq.question ? faq.question.toLowerCase() : '';
                const a = faq.answer ? faq.answer.toLowerCase() : '';
                return q.includes(searchTerm) || a.includes(searchTerm);
            });

            // é‡æ–°æ¸²æŸ“éæ¿¾å¾Œçš„çµæœ
            if (filteredData.length > 0) {
                renderFaqs(filteredData);
            } else {
                faqListDiv.innerHTML = `<div id="no-result-msg" style="text-align: center; color: #666; margin-top: 20px;">æŸ¥ç„¡ç›¸é—œå•é¡Œï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—ã€‚</div>`;
            }
        });
    }

    // åˆå§‹åŒ–
    fetchFaqCategories();
    fetchFaqs();
});
</script>

<style>
/* ç§»é™¤åŸæœ¬è¦†è“‹ .btn--brown çš„æ¨£å¼ï¼Œ
   ç¢ºä¿æŒ‰éˆ•æ¢å¾©æˆå…¨ç«™çµ±ä¸€çš„è¨­è¨ˆã€‚
   
   åƒ…ä¿ç•™ FAQ å¡ç‰‡æœ¬èº«çš„æ¨£å¼
*/
.faq-item-card {
    background: #fff;
    border: 2px solid #E6BA67; /* é…åˆä¸»è‰²èª¿çš„é‡‘é‚Š */
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.faq-q {
    font-weight: bold;
    color: #C48945; /* é…åˆæ–‡å­—ä¸»è‰² */
    margin-bottom: 8px;
    font-size: 1.1em;
}
.faq-a {
    color: #333;
    line-height: 1.6;
    white-space: pre-line; /* è®“æ›è¡Œç¬¦è™Ÿæ­£å¸¸é¡¯ç¤º */
}
</style>
{% endblock %}
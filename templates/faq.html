{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å¸¸è¦‹å•é¡Œ{% endblock %}

{% block content %}
<main style="max-width: 860px; margin: 0 auto; padding: 54px 20px 36px 20px;">

  <div style="text-align: center;">
    <h2 class="section-title">å¸¸è¦‹å•é¡Œ</h2>
    
    <div class="search-container" style="margin-bottom: 20px;">
        <input type="text" id="faqSearch" placeholder="ğŸ” æœå°‹å•é¡Œé—œéµå­—..." 
               style="width: 100%; max-width: 500px; padding: 10px 15px; 
                      border: 2px solid #E6BA67; border-radius: 50px; 
                      font-size: 18pt; outline: none; background-color: rgba(255,255,255,0.8);">
    </div>

    <div id="faq-category-btns" style="margin-bottom: 34px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
        </div>
  </div>
  
  <div id="faq-list" class="faq-list">
      <p style="text-align:center;">è¼‰å…¥ä¸­...</p>
  </div>

</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const faqListDiv = document.getElementById('faq-list');
    const faqCategoryBtnsDiv = document.getElementById('faq-category-btns');
    const searchInput = document.getElementById('faqSearch');
    
    let currentFaqCategory = '';
    let allFaqsData = []; // ã€é—œéµã€‘é€™æ˜¯å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†è®“æœå°‹åŠŸèƒ½å­˜å–è³‡æ–™

    // 1. å–å¾—åˆ†é¡ä¸¦ç”¢ç”ŸæŒ‰éˆ•
    async function fetchFaqCategories() {
        try {
            const res = await fetch('/api/faq/categories');
            if (!res.ok) throw new Error('ç„¡æ³•å–å¾—åˆ†é¡');
            const categories = await res.json();
            renderFaqCategoryBtns(categories);
        } catch (error) {
            console.error(error);
            renderFaqCategoryBtns([]);
        }
    }

    // 2. æ¸²æŸ“åˆ†é¡æŒ‰éˆ• (ä½¿ç”¨æ‚¨åŸæœ¬çš„ btn--brown æ¨£å¼)
    function renderFaqCategoryBtns(categories) {
        const baseClasses = 'btn btn--brown'; 
        
        let html = `<button class="${baseClasses}" data-category="">å…¨éƒ¨</button>`;
        
        if(Array.isArray(categories)){
            categories.forEach(cat => {
                html += `<button class="${baseClasses}" data-category="${cat}">${cat}</button>`;
            });
        }

        faqCategoryBtnsDiv.innerHTML = html;

        // ç¶å®šé»æ“Šäº‹ä»¶
        faqCategoryBtnsDiv.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                // ç°¡å–®çš„è¦–è¦ºå›é¥‹ï¼šé‡ç½®æ‰€æœ‰æŒ‰éˆ•é€æ˜åº¦ï¼Œé¸ä¸­çš„ç¨å¾®è®Šæ·¡ä»¥ç¤ºå€åˆ¥
                faqCategoryBtnsDiv.querySelectorAll('button').forEach(b => b.style.opacity = '1');
                btn.style.opacity = '0.8';

                currentFaqCategory = btn.dataset.category;
                if(searchInput) searchInput.value = ''; // åˆ‡æ›åˆ†é¡æ™‚æ¸…ç©ºæœå°‹æ¡†
                fetchFaqs(); 
            });
        });
    }

    // 3. å–å¾— FAQ è³‡æ–™
    async function fetchFaqs() {
        let url = '/api/faq';
        if (currentFaqCategory) url += '?category=' + encodeURIComponent(currentFaqCategory);
        
        faqListDiv.innerHTML = `<p style="text-align:center;">è¼‰å…¥ä¸­...</p>`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('ç„¡æ³•å–å¾—å•ç­”');
            
            // ã€ä¿®æ­£é‡é»ã€‘é€™è£¡å¿…é ˆæ›´æ–°å…¨åŸŸè®Šæ•¸ allFaqsDataï¼Œæœå°‹åŠŸèƒ½æ‰æœƒæœ‰è³‡æ–™
            allFaqsData = await res.json(); 
            
            renderFaqs(allFaqsData); 

        } catch (error) {
            console.error(error);
            faqListDiv.innerHTML = `<p style="text-align:center; color: red;">å•ç­”è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>`;
        }
    }

    // 4. æ¸²æŸ“ FAQ åˆ—è¡¨
    function renderFaqs(data) {
        if (!Array.isArray(data) || data.length === 0) {
            faqListDiv.innerHTML = `<div id="no-result-msg" style="text-align: center; color: #666; margin-top: 20px;">ç›®å‰æ²’æœ‰æ­¤åˆ†é¡çš„å•ç­”æˆ–æŸ¥ç„¡çµæœã€‚</div>`;
            return;
        }

        const html = data.map(faq => `
            <div class="faq-item-card">
                <div class="faq-q">Qï¼š${faq.question}</div>
                <div class="faq-a">Aï¼š${faq.answer}</div>
            </div>
        `).join('');
        
        faqListDiv.innerHTML = html;
    }

    // 5. æœå°‹åŠŸèƒ½ç›£è½
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            
            // è‹¥é‚„æ²’è¼‰å…¥è³‡æ–™æˆ–è³‡æ–™æ˜¯ç©ºçš„ï¼Œç›´æ¥çµæŸ
            if (!allFaqsData || allFaqsData.length === 0) return;

            // è‹¥æœå°‹æ¡†æ¸…ç©ºï¼Œé¡¯ç¤ºå…¨éƒ¨ (ç›®å‰åˆ†é¡ä¸‹çš„å…¨éƒ¨)
            if (searchTerm === '') {
                 renderFaqs(allFaqsData);
                 return;
            }

            // éæ¿¾è³‡æ–™
            const filteredData = allFaqsData.filter(faq => {
                const q = String(faq.question || '').toLowerCase();
                const a = String(faq.answer || '').toLowerCase();
                return q.includes(searchTerm) || a.includes(searchTerm);
            });

            renderFaqs(filteredData);
        });
    }

    // åˆå§‹åŒ–
    fetchFaqCategories();
    fetchFaqs();
});
</script>

<style>
/* åƒ…å®šç¾©å¡ç‰‡æ¨£å¼ï¼Œä¸è¦†è“‹ btn æ¨£å¼ 
   é€™æ¨£æŒ‰éˆ•å°±æœƒä½¿ç”¨ style.css ä¸­çš„å…¨åŸŸè¨­å®š
*/
.faq-item-card {
    background: #fff;
    border: 2px solid #E6BA67; /* é‡‘é‚Š */
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.faq-q {
    font-weight: bold;
    color: #C48945; 
    margin-bottom: 8px;
    font-size: 1.1em;
}
.faq-a {
    color: #333;
    line-height: 1.6;
    white-space: pre-line;
}
</style>
{% endblock %}
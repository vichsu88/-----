{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å»ºå»ŸåŸºé‡‘{% endblock %}

{% block content %}
<style>
    /* === å…±ç”¨è¨­å®š === */
    .fund-page-wrapper {
        background-color: #F3F0EC;
        font-family: 'Noto Sans TC', sans-serif;
    }
    .section-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 60px 20px;
        text-align: center;
    }
    .section-title-fund {
        font-size: 2.5rem;
        color: #C48945;
        margin-bottom: 20px;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    /* === ç¬¬ä¸€å€ï¼šHero & åœ“é¤…åœ– === */
    .fund-hero {
        position: relative;
        height: 90vh;
        min-height: 600px;
        /* è«‹æ›´æ›ç‚ºæ‚¨çš„å»ºå»ŸèƒŒæ™¯åœ– */
        background: url('{{ url_for("static", filename="images/pages/index/banner.png") }}') no-repeat center center/cover;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: #fff;
    }
    .fund-hero::before {
        content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.6); /* é»‘è‰²é®ç½©è®“åœ–è¡¨çªå‡º */
    }
    
    /* åœ“é¤…åœ–å‹•ç•« */
    .chart-container {
        position: relative;
        z-index: 2;
        width: 280px;
        height: 280px;
        border-radius: 50%;
        background: #eee;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 0 30px rgba(196, 137, 69, 0.5);
        margin-bottom: 30px;
    }
    .chart-inner {
        width: 240px;
        height: 240px;
        background: #fff; /* ä¸­é–“æŒ–ç©º */
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #333;
    }
    .chart-percent { font-size: 3rem; font-weight: bold; color: #C48945; }
    .chart-label { font-size: 1rem; color: #666; }
    .hero-text { position: relative; z-index: 2; margin-top: 20px; }
    .hero-text h1 { font-size: clamp(2rem, 5vw, 3.5rem); margin: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .hero-text p { font-size: 1.2rem; margin-top: 10px; opacity: 0.9; }

    /* === ç¬¬äºŒå€ï¼šYouTube å½±ç‰‡ === */
    .video-wrapper {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 æ¯”ä¾‹ */
        height: 0;
        overflow: hidden;
        max-width: 900px;
        margin: 0 auto;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .video-wrapper iframe {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    }

    /* === ç¬¬ä¸‰å€ï¼šæ•…äº‹åœ–ç‰‡ç‰† === */
    .story-container {
        display: flex;
        flex-direction: column;
        gap: 0; /* åœ–ç‰‡ç·Šå¯†é€£æ¥ï¼Œæˆ–è¨­ç‚º 20px */
        max-width: 900px;
        margin: 0 auto;
    }
    .story-img {
        width: 100%;
        height: auto;
        display: block;
        /* é è¨­æ¨£å¼ï¼Œæ‚¨ä¹‹å¾Œä¸Šå‚³åœ–ç‰‡æœƒè‡ªå‹•æ’é–‹ */
    }

    /* === ç¬¬å››å€ï¼šææ¬¾ CTA === */
    .donation-section {
        background: #fff;
        border-top: 5px solid #C48945;
        padding: 80px 20px;
    }
    .donation-options {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 40px;
    }
    .donate-card {
        border: 2px solid #E6BA67;
        border-radius: 15px;
        padding: 20px;
        width: 280px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        background: #fff;
        position: relative;
    }
    .donate-card:hover, .donate-card.selected {
        background: #C48945;
        color: #fff;
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(196, 137, 69, 0.3);
    }
    .donate-card h3 { margin: 10px 0; font-size: 1.5rem; }
    .donate-card .price { font-size: 1.8rem; font-weight: bold; margin-bottom: 15px; }
    .qty-control {
        display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px;
    }
    .qty-btn { width: 30px; height: 30px; border-radius: 50%; border: none; background: #eee; color: #333; cursor: pointer; font-weight: bold; }
    .donate-card.selected .qty-btn { background: #fff; color: #C48945; }
    .qty-display { width: 40px; text-align: center; font-size: 1.2rem; }

    /* Modal è¡¨å–® */
    .modal-overlay {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background: #fff; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px;
        max-height: 90vh; overflow-y: auto; position: relative; border: 3px solid #C48945;
    }
    .modal-header { font-size: 1.5rem; font-weight: bold; color: #C48945; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .emotional-text {
        background: #fdf6e9; padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.6; color: #555; margin-bottom: 20px; border-left: 4px solid #C48945;
    }
    .form-row { display: flex; gap: 15px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 200px; margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    .summary-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
    .summary-table td { padding: 8px; border-bottom: 1px solid #eee; }
    
    .btn-action {
        width: 100%; padding: 15px; font-size: 18px; font-weight: bold; color: #fff;
        background: #C48945; border: none; border-radius: 50px; cursor: pointer; margin-top: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .btn-action:disabled { background: #ccc; cursor: not-allowed; }
</style>

<div class="fund-page-wrapper">

    <div class="fund-hero">
        <div class="chart-container" id="fund-chart">
            <div class="chart-inner">
                <span class="chart-percent" id="percent-text">0%</span>
                <span class="chart-label">ç›®å‰é€²åº¦</span>
                <div style="margin-top:10px; font-size:14px;">
                    ç›®æ¨™ï¼š<span id="goal-text">loading...</span><br>
                    å·²å‹Ÿï¼š<span id="current-text">loading...</span>
                </div>
            </div>
        </div>
        <div class="hero-text">
            <h1>ä¸€ç£šä¸€ç“¦ï¼Œå…±å»ºè–æ®¿</h1>
            <p>æ‰¿å¤©ä¸­æ‰¿åºœ å»ºå»ŸåŸºé‡‘å‹Ÿé›†ä¸­</p>
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title-fund">å»ºå»Ÿç·£èµ·</h2>
        <div class="video-wrapper">
            <iframe src="https://youtube.com/shorts/pqMRa8OWBvM?si=txISjxLh9iDnOmue" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
    </div>

    <div class="section-container" style="background:#fff;">
        <h2 class="section-title-fund">æœªä¾†é¡˜æ™¯</h2>
        <div class="story-container">
            <img src="{{ url_for('static', filename='images/pages/incense/story1.jpg') }}" class="story-img" alt="é¡˜æ™¯åœ–1">
            <img src="{{ url_for('static', filename='images/pages/incense/story2.jpg') }}" class="story-img" alt="é¡˜æ™¯åœ–2">
            </div>
    </div>

    <div class="donation-section" id="donate">
        <div class="section-container" style="padding-top:0;">
            <h2 class="section-title-fund">ç«‹å³è­·æŒ</h2>
            <p style="margin-bottom:40px; font-size:1.2rem; color:#666;">æ‚¨çš„æ¯ä¸€ä»½å¿ƒæ„ï¼Œéƒ½å°‡åŒ–ä½œèŠåš´å»Ÿå®‡çš„ä¸€éƒ¨ä»½ã€‚</p>
            
            <div class="donation-options">
                <div class="donate-card" onclick="selectItem('suixi', 100)">
                    <h3>éš¨å–œåŠ©å»º</h3>
                    <div class="price">NT$ 100</div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty('suixi', -1); event.stopPropagation();">-</button>
                        <span class="qty-display" id="qty-suixi">0</span>
                        <button class="qty-btn" onclick="updateQty('suixi', 1); event.stopPropagation();">+</button>
                    </div>
                </div>
                <div class="donate-card" onclick="selectItem('tile', 600)">
                    <h3>å»ºå»Ÿç“¦ç‰‡</h3>
                    <div class="price">NT$ 600</div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty('tile', -1); event.stopPropagation();">-</button>
                        <span class="qty-display" id="qty-tile">0</span>
                        <button class="qty-btn" onclick="updateQty('tile', 1); event.stopPropagation();">+</button>
                    </div>
                </div>
                <div class="donate-card" onclick="selectItem('pillar', 10000)">
                    <h3>é¾æŸ±èªæ</h3>
                    <div class="price">NT$ 10,000</div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty('pillar', -1); event.stopPropagation();">-</button>
                        <span class="qty-display" id="qty-pillar">0</span>
                        <button class="qty-btn" onclick="updateQty('pillar', 1); event.stopPropagation();">+</button>
                    </div>
                </div>
            </div>

            <div style="text-align:center; font-size:1.5rem; font-weight:bold; margin-bottom:20px; color:#C48945;">
                ç¸½è­·æŒé‡‘é¡ï¼šNT$ <span id="total-amount">0</span>
            </div>
            
            <button class="btn-action" style="max-width:300px;" onclick="openFormModal()">å‰å¾€å¡«å¯«è³‡æ–™</button>
        </div>
    </div>

</div>

<div id="fund-form-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">å¡«å¯«è­·æŒè³‡æ–™</div>
        <div class="emotional-text">
            æ„Ÿæ©æ‚¨çš„ç™¼å¿ƒï¼<br>
            æ‚¨çš„ä¸€ç£šä¸€ç“¦ï¼Œæˆ‘å€‘éƒ½æœƒè©³ç´°è¨˜éŒ„ï¼Œä¸¦æ–¼æ¯æœˆåˆä¸€ã€åäº”å‘å…ƒå¸¥ç¨Ÿå¥ç–æ–‡ã€‚<br>
            æ‚¨çš„åŠŸå¾·å°‡æ°¸ç•™å¸¥åºœï¼Œåº‡ä½‘æ‚¨é–¤å®¶å¹³å®‰ã€‚
        </div>
        
        <form id="donation-form">
            <div class="form-row">
                <div class="form-group">
                    <label>çœŸå¯¦å§“å</label>
                    <input type="text" name="name" class="form-control" required placeholder="å°‡ç”¨æ–¼ç–æ–‡ç¨Ÿå¥">
                </div>
                <div class="form-group">
                    <label>è¾²æ›†ç”Ÿæ—¥ (YYYY/MM/DD)</label>
                    <input type="text" name="lunarBirthday" class="form-control" required placeholder="ä¾‹å¦‚: 1990/01/01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>è¯çµ¡é›»è©±</label>
                    <input type="tel" name="phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>é›»å­ä¿¡ç®± (æ¥æ”¶ç¢ºèªä¿¡)</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
            </div>
            <div class="form-group">
                <label>è¯çµ¡åœ°å€ (å¯„é€æ„Ÿè¬ç‹€/æ”¶æ“š)</label>
                <input type="text" name="address" class="form-control" required>
            </div>
            <div class="form-group">
                <label>åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                <input type="text" name="last5" class="form-control" maxlength="5" required placeholder="è«‹å¡«å¯«æ‚¨çš„å¸³è™Ÿå¾Œ5ç¢¼">
            </div>

            <button type="submit" class="btn-action">ä¸‹ä¸€æ­¥ï¼šç¢ºèªè³‡æ–™</button>
            <button type="button" class="btn-action" style="background:#ccc; margin-top:10px;" onclick="closeModal('fund-form-modal')">å–æ¶ˆ</button>
        </form>
    </div>
</div>

<div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">è«‹ç¢ºèªè­·æŒè³‡è¨Š</div>
        <table class="summary-table">
            <tr><td width="30%">å§“å</td><td id="conf-name"></td></tr>
            <tr><td>è¾²æ›†ç”Ÿæ—¥</td><td id="conf-birth"></td></tr>
            <tr><td>è­·æŒé …ç›®</td><td id="conf-items"></td></tr>
            <tr><td>ç¸½é‡‘é¡</td><td id="conf-total" style="color:#C48945; font-weight:bold;"></td></tr>
        </table>
        <p style="color:red; font-size:13px; text-align:center;">â€» è³‡æ–™é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹ï¼Œè«‹ç¢ºèªç„¡èª¤ã€‚</p>
        <button id="final-submit-btn" class="btn-action">ç¢ºèªé€å‡º</button>
        <button class="btn-action" style="background:#ccc; margin-top:10px;" onclick="backToEdit()">è¿”å›ä¿®æ”¹</button>
    </div>
</div>

<div id="success-modal" class="modal-overlay">
    <div class="modal-content" style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">ğŸ™</div>
        <h2 style="color:#C48945;">åŠŸå¾·ç„¡é‡</h2>
        <p>è³‡æ–™å·²æˆåŠŸé€å‡ºï¼Œæ„Ÿè¬æ‚¨çš„è­·æŒï¼</p>
        <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin:20px 0; text-align:left;">
            <p><strong>åŒ¯æ¬¾éŠ€è¡Œï¼š</strong>000 (ç¯„ä¾‹éŠ€è¡Œ)</p>
            <p><strong>åŒ¯æ¬¾å¸³è™Ÿï¼š</strong>1234-5678-9012</p>
            <p style="color:red; font-size:13px;">è«‹å‹™å¿…æ–¼ 2 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ã€‚</p>
        </div>
        <button class="btn-action" onclick="window.location.reload()">å®Œæˆ</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // === 1. åˆå§‹åŒ–åœ–è¡¨ ===
    try {
        const res = await fetch('/api/fund-settings');
        const data = await res.json();
        const goal = data.goal_amount || 10000000;
        const current = data.current_amount || 0;
        const percent = Math.min(Math.round((current / goal) * 100), 100);
        
        document.getElementById('goal-text').textContent = `$${goal.toLocaleString()}`;
        document.getElementById('current-text').textContent = `$${current.toLocaleString()}`;
        document.getElementById('percent-text').textContent = `${percent}%`;
        
        // CSS Conic Gradient å‹•ç•«
        const chart = document.getElementById('fund-chart');
        let p = 0;
        const interval = setInterval(() => {
            if(p >= percent) clearInterval(interval);
            chart.style.background = `conic-gradient(#C48945 0% ${p}%, #ddd ${p}% 100%)`;
            p++;
        }, 20); // å‹•ç•«é€Ÿåº¦
    } catch(e) {}

    // === 2. ææ¬¾é‚è¼¯ ===
    const items = {
        'suixi': { name: 'éš¨å–œåŠ©å»º', price: 100, qty: 0 },
        'tile': { name: 'å»ºå»Ÿç“¦ç‰‡', price: 600, qty: 0 },
        'pillar': { name: 'é¾æŸ±èªæ', price: 10000, qty: 0 }
    };

    window.updateQty = (key, change) => {
        items[key].qty = Math.max(0, items[key].qty + change);
        document.getElementById(`qty-${key}`).innerText = items[key].qty;
        
        // è¦–è¦ºé¸å–æ•ˆæœ
        const card = document.querySelector(`.donate-card[onclick*="${key}"]`);
        if(items[key].qty > 0) card.classList.add('selected');
        else card.classList.remove('selected');
        
        calcTotal();
    };

    window.selectItem = (key) => {
        // é»æ“Šå¡ç‰‡æœ¬èº«ä¹Ÿå¯ä»¥+1 (é«”é©—å„ªåŒ–)
        // ä½†å¦‚æœæŒ‰åˆ° +/- æŒ‰éˆ•æœƒè¢« stopPropagation æ“‹ä½ï¼Œä¸æœƒè§¸ç™¼é€™å€‹
        // é€™è£¡æš«æ™‚ç•™ç©ºï¼Œæˆ–å¯è¨­è¨ˆæˆé»æ“Šå¡ç‰‡å°±é¸ 1
        if(items[key].qty === 0) updateQty(key, 1);
    };

    function calcTotal() {
        let total = 0;
        for(let key in items) total += items[key].price * items[key].qty;
        document.getElementById('total-amount').innerText = total.toLocaleString();
    }

    // === 3. è¡¨å–®æµç¨‹ ===
    const formModal = document.getElementById('fund-form-modal');
    const confirmModal = document.getElementById('confirm-modal');
    const successModal = document.getElementById('success-modal');
    const form = document.getElementById('donation-form');

    window.openFormModal = () => {
        const total = parseInt(document.getElementById('total-amount').innerText.replace(/,/g,''));
        if(total === 0) return alert('è«‹å…ˆé¸æ“‡è­·æŒé …ç›®');
        formModal.style.display = 'flex';
    };
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.backToEdit = () => { confirmModal.style.display = 'none'; formModal.style.display = 'flex'; };

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        // æ”¶é›†è³‡æ–™ä¸¦é¡¯ç¤ºç¢ºèª Modal
        document.getElementById('conf-name').innerText = form.name.value;
        document.getElementById('conf-birth').innerText = form.lunarBirthday.value;
        
        let itemsHtml = '';
        for(let key in items) {
            if(items[key].qty > 0) itemsHtml += `${items[key].name} x ${items[key].qty}<br>`;
        }
        document.getElementById('conf-items').innerHTML = itemsHtml;
        document.getElementById('conf-total').innerText = document.getElementById('total-amount').innerText;

        formModal.style.display = 'none';
        confirmModal.style.display = 'flex';
    });

    document.getElementById('final-submit-btn').onclick = async () => {
        const btn = document.getElementById('final-submit-btn');
        btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';

        // æ•´ç†å•†å“è³‡æ–™çµ¦å¾Œç«¯ API
        const orderItems = [];
        for(let key in items) {
            if(items[key].qty > 0) orderItems.push({
                name: `[å»ºå»Ÿ] ${items[key].name}`,
                price: items[key].price,
                qty: items[key].qty,
                id: key // ç°¡å–® ID
            });
        }

        const payload = {
            name: form.name.value,
            phone: form.phone.value,
            address: form.address.value,
            last5: form.last5.value,
            email: form.email.value,
            lunarBirthday: form.lunarBirthday.value, // æ–°å¢
            items: orderItems,
            total: parseInt(document.getElementById('total-amount').innerText.replace(/,/g,''))
        };

        try {
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            
            if(result.success) {
                confirmModal.style.display = 'none';
                successModal.style.display = 'flex';
            } else {
                alert('é€å‡ºå¤±æ•—');
                btn.disabled = false;
            }
        } catch(e) { alert('é€£ç·šéŒ¯èª¤'); btn.disabled = false; }
    };
});
</script>
{% endblock %}
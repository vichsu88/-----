{% extends "base.html" %}

{% block title %}æ‰¿å¤©ä¸­æ‰¿åºœ - å»ºå»ŸåŸºé‡‘{% endblock %}

{% block content %}
<style>
    /* === çš‡å®¶æ­£ç´…ï¼šæ ¸å¿ƒè®Šæ•¸è¨­å®š === */
    :root {
        --royal-bg-dark: #1a0505;
        --royal-bg-red: #4a0e0e;
        --royal-gold-light: #fcf6ba; /* äº®é‡‘ */
        --royal-gold-main: #bf953f;  /* é»ƒé‡‘ */
        --royal-gold-dark: #8a6e2f;  /* æš—é‡‘ */
        --royal-text-light: #fdfbf7;
        --glass-bg: rgba(40, 10, 10, 0.65);
        --glass-border: rgba(255, 215, 0, 0.3);
    }

    /* === å…¨å±€è¦†è“‹ (Scoped to this page) === */
    .fund-page-wrapper {
        background-color: var(--royal-bg-dark);
        /* èƒŒæ™¯ï¼šæ·±ç´…æ”¾å°„æ¼¸å±¤ï¼Œç‡Ÿé€ ç¥å£‡èšç„¦æ„Ÿ */
        background-image: radial-gradient(circle at 50% 20%, var(--royal-bg-red), var(--royal-bg-dark) 90%);
        font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
        color: var(--royal-text-light);
        min-height: 100vh;
        overflow-x: hidden;
    }

    .section-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 80px 20px;
        text-align: center;
        position: relative;
        z-index: 2;
    }

    /* é»ƒé‡‘æ–‡å­—ç‰¹æ•ˆ */
    .section-title-fund {
        font-size: 3rem;
        margin-bottom: 40px;
        font-weight: 900;
        letter-spacing: 2px;
        /* é‡‘å±¬æ¼¸å±¤æ–‡å­— */
        background: linear-gradient(to bottom, #fcf6ba 0%, #bf953f 40%, #b38728 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5));
        position: relative;
        display: inline-block;
    }
    /* æ¨™é¡Œå…©å´è£é£¾ç·š */
    .section-title-fund::after {
        content: ''; display: block; width: 60px; height: 3px;
        background: linear-gradient(90deg, transparent, var(--royal-gold-main), transparent);
        margin: 15px auto 0;
    }

    /* === ç¬¬ä¸€å€ï¼šHero & ç‡ƒç‡’é‡‘ç’° === */
    .fund-hero {
        position: relative;
        height: 90vh;
        min-height: 650px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.3), var(--royal-bg-dark)),
                    url('{{ url_for("static", filename="images/pages/index/fund_banner.png") }}') no-repeat center center/cover;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    /* ç™¼å…‰çš„åœ“é¤…åœ–å®¹å™¨ */
    .chart-container {
        position: relative;
        width: 300px;
        height: 300px;
        border-radius: 50%;
        box-shadow: 
            0 0 20px var(--royal-gold-dark),
            0 0 60px rgba(191, 149, 63, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 40px;
        animation: float 6s ease-in-out infinite;
    }

    /* å…§éƒ¨é®ç½© (å½¢æˆåœ“ç’°) */
    .chart-inner {
        width: 260px;
        height: 260px;
        background: radial-gradient(circle, #2b0808 0%, #000 100%);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: var(--royal-gold-light);
        box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        z-index: 2;
    }

    .chart-percent { 
        font-size: 3.5rem; 
        font-weight: bold; 
        background: linear-gradient(135deg, #fff 0%, #ffd700 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    .chart-label { font-size: 1.1rem; color: #aaa; letter-spacing: 1px; }
    
    .hero-text h1 { 
        font-size: clamp(2.2rem, 5vw, 4rem); 
        margin: 0; 
        color: #fff;
        text-shadow: 0 4px 15px rgba(0,0,0,0.8);
    }
    .hero-text p { 
        font-size: 1.3rem; 
        margin-top: 15px; 
        color: var(--royal-gold-light); 
        letter-spacing: 3px;
        text-shadow: 0 2px 5px rgba(0,0,0,0.8);
    }

    /* === ç¬¬äºŒå€ï¼šå½±ç‰‡å¤–æ¡† === */
    .video-wrapper {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        max-width: 900px;
        margin: 0 auto;
        border: 2px solid var(--royal-gold-dark);
        border-radius: 10px;
        box-shadow: 0 0 0 4px rgba(0,0,0,0.5), 0 10px 40px rgba(0,0,0,0.6);
    }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    /* === ç¬¬ä¸‰å€ï¼šé¡˜æ™¯ (é»‘é‡‘å¡ç‰‡) === */
    .vision-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 80px;
        text-align: left;
        padding: 20px 0;
    }
    .vision-item {
        display: flex;
        flex-direction: column;
        gap: 30px;
        background: linear-gradient(145deg, rgba(30, 10, 10, 0.8), rgba(10, 0, 0, 0.9));
        border: 1px solid rgba(191, 149, 63, 0.2);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        transition: transform 0.3s ease, border-color 0.3s ease;
    }
    .vision-item:hover {
        transform: translateY(-5px);
        border-color: var(--royal-gold-main);
        box-shadow: 0 15px 40px rgba(191, 149, 63, 0.15);
    }
    .vision-img-box {
        width: 100%; height: 300px; overflow: hidden; border-radius: 10px;
        border: 1px solid var(--royal-gold-dark);
    }
    .vision-img-box img {
        width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s ease;
    }
    .vision-item:hover .vision-img-box img { transform: scale(1.1); }
    .vision-content h3 {
        color: var(--royal-gold-main);
        font-size: 1.8rem;
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(191, 149, 63, 0.3);
        padding-bottom: 10px;
        display: inline-block;
    }
    .vision-content p { font-size: 1.1rem; line-height: 1.8; color: #ccc; text-align: justify; }

    @media (min-width: 768px) {
        .vision-item { flex-direction: row; align-items: center; }
        .vision-item:nth-child(even) { flex-direction: row-reverse; }
        .vision-img-box { flex: 1; height: 350px; }
        .vision-content { flex: 1; }
    }

    /* === ç¬¬å››å€ï¼šææ¬¾ === */
    .donation-section {
        background: transparent;
        padding: 80px 20px;
        position: relative;
        border-top: 1px solid rgba(191, 149, 63, 0.3);
    }
    
    /* è–æ—¨èŠ³åéŒ„ */
    .honor-roll-section {
        max-width: 900px;
        margin: 0 auto 60px auto;
        background-color: #8B0000;
        border: 4px solid var(--royal-gold-main);
        outline: 2px solid #8B0000;
        outline-offset: 4px;
        border-radius: 4px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        position: relative;
    }
    /* ä¿®æ­£ï¼šè–æ—¨æ²è»¸é ­ï¼ˆæ‰‹æ©Ÿéš±è—ï¼‰ */
    .honor-roll-section::before, .honor-roll-section::after {
        content: ''; position: absolute; width: 30px; height: 104%;
        background: linear-gradient(90deg, #5e0000, #b38728, #5e0000);
        top: -2%; border-radius: 5px; box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }
    .honor-roll-section::before { left: -15px; }
    .honor-roll-section::after { right: -15px; }

    .honor-title {
        font-size: 1.8rem; font-weight: bold; color: var(--royal-gold-light);
        text-align: center; margin-bottom: 20px;
        border-bottom: 1px dashed rgba(255, 215, 0, 0.4);
        padding-bottom: 15px;
    }
    .marquee-container { height: 180px; overflow: hidden; position: relative; mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent); }
    .donor-item {
        display: flex; justify-content: space-between; padding: 12px 10px;
        border-bottom: 1px dotted rgba(255,215,0,0.2);
        color: #ffebcd; font-size: 1.15rem;
    }

    /* æµç¨‹åœ– */
    .process-steps {
        display: flex; justify-content: space-between; align-items: flex-start;
        padding: 0; margin: 0 auto 60px auto; list-style: none; position: relative; max-width: 900px;
    }
    .process-steps::before {
        content: ''; position: absolute; top: 40px; left: 50px; right: 50px;
        height: 2px; background: rgba(191, 149, 63, 0.4); z-index: 0;
    }
    .step-item { flex: 1; text-align: center; position: relative; z-index: 1; padding: 0 10px; }
    .step-icon-box {
        width: 80px; height: 80px; margin: 0 auto 20px auto;
        background: radial-gradient(circle at 30% 30%, #751010, #000);
        border: 2px solid var(--royal-gold-main);
        border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 32px;
        box-shadow: 0 0 15px rgba(191, 149, 63, 0.2);
        transition: all 0.3s;
    }
    .step-item:hover .step-icon-box {
        background: var(--royal-gold-main); color: #fff;
        box-shadow: 0 0 25px var(--royal-gold-main); transform: scale(1.1);
    }
    .step-title { color: var(--royal-gold-main); font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 5px;}
    .step-desc { color: #aaa; font-size: 0.95rem; }

    /* ææ¬¾å¡ç‰‡ */
    .donation-options { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 50px; }
    .donate-card {
        background: rgba(30, 30, 30, 0.6);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 15px; padding: 30px 20px; width: 280px;
        text-align: center; cursor: pointer; transition: 0.4s;
    }
    .donate-card:hover, .donate-card.selected {
        background: linear-gradient(135deg, #8B0000 0%, #4a0000 100%);
        border-color: var(--royal-gold-main);
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,215,0,0.5);
    }
    .donate-card h3 { margin: 10px 0; font-size: 1.6rem; color: #fff; }
    .donate-card .price { font-size: 2rem; font-weight: bold; color: var(--royal-gold-main); margin-bottom: 20px; }
    .qty-control { display: flex; justify-content: center; align-items: center; gap: 15px; }
    .qty-btn {
        width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--royal-gold-dark);
        background: transparent; color: var(--royal-gold-main); cursor: pointer; font-size: 1.2rem;
    }
    .qty-btn:hover { background: var(--royal-gold-main); color: #000; }
    .qty-display { width: 40px; text-align: center; font-size: 1.4rem; color: #fff; }

    /* è¡Œå‹•æŒ‰éˆ• (CTA) */
    .btn-action {
        display: block; width: 100%; max-width: 350px; margin: 20px auto 0;
        padding: 18px; font-size: 1.2rem; font-weight: bold; color: #2b0808;
        background: linear-gradient(to bottom, #fcf6ba 0%, #bf953f 50%, #8a6e2f 100%);
        border: none; border-radius: 50px; cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        position: relative; overflow: hidden;
        animation: pulse-gold 2s infinite;
    }
    .btn-action:hover { background: linear-gradient(to bottom, #fff 0%, #ffd700 100%); transform: scale(1.02); }
    .btn-action::after {
        content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        transform: skewX(-20deg);
        animation: sheen 3s infinite;
    }

    /* === é‡è¦ä¿®æ­£ï¼šModal æ¨£å¼ (é è¨­éš±è—) === */
    .modal-overlay {
        display: none; /* [ä¿®æ­£é»] é è¨­å¿…é ˆæ˜¯ noneï¼Œå¦å‰‡æœƒç›´æ¥æ“‹ä½ç•«é¢ */
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); /* æ·±è‰²é®ç½© */
        backdrop-filter: blur(8px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: #fdfbf7; /* è¡¨å–®ä¿æŒæ·ºè‰²åº•ï¼Œæ–¹ä¾¿é–±è®€ */
        color: #333;
        width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
        border: 4px solid var(--royal-gold-main);
        border-radius: 15px; padding: 30px;
        box-shadow: 0 0 50px rgba(191, 149, 63, 0.3);
    }
    .modal-header { 
        font-size: 1.5rem; font-weight: bold; color: #8B0000; 
        margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px; 
    }
    .emotional-text { 
        background: #fff5e6; padding: 15px; border-radius: 8px; 
        font-size: 14px; line-height: 1.6; color: #555; margin-bottom: 20px; 
        border-left: 4px solid #8B0000; 
    }
    /* è¡¨å–®æ¬„ä½èˆ‡å…¶ä»–æ¨£å¼ (ç¹¼æ‰¿èˆŠè¨­å®šä½†å¾®èª¿) */
    .form-row { display: flex; gap: 15px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 200px; margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #333; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    .summary-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; color: #333; text-align: left; }
    .summary-table td { padding: 8px; border-bottom: 1px solid #eee; }

    /* å‹•ç•« Keyframes */
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(191, 149, 63, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(191, 149, 63, 0); } 100% { box-shadow: 0 0 0 0 rgba(191, 149, 63, 0); } }
    @keyframes sheen { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
    @keyframes scrollUp { 0% { transform: translateY(100%); } 100% { transform: translateY(-100%); } }

    @media (max-width: 768px) {
        .section-title-fund { font-size: 2.2rem; }
        .chart-container { width: 240px; height: 240px; }
        .chart-inner { width: 210px; height: 210px; }
        .process-steps { flex-direction: column; gap: 30px; align-items: center; max-width: 300px; }
        .process-steps::before { width: 2px; height: 100%; top: 0; left: 50%; transform: translateX(-50%); }
        .step-item { display: flex; flex-direction: column; align-items: center; background: transparent; padding: 0; }
        .honor-roll-section::before, .honor-roll-section::after { display: none; }
    }
</style>

<div class="fund-page-wrapper">

    <div class="fund-hero">
        <div class="chart-container" id="fund-chart">
            <div class="chart-inner">
                <span class="chart-percent" id="percent-text">0%</span>
                <span class="chart-label">ç›®å‰é€²åº¦</span>
                <div style="margin-top:10px; font-size:14px; opacity:0.8;">
                    ç›®æ¨™ï¼š<span id="goal-text">loading...</span><br>
                    å·²å‹Ÿï¼š<span id="current-text">loading...</span>
                </div>
            </div>
        </div>
        <div class="hero-text">
            <h1>ä¸€ç£šä¸€ç“¦ï¼Œå…±å»ºè–æ®¿</h1>
            <p>æ‰¿å¤©ä¸­æ‰¿åºœ å»ºå»ŸåŸºé‡‘å‹Ÿé›†ä¸­</p>
        </div>
        <div style="position:absolute; bottom:30px; animation: float 2s infinite;">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="var(--royal-gold-main)"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title-fund">å»ºå»Ÿç·£èµ·</h2>
        <div class="video-wrapper">
            <iframe src="https://www.youtube.com/embed/pqMRa8OWBvM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>        
        </div>
    </div>

    <div class="section-container">
        <h2 class="section-title-fund">æœªä¾†é¡˜æ™¯</h2>
        
        <div class="vision-grid">
            <div class="vision-item">
                <div class="vision-img-box">
                    <img src="{{ url_for('static', filename='images/pages/index/fund1.png') }}" alt="å»ºå»Ÿç·£èµ·-ç‹¹çª„ç©ºé–“">
                </div>
                <div class="vision-content">
                    <h3>ç·£èµ·ï¼šå°ç©ºé–“è£¡çš„å¤§æ…ˆæ‚²</h3>
                    <p>åå¹´ä¾†ï¼Œæ‰¿å¤©ä¸­æ‰¿åºœæ‰¿è’™å…ƒå¸¥ç¥å¨ï¼Œç‚ºç„¡æ•¸ä¿¡å¾’æ”¶é©šè§£æƒ‘ã€‚ç„¶è€Œï¼Œéš¨è‘—å–„ä¿¡æ—¥ç›Šå¢åŠ ï¼Œåƒ…æœ‰çš„ç©ºé–“å·²ä¸è¶³ä»¥å®¹ç´é€™ä»½æ—¥ç›Šå¢é•·çš„é¦™ç«èˆ‡æœŸå¾…ã€‚</p>
                </div>
            </div>
            
            <div class="vision-item">
                <div class="vision-img-box">
                    <img src="{{ url_for('static', filename='images/pages/index/fund2.png') }}" alt="è²¬ä»»èˆ‡æŒ‘æˆ°">
                </div>
                <div class="vision-content">
                    <h3>è²¬ä»»ï¼šæˆ‘å€‘éœ€è¦ä¸€å€‹æ›´ç©©å®šçš„å®¶</h3>
                    <p>çœ‹è¦‹ä¿¡å¾’åœ¨çƒˆæ—¥ä¸‹ç­‰å¾…æ”¶é©šçš„æ±—æ°´ï¼Œçœ‹è¦‹æ³•æœƒæ™‚å¤§å®¶æ“ åœ¨ç‹¹çª„éé“çš„è™”èª ã€‚å»ºå»Ÿï¼Œå·²æ˜¯åˆ»ä¸å®¹ç·©çš„ä½¿å‘½ã€‚</p>
                </div>
            </div>

            <div class="vision-item">
                <div class="vision-img-box">
                    <img src="{{ url_for('static', filename='images/pages/index/fund3.png') }}" alt="æœªä¾†è—åœ–">
                </div>
                <div class="vision-content">
                    <h3>è—åœ–ï¼šä¸åªæ˜¯ä¸€åº§å»Ÿ</h3>
                    <p>æœªä¾†çš„å¸¥åºœï¼Œå°‡ä¸å†åªæ˜¯ä¸€åº§å»ºç¯‰ã€‚å®ƒå°‡æ˜¯èŠåš´æ®¿å ‚ï¼Œè®“å–„ä¿¡èˆ’é©åƒæ‹œï¼›å®ƒæ˜¯æ–‡åŒ–åŸºåœ°ï¼Œå‚³æ‰¿ä¿¡ä»°ã€‚</p>
                </div>
            </div>

            <div class="vision-item">
                <div class="vision-img-box">
                    <img src="{{ url_for('static', filename='images/pages/index/fund4.png') }}" alt="é‚€è«‹èˆ‡è¡Œå‹•">
                </div>
                <div class="vision-content">
                    <h3>é‚€è«‹ï¼šè¬ä¸ˆé«˜æ¨“ï¼Œèµ·æ–¼æ‚¨çš„ä¸€ä»½å¿ƒæ„</h3>
                    <p>å»ºå»Ÿå¤§æ¥­ï¼Œéä¸€äººä¹‹åŠ›å¯æˆã€‚æ‚¨æç»çš„ä¸€ç£šä¸€ç“¦ï¼Œéƒ½å°‡åˆ»ç•«åœ¨æ­·å²ä¸­ã€‚èª æ‘¯é‚€è«‹æ‚¨ï¼Œæˆç‚ºå»ºå»ŸåŠŸå¾·ä¸»ï¼Œç‚ºè‡ªå·±èˆ‡å®¶äººï¼Œç¨®ä¸‹è¬ä¸–æµèŠ³çš„ç¦ç”°ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div class="donation-section" id="donate">
        <div class="section-container" style="padding-top:0;">
            
            <div class="honor-roll-section">
                <div class="honor-title">æè´ˆèŠ³åéŒ„</div>
                <div class="marquee-container">
                    <div class="marquee-content" id="honor-list">
                        <div style="padding:10px; text-align:center;">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <h2 class="section-title-fund">ç«‹å³è­·æŒ</h2>
            <p style="margin-bottom:50px; font-size:1.3rem; color: #ccc;">æ‚¨çš„æ¯ä¸€ä»½å¿ƒæ„ï¼Œéƒ½å°‡åŒ–ä½œèŠåš´å»Ÿå®‡çš„ä¸€éƒ¨ä»½ã€‚</p>
            
            <ol class="process-steps">
                <li class="step-item">
                    <div class="step-icon-box" title="é¸æ“‡é …ç›®">ğŸ™</div>
                    <div class="step-text">
                        <span class="step-title">Step 1ï¼šé¸æ“‡é …ç›®</span>
                        <span class="step-desc">æŒ‘é¸æ‚¨æ¬²è­·æŒçš„ç£šç“¦æˆ–é¾æŸ±ã€‚</span>
                    </div>
                </li>
                <li class="step-item">
                    <div class="step-icon-box" title="å¡«å¯«ç–æ–‡">âœï¸</div>
                    <div class="step-text">
                        <span class="step-title">Step 2ï¼šå¡«å¯«ç–æ–‡</span>
                        <span class="step-desc">ç¢ºèªç”¨æ–¼ç¨Ÿå¥çš„å§“åèˆ‡ç”Ÿè¾°ã€‚</span>
                    </div>
                </li>
                <li class="step-item">
                    <div class="step-icon-box" title="å®ŒæˆåŒ¯æ¬¾">ğŸ’°</div>
                    <div class="step-text">
                        <span class="step-title">Step 3ï¼šå®ŒæˆåŒ¯æ¬¾</span>
                        <span class="step-desc">é€å‡ºå¾Œè«‹æ–¼ 2 å°æ™‚å…§åŒ¯æ¬¾å®Œæˆã€‚</span>
                    </div>
                </li>
                <li class="step-item">
                    <div class="step-icon-box" title="åŠŸå¾·åœ“æ»¿">ğŸ’®</div>
                    <div class="step-text">
                        <span class="step-title">Step 4ï¼šåŠŸå¾·åœ“æ»¿</span>
                        <span class="step-desc">ç¢ºèªæ¬¾é …å¾Œå°‡åˆ—å…¥èŠ³åéŒ„ä¸¦ç¨Ÿå¥å…ƒå¸¥ã€‚</span>
                    </div>
                </li>
            </ol>

            <div class="donation-options">
                <div class="donate-card" onclick="selectItem('suixi', 100)">
                    <h3>éš¨å–œåŠ©å»º</h3>
                    <div class="price">NT$ 100</div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty('suixi', -1); event.stopPropagation();">-</button>
                        <span class="qty-display" id="qty-suixi">0</span>
                        <button class="qty-btn" onclick="updateQty('suixi', 1); event.stopPropagation();">+</button>
                    </div>
                </div>
                <div class="donate-card" onclick="selectItem('tile', 600)">
                    <h3>å»ºå»Ÿç“¦ç‰‡</h3>
                    <div class="price">NT$ 600</div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty('tile', -1); event.stopPropagation();">-</button>
                        <span class="qty-display" id="qty-tile">0</span>
                        <button class="qty-btn" onclick="updateQty('tile', 1); event.stopPropagation();">+</button>
                    </div>
                </div>
                <div class="donate-card" onclick="selectItem('pillar', 10000)">
                    <h3>é¾æŸ±èªæ</h3>
                    <div class="price">NT$ 10,000</div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty('pillar', -1); event.stopPropagation();">-</button>
                        <span class="qty-display" id="qty-pillar">0</span>
                        <button class="qty-btn" onclick="updateQty('pillar', 1); event.stopPropagation();">+</button>
                    </div>
                </div>
            </div>

            <div style="text-align:center; font-size:1.8rem; font-weight:bold; margin-bottom:20px; color:var(--royal-gold-main); text-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                ç¸½è­·æŒé‡‘é¡ï¼šNT$ <span id="total-amount">0</span>
            </div>
            
            <button class="btn-action" onclick="openFormModal()">å‰å¾€å¡«å¯«è³‡æ–™</button>
        </div>
    </div>

</div>

<div id="fund-form-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">å¡«å¯«è­·æŒè³‡æ–™</div>
        <div class="emotional-text">
            æ„Ÿæ©æ‚¨çš„ç™¼å¿ƒï¼<br>
            æ‚¨çš„ä¸€ç£šä¸€ç“¦ï¼Œæˆ‘å€‘éƒ½æœƒè©³ç´°è¨˜éŒ„ï¼Œå‘å…ƒå¸¥ç¨Ÿå¥ç–æ–‡ã€‚<br>
            æ‚¨çš„åŠŸå¾·å°‡æ°¸ç•™å¸¥åºœï¼Œåº‡ä½‘æ‚¨é–¤å®¶å¹³å®‰ã€‚
        </div>
        
        <form id="donation-form">
            <div class="form-row">
                <div class="form-group">
                    <label>çœŸå¯¦å§“å</label>
                    <input type="text" name="name" class="form-control" required placeholder="å°‡ç”¨æ–¼ç–æ–‡ç¨Ÿå¥">
                </div>
                <div class="form-group">
                    <label>è¾²æ›†ç”Ÿæ—¥ (YYYY/MM/DD)</label>
                    <input type="text" name="lunarBirthday" class="form-control" required placeholder="ä¾‹å¦‚: 1990/01/01" maxlength="10" data-mask="date">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>è¯çµ¡é›»è©±</label>
                    <input type="tel" name="phone" class="form-control" required placeholder="09xx-xxx-xxx" maxlength="12" data-mask="phone">
                </div>
                <div class="form-group">
                    <label>é›»å­ä¿¡ç®± (æ¥æ”¶ç¢ºèªä¿¡)</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
            </div>
            <div class="form-group">
                <label>è¯çµ¡åœ°å€</label>
                <input type="text" name="address" class="form-control" required>
            </div>
            <div class="form-group">
                <label>åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                <input type="text" name="last5" class="form-control" maxlength="5" required placeholder="è«‹å¡«å¯«æ‚¨çš„å¸³è™Ÿå¾Œ5ç¢¼">
            </div>

            <button type="submit" class="btn-action" style="margin-top:20px; box-shadow:none;">ä¸‹ä¸€æ­¥ï¼šç¢ºèªè³‡æ–™</button>
            <button type="button" class="btn-action" style="background:#ccc; margin-top:10px; box-shadow:none; color:#333; animation:none;" onclick="closeModal('fund-form-modal')">å–æ¶ˆ</button>
        </form>
    </div>
</div>

<div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">è«‹ç¢ºèªè­·æŒè³‡è¨Š</div>
        <table class="summary-table">
            <tr><td width="30%">å§“å</td><td id="conf-name"></td></tr>
            <tr><td>è¾²æ›†ç”Ÿæ—¥</td><td id="conf-birth"></td></tr>
            <tr><td>è¯çµ¡é›»è©±</td><td id="conf-phone"></td></tr>
            <tr><td>è­·æŒé …ç›®</td><td id="conf-items"></td></tr>
            <tr><td>ç¸½é‡‘é¡</td><td id="conf-total" style="color:#C48945; font-weight:bold;"></td></tr>
        </table>
        <p style="color:red; font-size:13px; text-align:center;">â€» è³‡æ–™é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹ï¼Œè«‹ç¢ºèªç„¡èª¤ã€‚</p>
        <button id="final-submit-btn" class="btn-action" style="box-shadow:none;">ç¢ºèªé€å‡º</button>
        <button class="btn-action" style="background:#ccc; margin-top:10px; box-shadow:none; color:#333; animation:none;" onclick="backToEdit()">è¿”å›ä¿®æ”¹</button>
    </div>
</div>

<div id="success-modal" class="modal-overlay">
    <div class="modal-content" style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">ğŸ™</div>
        <h2 style="color:#C48945;">åŠŸå¾·ç„¡é‡</h2>
        <p>è³‡æ–™å·²æˆåŠŸé€å‡ºï¼Œæ„Ÿè¬æ‚¨çš„è­·æŒï¼</p>
        <div style="background:#e3f2fd; padding:15px; border-radius:8px; margin:20px 0; text-align:left;">
            <p><strong>åŒ¯æ¬¾éŠ€è¡Œï¼š</strong>103 æ–°å…‰éŠ€è¡Œ(åŒ—å˜‰ç¾©)</p>
            <p><strong>åŒ¯æ¬¾å¸³è™Ÿï¼š</strong>æ›¾å‡¡ç¦ 0666509711333</p>
            <p style="color:red; font-size:13px;">è«‹å‹™å¿…æ–¼ 2 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ã€‚</p>
        </div>
        <button class="btn-action" onclick="window.location.reload()">å®Œæˆ</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // === 1. åˆå§‹åŒ–åœ–è¡¨ (ä¿®æ”¹ç‚ºé‡‘è‰²å…‰ç’°) ===
    try {
        const res = await fetch('/api/fund-settings');
        const data = await res.json();
        const goal = data.goal_amount || 10000000;
        const current = data.current_amount || 0;
        const percent = Math.min(Math.round((current / goal) * 100), 100);
        
        document.getElementById('goal-text').textContent = `$${goal.toLocaleString()}`;
        document.getElementById('current-text').textContent = `$${current.toLocaleString()}`;
        document.getElementById('percent-text').textContent = `${percent}%`;
        
        const chart = document.getElementById('fund-chart');
        let p = 0;
        const interval = setInterval(() => {
            if(p >= percent) clearInterval(interval);
            chart.style.background = `conic-gradient(
                #ffd700 0%, 
                #bf953f ${p}%, 
                rgba(255,255,255,0.1) ${p}% 100%
            )`;
            p++;
        }, 20);
    } catch(e) {}

    // === 2. è¼‰å…¥èŠ³åéŒ„ ===
    loadMarquee();
    function loadMarquee() {
        fetch('/api/donations/public').then(r=>r.json()).then(data => {
            const list = document.getElementById('honor-list');
            if(!data.length) { list.innerHTML='<div style="text-align:center; color:#ffd700; padding-top:20px;">å°šç„¡ç´€éŒ„</div>'; return; }
            
            const html = data.map(d => `<div class="donor-item"><span>${d.name}</span><span>${d.items}</span></div>`).join('');
            list.innerHTML = html + html; 
            
            const content = list.innerHTML;
            list.innerHTML = `<div style="animation: scrollUp ${Math.max(10, data.length * 3)}s linear infinite">${content}</div>`;
        }).catch(err => console.log('Honor list error', err));
    }

// === 3. è¼¸å…¥å„ªåŒ– (Input Mask) - V3 å®Œç¾ä¿®æ­£ç‰ˆ ===
    const dateInput = document.querySelector('input[data-mask="date"]');
    const phoneInput = document.querySelector('input[data-mask="phone"]');

    function setupMask(input, formatLogic) {
        if (!input) return;
        
        // æ ¸å¿ƒè™•ç†å‡½å¼
        const processInput = (isComposing) => {
            // [é˜²è·³é‡ 1] å¦‚æœæ­£åœ¨é¸å­— (isComposing=true)ï¼Œçµ•å°ä¸è¦ä¿®æ”¹å€¼ï¼Œé¿å… 0 è®Š 00
            if (isComposing) return;

            const originalValue = input.value;
            let v = originalValue.replace(/\D/g, ''); // å–å‡ºç´”æ•¸å­—

            // åŸ·è¡Œæ ¼å¼åŒ–
            const formattedValue = formatLogic(v);

            // [é˜²è·³é‡ 2] åªæœ‰ç•¶ã€Œç®—å‡ºä¾†çš„æ ¼å¼ã€è·Ÿã€Œç¾åœ¨çš„å€¼ã€ä¸ä¸€æ¨£æ™‚ï¼Œæ‰æ›´æ–°
            // é€™èƒ½é¿å…æ¸¸æ¨™äº‚è·³ï¼Œä¹Ÿèƒ½è§£æ±ºåˆªé™¤æ™‚å¡ä½çš„å•é¡Œ
            if (originalValue !== formattedValue) {
                input.value = formattedValue;
            }
        };

        // ç›£è½è¼¸å…¥äº‹ä»¶
        input.addEventListener('input', (e) => {
            processInput(e.isComposing); 
        });
        
        // [é—œéµä¿®æ­£] ç›£è½ã€Œé¸å­—çµæŸã€äº‹ä»¶
        // æ‰‹æ©Ÿè¼¸å…¥æ³•æ‰“å®Œæ•¸å­—å¾Œï¼Œæœƒè§¸ç™¼é€™å€‹äº‹ä»¶ï¼Œé€™æ™‚æˆ‘å€‘å¼·åˆ¶è£œä¸Šæ–œç·š
        input.addEventListener('compositionend', () => {
            processInput(false); // å¼·åˆ¶å®£å‘Šã€Œé¸å­—å·²çµæŸã€ï¼Œè«‹ç«‹å³æ ¼å¼åŒ–
        });
    }

    // æ—¥æœŸæ ¼å¼åŒ–é‚è¼¯ (YYYY/MM/DD)
    setupMask(dateInput, (v) => {
        if (v.length > 8) v = v.slice(0, 8);
        if (v.length > 4) v = v.slice(0, 4) + '/' + v.slice(4);
        if (v.length > 7) v = v.slice(0, 7) + '/' + v.slice(7);
        return v;
    });

    // é›»è©±æ ¼å¼åŒ–é‚è¼¯ (09xx-xxx-xxx)
    setupMask(phoneInput, (v) => {
        if (v.length > 10) v = v.slice(0, 10);
        if (v.length > 4) v = v.slice(0, 4) + '-' + v.slice(4);
        if (v.length > 8) v = v.slice(0, 8) + '-' + v.slice(8);
        return v;
    });

    // === 4. ææ¬¾é‚è¼¯ ===
    const items = {
        'suixi': { name: 'éš¨å–œåŠ©å»º', price: 100, qty: 0 },
        'tile': { name: 'å»ºå»Ÿç“¦ç‰‡', price: 600, qty: 0 },
        'pillar': { name: 'é¾æŸ±èªæ', price: 10000, qty: 0 }
    };

    window.updateQty = (key, change) => {
        items[key].qty = Math.max(0, items[key].qty + change);
        document.getElementById(`qty-${key}`).innerText = items[key].qty;
        
        const card = document.querySelector(`.donate-card[onclick*="${key}"]`);
        if(items[key].qty > 0) card.classList.add('selected');
        else card.classList.remove('selected');
        
        calcTotal();
    };

    window.selectItem = (key) => {
        if(items[key].qty === 0) updateQty(key, 1);
    };

    function calcTotal() {
        let total = 0;
        for(let key in items) total += items[key].price * items[key].qty;
        document.getElementById('total-amount').innerText = total.toLocaleString();
    }

    // === 5. è¡¨å–®æµç¨‹ (JS ç¶­æŒä¸è®Šï¼Œå› ç‚º CSS ä¿®å¥½äº†) ===
    const formModal = document.getElementById('fund-form-modal');
    const confirmModal = document.getElementById('confirm-modal');
    const successModal = document.getElementById('success-modal');
    const form = document.getElementById('donation-form');

    window.openFormModal = () => {
        const total = parseInt(document.getElementById('total-amount').innerText.replace(/,/g,''));
        if(total === 0) return alert('è«‹å…ˆé¸æ“‡è­·æŒé …ç›®');
        formModal.style.display = 'flex';
    };
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.backToEdit = () => { confirmModal.style.display = 'none'; formModal.style.display = 'flex'; };

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        document.getElementById('conf-name').innerText = form.name.value;
        document.getElementById('conf-birth').innerText = form.lunarBirthday.value;
        document.getElementById('conf-phone').innerText = form.phone.value;
        
        let itemsHtml = '';
        for(let key in items) {
            if(items[key].qty > 0) itemsHtml += `${items[key].name} x ${items[key].qty}<br>`;
        }
        document.getElementById('conf-items').innerHTML = itemsHtml;
        document.getElementById('conf-total').innerText = document.getElementById('total-amount').innerText;

        formModal.style.display = 'none';
        confirmModal.style.display = 'flex';
    });

    document.getElementById('final-submit-btn').onclick = async () => {
        const btn = document.getElementById('final-submit-btn');
        btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';

        const orderItems = [];
        for(let key in items) {
            if(items[key].qty > 0) orderItems.push({
                name: `[å»ºå»Ÿ] ${items[key].name}`,
                price: items[key].price,
                qty: items[key].qty,
                id: key
            });
        }

        const payload = {
            orderType: 'fund',
            name: form.name.value,
            phone: form.phone.value,
            address: form.address.value,
            last5: form.last5.value,
            email: form.email.value,
            lunarBirthday: form.lunarBirthday.value,
            items: orderItems,
            total: parseInt(document.getElementById('total-amount').innerText.replace(/,/g,''))
        };

        try {
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]') ? document.querySelector('meta[name="csrf-token"]').getAttribute('content') : ''
                },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            
            if(result.success) {
                confirmModal.style.display = 'none';
                successModal.style.display = 'flex';
            } else {
                alert('é€å‡ºå¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                btn.disabled = false; btn.innerText = 'ç¢ºèªé€å‡º';
            }
        } catch(e) { alert('é€£ç·šéŒ¯èª¤'); btn.disabled = false; btn.innerText = 'ç¢ºèªé€å‡º'; }
    };
});
</script>
{% endblock %}